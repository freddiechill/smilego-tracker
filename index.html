<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS PWA (Ana Ekrana Ekle) Destek Etiketleri -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SmileGO Tracker">
    
    <title>SmileGO Tracker</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/trackerlogo.png">

    <script src="https://cdn.median.co/median.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400,300&display=swap" rel="stylesheet">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "2657219b-d29e-46e1-ac6f-68d2cdb8014d" });
      });
    </script>

    <style>
        :root { --bg-dark: #09090b; --nav-dark: #101012; --primary: #818cf8; --sent-bg: #4f46e5; --recv-bg: #27272a; }
        body { background-color: var(--bg-dark); font-family: 'Satoshi', sans-serif; color: #fff; height: 100vh; overflow: hidden; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        button, a, input, select, textarea, .card-custom, .nav-btn, .clickable { cursor: pointer; pointer-events: auto !important; }

        .modal { z-index: 1000005 !important; }
        .modal-backdrop { z-index: 1000004 !important; }
        #modal-confirm { z-index: 1000020 !important; } 
        
        .app-header { height: 70px; position: fixed; top: 0; left: 0; width: 100%; background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; z-index: 9999; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-icon-btn { background: transparent !important; border: none !important; padding: 0 8px !important; color: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .bottom-nav { height: 85px; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(16, 16, 18, 0.98); border-top: 1px solid #27272a; z-index: 9999; display: flex; align-items: center; justify-content: space-around; padding-bottom: 15px; }
        .main-content { position: fixed; top: 70px; bottom: 85px; width: 100%; overflow-y: auto; padding: 20px; display: none; z-index: 1; }
        .main-content.active { display: block; animation: fadeIn 0.3s ease; }

        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .card-custom { background: #18181b; border: 1px solid #27272a; border-radius: 20px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition:0.2s; position: relative; }
        .card-custom:active { background: #202023; }
        .form-control, .form-select { background: #27272a; border: 1px solid #3f3f46; color: white; padding: 12px; border-radius: 12px; font-size: 14px; }
        .btn-primary-soft { background: var(--primary); color: #000; font-weight: 700; border-radius: 14px; border: none; padding: 14px; width: 100%; }

        .btn-ai { background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); color: #fbbf24; border-radius: 12px; font-weight: 600; padding: 8px 16px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.1); }
        .btn-ai:hover { background: rgba(251, 191, 36, 0.2); transform: translateY(-1px); }
        .btn-ai:active { transform: translateY(1px); }
        ::-webkit-resizer { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10"><path d="M10 0 L10 10 L0 10 Z" fill="%23818cf8"/></svg>'); background-repeat: no-repeat; background-position: bottom right; }

        .dropdown-toggle::after { display: none; } 

        .dropdown-menu { background: rgba(24, 24, 27, 0.8) !important; backdrop-filter: blur(20px) !important; -webkit-backdrop-filter: blur(20px) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; border-radius: 16px !important; padding: 8px !important; box-shadow: 0 15px 35px rgba(0,0,0,0.5) !important; }
        .dropdown-item { color: #e2e8f0 !important; border-radius: 10px !important; padding: 10px 15px !important; transition: all 0.2s !important; margin-bottom: 2px; }
        .dropdown-item:last-child { margin-bottom: 0; }
        .dropdown-item:hover, .dropdown-item:focus { background: rgba(129, 140, 248, 0.15) !important; color: #fff !important; }
        .dropdown-item.active { background: rgba(129, 140, 248, 0.25) !important; color: var(--primary) !important; font-weight: 700; }

        #chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: none; flex-direction: column; }
        #chat-overlay.open { display: flex; }
        
        .pinned-msg-bar { background: rgba(30, 30, 35, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid #3f3f46; padding: 10px 20px; font-size: 13px; display: none; align-items: center; justify-content: space-between; cursor: pointer; z-index: 10; border-left: 3px solid var(--primary); }
        .reply-preview-bar { background: #1c1c1e; border-top: 1px solid #3f3f46; border-left: 3px solid var(--primary); padding: 10px 15px; font-size: 13px; display: none; align-items: center; justify-content: space-between; }
        .replied-to-block { background: rgba(0,0,0,0.2); border-left: 3px solid var(--primary); padding: 6px 10px; border-radius: 6px; margin-bottom: 6px; font-size: 12px; opacity: 0.8; cursor: pointer; display: flex; flex-direction: column; }
        
        .chat-body-scroll { flex: 1 1 auto; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 6px; background: #0b0b0d; scroll-behavior: smooth; }
        .chat-row { display: flex; width: 100%; align-items: flex-start; gap: 8px; margin-bottom: 2px; transition: background 0.3s; border-radius: 8px; }
        .chat-row.right { justify-content: flex-end; }
        .chat-row.left { justify-content: flex-start; }
        .chat-row.highlight { background: rgba(129, 140, 248, 0.3) !important; transition: background 0.5s; }
        .chat-avatar-img { width: 35px; height: 35px; border-radius: 50% !important; object-fit: cover !important; flex-shrink: 0; } 
        .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 14.5px; position: relative; word-wrap: break-word; user-select: none; display: flex; flex-direction: column; }
        .bubble-sent { background: var(--sent-bg); color: #fff; border-top-right-radius: 2px; margin-left: auto; }
        .bubble-received { background: var(--recv-bg); color: #fff; border-top-left-radius: 2px; margin-right: auto; }
        .msg-bubble a { color: #93c5fd; text-decoration: underline; word-break: break-all; }
        
        .msg-bubble ul, .msg-bubble ol, #notepad-preview ul, #notepad-preview ol { margin-bottom: 0; padding-left: 20px; }
        .msg-bubble b, #notepad-preview b { font-weight: 800; }
        .msg-bubble i, #notepad-preview i { font-style: italic; }
        .msg-bubble s, #notepad-preview s { text-decoration: line-through; opacity: 0.8; }

        .sender-header { margin-bottom: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; line-height: 1.2; }
        .sender-name { font-weight: 800; font-size: 13px; }
        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; cursor: zoom-in; }
        .chat-meta { font-size: 9px; opacity: 0.6; text-align: right; margin-top: 2px; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
        .edited-label { font-style: italic; }
        .reaction-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: -2px; margin-bottom: 6px; position: relative; z-index: 2; }
        .reaction-pill { background: #222; border: 1px solid #444; border-radius: 10px; padding: 1px 6px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .chat-badge { font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: 600; display: inline-block; }
        .cb-role { background: #3f3f46; color: #ddd; }
        .cb-dept { border: 1px solid #52525b; color: #a1a1aa; background: transparent; }

        .unread-dot { width: 10px; height: 10px; background-color: var(--primary); border-radius: 50%; box-shadow: 0 0 8px var(--primary); }

        .day-container { display: flex; flex-direction: column; gap: 6px; position: relative; }
        .date-separator { position: sticky; top: 10px; z-index: 5; text-align: center; margin: 10px 0 5px 0; display: flex; justify-content: center; pointer-events: none; }
        .date-separator-badge { background: rgba(30, 30, 35, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.08); color: #e2e8f0; font-size: 11px; padding: 4px 14px; border-radius: 12px; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.4); pointer-events: auto; }

        #mention-menu { position: absolute; bottom: 100%; left: 70px; width: calc(100% - 130px); background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(10px); border: 1px solid #3f3f46; border-radius: 12px 12px 0 0; max-height: 200px; overflow-y: auto; display: none; z-index: 10001; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .mention-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .mention-item:hover { background: rgba(129, 140, 248, 0.2); }
        .mention-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; }
        .mention-title { font-size: 14px; font-weight: 600; color: #fff; }
        .mention-sub { font-size: 10px; color: #a1a1aa; }

        #star-select { display: flex; gap: 2px; align-items: center; }
        #star-select i { font-size: 24px; cursor: pointer; width: 24px; text-align: center; }
        
        .task-right-panel { position: absolute; top: 12px; right: 12px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; width: 110px; pointer-events: none; text-align: right; }
        .task-icons { display: flex; gap: 8px; pointer-events: auto; margin-bottom: 2px; justify-content: flex-end; }
        .task-icons i { cursor: pointer; }
        .task-card-content { margin-right: 115px; }
        .filter-scroll-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .filter-btn { flex: 0 0 auto; min-width: auto; padding: 6px 16px; border-radius: 50px; font-size: 12px; }

        .dept-header { color: var(--primary); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 20px; margin-bottom: 10px; padding-left: 5px; border-left: 3px solid var(--primary); }
        .dept-group { background: rgba(255,255,255,0.02); border-radius: 16px; padding: 5px; border: 1px solid #27272a; margin-bottom: 10px; }
        .rounded-circle { border-radius: 50% !important; aspect-ratio: 1 / 1; object-fit: cover !important; }
        .role-badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #333; color: #ccc; border: 1px solid #444; }
        .dept-group > div:last-child, #td-status-list > div:last-child, #notif-list > div:last-child, #lb-list > div:last-child { border-bottom: none !important; margin-bottom: 0 !important; }
        .search-list { max-height: 200px; overflow-y: auto; background: #202023; border: 1px solid #333; border-radius: 0 0 12px 12px; display: none; position: absolute; width: 100%; z-index: 1000; }
        .search-list div { padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2d; font-size: 13px; }
        .search-list div:hover { background: var(--primary); color: black; }

        .progress-ring { width: 60px; height: 60px; }
        .progress-ring__bg { stroke: rgba(255,255,255,0.1); }
        .progress-ring__circle { transition: 0.35s stroke-dashoffset; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .st-pending { background: rgba(255,255,255,0.1); color: #aaa; }
        .st-progress { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        .lb-tabs { display: flex; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .lb-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: bold; color: rgba(0,0,0,0.5); background: var(--bs-warning); transition: 0.2s; }
        .lb-tab.active { color: #000; border-bottom: 3px solid #000; }

        #app-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-250px); background: rgba(30, 30, 35, 0.95); border: 1px solid #444; backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000008; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; min-width: 300px; justify-content: center; }
        #app-toast.show { transform: translateX(-50%) translateY(0); }
        
        #context-menu { position: fixed; background: #1c1c1e; border: 1px solid #333; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.9); display: none; flex-direction: column; min-width: 200px; overflow: hidden; z-index: 2000006; }
        .ctx-reactions { display: flex; padding: 10px; gap: 5px; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: #252529; }
        .ctx-emoji { font-size: 20px; cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 50%; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; gap: 10px; transition:0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .ctx-item:active { background: #333; }
        .ctx-item.delete { color: #ff6b6b; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000007; display: none; align-items: center; justify-content: center; flex-direction: column; }

        #img-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000000; display: none; align-items: center; justify-content: center; touch-action: none; overflow: hidden; }
        #img-viewer-src { max-width: 100%; max-height: 100%; transition: transform 0.1s; transform-origin: center center; }
        
        .nav-btn { background: none; border: none; color: #52525b; flex: 1; height: 100%; font-size: 24px; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); }

        textarea#chat-input::-webkit-scrollbar { width: 4px; }
        textarea#chat-input::-webkit-scrollbar-track { background: transparent; }
        textarea#chat-input::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="app-toast"><i class="fas fa-info-circle text-primary fs-5"></i><span id="toast-msg" class="fw-bold small">...</span></div>
    <div class="modal fade" id="modal-confirm" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-4 text-center"><i class="fas fa-question-circle text-warning fa-3x mb-3"></i><h5 class="fw-bold mb-2">Emin misiniz?</h5><p class="text-muted small mb-4" id="confirm-text">...</p><div class="d-flex gap-2 justify-content-center"><button class="btn btn-dark border-secondary w-50" data-bs-dismiss="modal">ƒ∞ptal</button><button class="btn btn-danger w-50" id="confirm-btn-yes">Evet</button></div></div></div></div>
    <div id="context-menu"><div class="ctx-reactions"><span class="ctx-emoji" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="ctx-emoji" onclick="addReaction('üëç')">üëç</span><span class="ctx-emoji" onclick="addReaction('üëé')">üëé</span><span class="ctx-emoji" onclick="addReaction('üôè')">üôè</span><span class="ctx-emoji" onclick="addReaction('‚úçÔ∏è')">‚úçÔ∏è</span><span class="ctx-emoji" onclick="addReaction('‚úÖ')">‚úÖ</span></div><div id="ctx-options"></div></div>
    <div id="loading-overlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div><div class="text-white mt-3 fw-bold" id="loading-text">Y√ºkleniyor...</div></div>
    
    <div id="img-viewer">
        <button style="position:absolute;top:40px;right:20px;background:rgba(0,0,0,0.5);border-radius:50%;width:40px;height:40px;border:none;color:white;font-size:20px;z-index:2000001" onclick="closeImgViewer()"><i class="fas fa-times"></i></button>
        <img id="img-viewer-src" src="" alt="Zoomable Image">
    </div>

    <div id="auth-screen" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div id="auth-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at top right, #312e81 0%, #09090b 60%);z-index:-1"></div>
        <div class="glass-card">
            <div class="text-center mb-4"><img src="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/smilegologotracker.png" alt="SmileGO" style="width: 170px;"></div>
            <ul class="nav nav-pills nav-fill mb-4 bg-dark rounded p-1" style="border: 1px solid #333"><li class="nav-item"><a class="nav-link active rounded" data-bs-toggle="pill" href="#tab-login">Giri≈ü</a></li><li class="nav-item"><a class="nav-link rounded" data-bs-toggle="pill" href="#tab-register">Kayƒ±t</a></li></ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-login"><form id="form-login"><input type="email" id="l-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="l-pass" class="form-control mb-4" placeholder="≈ûifre" required><button class="btn-primary-soft">Giri≈ü Yap</button></form></div>
                <div class="tab-pane fade" id="tab-register"><form id="form-register"><input id="r-name" class="form-control mb-3" placeholder="Ad Soyad" required><input id="r-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="r-pass" class="form-control mb-3" placeholder="≈ûifre (min 6)" required><div class="text-muted small mb-2">Departman ve Rol Admin tarafƒ±ndan atanacaktƒ±r.</div><button class="btn-primary-soft">Kayƒ±t Ol</button></form></div>
            </div>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <header class="app-header">
            <h5 class="m-0 fw-bold" id="page-title">G√∂rev Panosu</h5>
            <div class="d-flex gap-2 align-items-center">
                <button class="header-icon-btn" onclick="openNotepad()"><i class="fas fa-sticky-note text-info"></i></button>
                <button class="header-icon-btn" onclick="openLeaderboard()"><i class="fas fa-trophy text-warning"></i></button>
                <div class="position-relative"><button class="header-icon-btn" onclick="openNotifs()"><i class="fas fa-bell"></i></button><div id="notif-dot" class="notif-dot" style="position:absolute;top:5px;right:5px;width:8px;height:8px;background:red;border-radius:50%;display:none;border:1px solid #000"></div></div>
            </div>
        </header>

        <div id="view-tasks" class="main-content active">
            <button id="btn-add-task" class="btn-primary-soft mb-4 shadow-sm" onclick="openTaskModal()"><i class="fas fa-plus me-2"></i> Yeni G√∂rev Ekle</button>
            <div class="d-flex align-items-center mb-3">
                <div class="dropdown me-2">
                    <button class="btn btn-dark border-secondary rounded-circle dropdown-toggle text-warning flex-shrink-0" type="button" data-bs-toggle="dropdown" style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-sort-amount-down"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark shadow border-secondary" style="font-size: 14px;">
                        <li><a class="dropdown-item active" href="#" onclick="changeTaskSort('newest', this); event.preventDefault();">Yeniden Eskiye</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeTaskSort('oldest', this); event.preventDefault();">Eskiden Yeniye</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeTaskSort('importance', this); event.preventDefault();">√ñneme G√∂re</a></li>
                    </ul>
                </div>
                
                <div class="dropdown me-2" id="admin-dept-filter-wrapper" style="display: none;">
                    <button class="btn btn-dark border-secondary rounded-circle dropdown-toggle text-info flex-shrink-0" type="button" data-bs-toggle="dropdown" style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Departmana G√∂re Filtrele">
                        <i class="fas fa-filter"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark shadow border-secondary" style="font-size: 14px;" id="admin-dept-filter-menu">
                    </ul>
                </div>

                <div class="filter-scroll-container flex-grow-1" style="padding-bottom: 0;">
                    <button class="btn btn-outline-secondary rounded-pill filter-btn active" onclick="filterTasks('all', this)">T√ºm√º</button>
                    <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('week', this)">Bu Hafta</button>
                    <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('pending', this)">Ba≈ülamadƒ±</button>
                    <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('progress', this)">Yapƒ±lƒ±yor</button>
                    <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('done', this)">Bitti</button>
                </div>
            </div>
            <div id="task-list" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="view-messages" class="main-content"><h6 class="text-muted small fw-bold mb-3 ls-1">GRUPLAR</h6><div id="channel-list" class="d-flex flex-column gap-2 mb-4"></div><h6 class="text-muted small fw-bold mb-3 ls-1">√ñZEL MESAJLAR</h6><div id="dm-list" class="d-flex flex-column gap-2"></div></div>
        <div id="view-team" class="main-content"><input type="text" class="form-control mb-4" placeholder="Ekipte ara (ƒ∞sim, Rol, Dept)..." onkeyup="renderTeam(this.value)"><div id="team-list"></div></div>
        
        <div id="view-profile" class="main-content">
            <div class="text-center">
                <div class="mb-3 position-relative d-inline-block">
                    <img id="prof-img" src="" class="rounded-circle border border-2 border-secondary p-1" style="width:110px; height:110px;">
                    <label for="file-inp" class="position-absolute bottom-0 end-0 bg-white text-dark rounded-circle d-flex align-items-center justify-content-center shadow" style="width:35px;height:35px;cursor:pointer"><i class="fas fa-camera small"></i></label>
                    <input type="file" id="file-inp" class="d-none" accept="image/*" onchange="uploadPhoto(this)">
                </div>
                <div class="d-flex align-items-center justify-content-center gap-2 mb-1"><h4 id="prof-name" class="fw-bold m-0">...</h4><i class="fas fa-pen text-secondary clickable" onclick="editMyName()"></i></div>
                <div id="prof-roles" class="d-flex justify-content-center flex-wrap gap-2 mb-2"></div>
                
                <div id="prof-external-id" class="badge bg-dark border border-secondary text-muted mb-3 clickable" onclick="copyText(this.dataset.uid, 'Kullanƒ±cƒ± ID')" title="Kopyalamak i√ßin tƒ±kla" style="font-family: monospace; font-size: 9px; padding: 2px 6px; font-weight: normal; opacity: 0.8;"></div>
                
                <button class="btn btn-sm btn-outline-warning w-100 mb-3" onclick="enableWebPush()"><i class="fas fa-bell me-1"></i> Web Bildirimlerini A√ß (iOS/PC)</button>

                <div class="card-custom p-3 mt-1 d-flex align-items-center justify-content-between">
                    <div class="text-start"><div class="text-muted small">G√∂rev Ba≈üarƒ±mƒ±</div><h4 class="fw-bold m-0" id="prof-rate">0%</h4></div>
                    <svg class="progress-ring" width="60" height="60"><circle class="progress-ring__bg" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"/><circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="prof-circle" stroke-dasharray="163.36" stroke-dashoffset="163.36"/></svg>
                </div>
            </div>
             <div class="card-custom mt-3">
                <h6 class="fw-bold text-muted mb-3">Kƒ∞≈ûƒ∞SEL Bƒ∞LGƒ∞LER</h6>
                <div class="mb-3 position-relative"><label class="small text-muted">√úniversite</label><input type="text" class="form-control" id="inp-uni" placeholder="√úniversite Ara..." onkeyup="filterSearch('uni')"><div class="search-list" id="list-uni"></div></div>
                <div class="mb-3 position-relative"><label class="small text-muted">B√∂l√ºm</label><input type="text" class="form-control" id="inp-sec" placeholder="B√∂l√ºm Ara..." onkeyup="filterSearch('sec')"><div class="search-list" id="list-sec"></div></div>
                <div class="row"><div class="col-6 mb-3"><label class="small text-muted">ƒ∞l</label><input type="text" class="form-control" id="inp-city" placeholder="ƒ∞l"></div><div class="col-6 mb-3"><label class="small text-muted">ƒ∞l√ße</label><input type="text" class="form-control" id="inp-dist" placeholder="ƒ∞l√ße"></div></div>
                <div class="mb-3"><label class="small text-muted">Doƒüum Tarihi</label><input type="date" class="form-control" id="inp-dob"></div>
                <div class="mb-3"><label class="small text-muted">Telefon</label><input type="tel" class="form-control" id="inp-phone" placeholder="0555..."></div>
                <div class="mb-3"><label class="small text-muted">E-Posta</label><input type="email" class="form-control" id="inp-email" placeholder="iletisim@..."></div>
                <button class="btn btn-sm btn-success w-100" onclick="saveEduInfo()">Bilgileri Kaydet</button>
             </div>
             <div class="card-custom mt-2">
                <h6 class="fw-bold text-muted mb-3">SOSYAL MEDYA</h6>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-linkedin"></i></span><input id="sm-linkedin" class="form-control" placeholder="LinkedIn"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-instagram"></i></span><input id="sm-instagram" class="form-control" placeholder="Instagram"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-twitter"></i></span><input id="sm-x" class="form-control" placeholder="X (Twitter)"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-tiktok"></i></span><input id="sm-tiktok" class="form-control" placeholder="TikTok"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-youtube"></i></span><input id="sm-youtube" class="form-control" placeholder="YouTube"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-kickstarter"></i></span><input id="sm-kick" class="form-control" placeholder="Kick"></div>
                <button class="btn btn-sm btn-success w-100 mt-2" onclick="saveSocials()">Sosyal Medyayƒ± Kaydet</button>
             </div>
             <button class="btn btn-outline-danger w-100 mt-4 py-3 rounded-4 fw-bold" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="goTab('tasks',this)"><i class="fas fa-check-circle"></i></button>
            <button class="nav-btn" onclick="goTab('messages',this)"><i class="fas fa-paper-plane"></i></button>
            <button class="nav-btn" onclick="goTab('team',this)"><i class="fas fa-users"></i></button>
            <button class="nav-btn" onclick="goTab('profile',this)"><i class="fas fa-user"></i></button>
        </nav>
    </div>

    <div id="chat-overlay">
        <div style="flex: 0 0 70px; background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10;">
            <div class="d-flex align-items-center">
                <button class="btn text-white me-2 p-0" onclick="closeChat()"><i class="fas fa-arrow-left fa-lg"></i></button>
                <h6 class="m-0 fw-bold text-white" id="chat-overlay-title">Sohbet</h6>
            </div>
            <button class="btn-ai btn-sm px-3" onclick="aiSummarizeChat()" title="Sohbeti √ñzetle">‚ú® √ñzetle</button>
        </div>
        
        <div id="pinned-msg-bar" class="pinned-msg-bar">
            <div><i class="fas fa-thumbtack text-primary me-2"></i> <span id="pinned-msg-text" class="fw-bold" style="opacity: 0.9;"></span></div>
            <i class="fas fa-times text-muted" onclick="event.stopPropagation(); document.getElementById('pinned-msg-bar').style.display='none';"></i>
        </div>

        <div class="chat-body-scroll" id="chat-overlay-body"></div>
        
        <div id="reply-preview-bar" class="reply-preview-bar">
            <div style="overflow: hidden;">
                <div class="fw-bold text-primary mb-1" style="font-size: 11px;"><i class="fas fa-reply me-1"></i> Yanƒ±tlanƒ±yor</div>
                <div id="reply-preview-text" class="text-truncate text-muted"></div>
            </div>
            <i class="fas fa-times fs-5 text-muted clickable" onclick="cancelReply()"></i>
        </div>

        <form id="chat-form" style="flex: 0 0 auto; background: var(--nav-dark); border-top: 1px solid #27272a; padding: 15px; padding-bottom: 25px; display: flex; gap: 10px; align-items: flex-end; position: relative;">
            
            <div id="mention-menu"></div>

            <input type="file" id="chat-file-inp" multiple hidden>
            <button type="button" class="btn btn-dark text-muted rounded-circle" style="width:45px;height:45px; flex-shrink:0" onclick="document.getElementById('chat-file-inp').click()"><i class="fas fa-paperclip"></i></button>
            <textarea id="chat-input" class="form-control" placeholder="Mesaj" style="border-radius:20px; resize:none; overflow-y:auto; max-height: 120px; padding-top: 12px; height: 45px;" rows="1"></textarea>
            <button type="submit" class="btn btn-primary rounded-circle" style="width:45px;height:45px; flex-shrink:0"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="modal-notepad" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card-custom border-0 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0 text-info"><i class="fas fa-sticky-note me-2"></i>Ki≈üisel Notlarƒ±m</h5>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearNotepad()"><i class="fas fa-trash me-1"></i>Temizle</button>
                </div>
                <ul class="nav nav-pills nav-fill mb-2 bg-dark rounded p-1" style="border: 1px solid #333; font-size:12px;">
                    <li class="nav-item"><a class="nav-link active rounded py-1" data-bs-toggle="pill" href="#note-edit">D√ºzenle</a></li>
                    <li class="nav-item"><a class="nav-link rounded py-1" data-bs-toggle="pill" href="#note-view" onclick="previewNotepad()">G√∂r√ºn√ºm</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="note-edit">
                        <textarea id="notepad-text" class="form-control auto-expand" placeholder="Kendine √∂zel notlar... (*kalƒ±n*, _eƒüik_, - liste)" style="resize:none; min-height:150px; max-height:400px; overflow-y:auto;"></textarea>
                    </div>
                    <div class="tab-pane fade" id="note-view">
                        <div id="notepad-preview" class="p-2 small bg-dark rounded border border-secondary" style="min-height:150px; max-height: 400px; overflow-y:auto; resize:vertical; word-break: break-word;"></div>
                    </div>
                </div>
                <button class="btn-primary-soft mt-3" onclick="saveNotepad()">Kaydet</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-edit-msg" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Mesajƒ± D√ºzenle</h5><input id="edit-msg-input" class="form-control mb-3"><button class="btn-primary-soft" onclick="submitEditMsg()">Kaydet</button></div></div></div>
    <div class="modal fade" id="modal-reactions" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Tepkiler</h5><div id="reaction-list" style="max-height:300px;overflow-y:auto"></div><div class="d-flex justify-content-end mt-2"><button class="btn btn-dark btn-sm" data-bs-dismiss="modal">Kapat</button></div></div></div></div>

    <div class="modal fade" id="modal-task" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">G√∂revi Y√∂net</h5><form id="form-task">
        <input type="hidden" id="t-id">
        <div class="d-flex gap-2 mb-3">
            <input id="t-title" class="form-control" placeholder="Ba≈ülƒ±k" required>
        </div>
        <textarea id="t-desc" class="form-control mb-3 auto-expand" placeholder="A√ßƒ±klama (*kalƒ±n*, _eƒüik_, vb. kullanƒ±labilir)" style="resize:none; min-height:80px; max-height:250px; overflow-y:auto;"></textarea>
        <div class="mb-3"><label class="small text-muted">Son Tarih (Opsiyonel)</label><input type="datetime-local" id="t-deadline" class="form-control"></div>
        <div class="mb-3 fs-4 text-warning" id="star-select"><i class="far fa-star clickable" onclick="setStars(1)"></i><i class="far fa-star clickable" onclick="setStars(2)"></i><i class="far fa-star clickable" onclick="setStars(3)"></i><i class="far fa-star clickable" onclick="setStars(4)"></i><i class="far fa-star clickable" onclick="setStars(5)"></i></div><input type="hidden" id="t-stars" value="0">
        <select id="t-type" class="form-select mb-3" onchange="togT(this.value)"><option value="department">Departman</option><option value="user">Ki≈üi</option><option value="all">Herkes</option></select>
        <select id="t-dept" class="form-select mb-3"></select>
        <select id="t-user" class="form-select mb-4 d-none"></select> <button type="button" class="btn-primary-soft" onclick="saveTask()">Kaydet</button>
    </form></div></div></div>

    <div class="modal fade" id="modal-task-detail" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3">
        <div class="d-flex justify-content-between align-items-start mb-3"><div style="flex:1; margin-right:10px;"><h5 class="fw-bold mb-1" id="td-title">...</h5><div id="td-assignees" class="d-flex align-items-center mb-1"></div></div><div class="text-end" id="td-meta"></div></div>
        <div class="d-flex flex-wrap gap-2 mb-2 align-items-center" id="td-stars-wrapper"></div>
        <div class="p-2 mb-3 small" id="td-desc" style="min-height:60px; max-height:300px; overflow-y:auto; resize:vertical; background: rgba(0,0,0,0.3); border-radius:12px;"></div>
        
        <div id="td-submission-area" class="mb-3" style="display: none;">
            <label class="small text-muted fw-bold mb-1">G√∂revi Teslim Et / Not Ekle</label>
            <textarea id="t-submission-input" class="form-control mb-2 auto-expand" placeholder="G√∂revle ilgili link, d√∂k√ºman veya notunuzu buraya girebilirsiniz..." style="font-size: 13px; min-height: 60px; max-height:150px; resize:none; overflow-y:auto;"></textarea>
            <button class="btn btn-sm btn-outline-info w-100" onclick="saveTaskSubmission()">ƒ∞let / G√ºncelle</button>
        </div>

        <h6 class="small fw-bold text-muted mb-2">DURUM Lƒ∞STESƒ∞</h6><div id="td-status-list" class="d-flex flex-column gap-2" style="max-height: 300px; overflow-y: auto;"></div><div class="d-flex justify-content-end mt-3"><button class="btn btn-dark border-secondary btn-sm" data-bs-dismiss="modal">Kapat</button></div></div></div></div>

    <div class="modal fade" id="modal-profile-view" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-4 position-relative">
        <button class="btn btn-sm btn-dark position-absolute top-0 end-0 m-3 rounded-circle" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
        <div class="d-flex align-items-center gap-3 mb-3 text-start"><img id="vp-img" src="" class="rounded-circle border border-2 border-secondary p-1" width="110" height="110"><div><h4 id="vp-name" class="fw-bold mb-1">...</h4><div id="vp-badges" class="d-flex flex-wrap gap-1"></div>
        <div id="vp-external-id" class="badge bg-dark border border-secondary text-muted mt-2 clickable" onclick="copyText(this.dataset.uid, 'Kullanƒ±cƒ± ID')" title="Kopyalamak i√ßin tƒ±kla" style="font-family: monospace; font-size: 9px; padding: 2px 6px; font-weight: normal; opacity: 0.8;"></div>
        </div></div>
        <div class="mb-3 text-start">
             <div class="small text-muted mb-1"><i class="fas fa-university me-1"></i> <span id="vp-uni" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-graduation-cap me-1"></i> <span id="vp-dept" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i> <span id="vp-address" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-birthday-cake me-1"></i> <span id="vp-dob" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-phone me-1"></i> <span id="vp-phone" class="text-white">...</span></div>
             <div class="small text-muted"><i class="fas fa-envelope me-1"></i> <span id="vp-email" class="text-white">...</span></div>
        </div>
        <div class="card-custom bg-dark p-3 d-flex align-items-center justify-content-between mb-3"><div class="text-start"><div class="text-muted small">Genel Ba≈üarƒ±</div><h4 class="fw-bold m-0" id="vp-rate">0%</h4></div><svg width="50" height="50" viewBox="0 0 60 60"><circle class="progress-ring__bg" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"/><circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="vp-circle" stroke-dasharray="163.36" stroke-dashoffset="163.36"/></svg></div>
        <h6 class="small fw-bold text-muted mb-2">SOSYAL MEDYA</h6><div id="vp-socials" class="d-flex justify-content-center flex-wrap gap-3 fs-3"></div>
    </div></div></div>

    <div class="modal fade" id="modal-user-edit" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">√úye D√ºzenle (Admin)</h5><h6 id="ue-name" class="text-primary mb-3"></h6><div id="ue-roles" class="d-flex flex-wrap gap-2 mb-3"></div><div id="ue-depts" class="d-flex flex-wrap gap-2 mb-3"></div><button class="btn btn-success w-100" onclick="saveUserEdit()">Kaydet</button></div></div></div>
    
    <div class="modal fade" id="modal-leaderboard" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-0 overflow-hidden"><div class="bg-warning p-3 text-center"><h5 class="fw-bold m-0 text-black"><i class="fas fa-trophy me-2"></i>Sƒ±ralama</h5></div>
    <div class="lb-tabs">
        <div class="lb-tab active" onclick="switchLB('departman', this)">Departman</div>
        <div class="lb-tab" onclick="switchLB('haftalik', this)">Haftalƒ±k</div>
        <div class="lb-tab" onclick="switchLB('herkes', this)">Herkes</div>
    </div>
    <div id="lb-list" class="p-3" style="max-height: 50vh; overflow-y: auto;"></div></div></div></div>
    
    <div class="modal fade" id="modal-notif" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Bildirimler</h5><div id="notif-list" style="max-height:50vh;overflow-y:auto"></div></div></div></div>
    <div class="modal fade" id="modal-status" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content card-custom border-0 p-3 text-center"><h6 class="mb-3">Durum G√ºncelle</h6><div class="d-grid gap-2"><button class="btn btn-outline-secondary" onclick="updateTaskStatus('pending')">Ba≈ülamadƒ±</button><button class="btn btn-outline-primary" onclick="updateTaskStatus('progress')">Yapƒ±lƒ±yor</button><button class="btn btn-outline-success" onclick="updateTaskStatus('done')">Bitti</button></div></div></div></div>
    <div class="modal fade" id="modal-name-edit" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content card-custom border-0 p-3"><h6 class="mb-3">ƒ∞sim Deƒüi≈ütir</h6><input id="inp-new-name" class="form-control mb-3"><button class="btn btn-success w-100" onclick="saveMyName()">Kaydet</button></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, query, where, onSnapshot, updateDoc, deleteDoc, getDocs, getDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDHbuPLeir2dn9BFI7Rt2AxUp_6E0VFy_8", authDomain: "smilego-tracker.firebaseapp.com", projectId: "smilego-tracker", storageBucket: "smilego-tracker.firebasestorage.app", messagingSenderId: "49933018016", appId: "1:49933018016:web:f69bf14464bfd4399a3ac5" };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app);

        const geminiApiKey = ""; 
        
        async function fetchGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            let retries = 3; let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error?.message || `Bilinmeyen HTTP Hatasƒ±: ${res.status}`);
                    }
                    
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        const ADMIN_EMAIL = "yenerarda7@gmail.com";
        const DEPTS = ["Organizasyonel Geli≈üim","Sosyal Medya","B√∂lge Koordinat√∂rl√ºƒü√º","Psikolog ƒ∞li≈ükileri","Data & Planlama","Kurumsal ƒ∞leti≈üim", "Yazƒ±lƒ±m"];
        const DEPT_ABBR = { "Sosyal Medya": "SMD", "Psikolog ƒ∞li≈ükileri": "Pƒ∞D", "Data & Planlama": "DPD", "B√∂lge Koordinat√∂rl√ºƒü√º": "BKD", "Kurumsal ƒ∞leti≈üim": "Kƒ∞D", "Organizasyonel Geli≈üim": "OGD", "Yazƒ±lƒ±m": "YD" };
        const ROLES = ["Ba≈ükan", "YK", "YKY", "√úye", "Admin"];
        const UNIVERSITIES = ["Sakarya √úniversitesi", "Sakarya Uygulamalƒ± Bilimler √úniversitesi", "ƒ∞stanbul √úniversitesi", "ODT√ú", "ƒ∞T√ú", "Boƒüazi√ßi √úniversitesi", "Marmara √úniversitesi", "Yƒ±ldƒ±z Teknik √úniversitesi", "Hacettepe √úniversitesi", "Ankara √úniversitesi", "Ege √úniversitesi", "Dokuz Eyl√ºl √úniversitesi", "Gazi √úniversitesi", "Anadolu √úniversitesi", "Akdeniz √úniversitesi", "√áukurova √úniversitesi", "Bilkent √úniversitesi", "Ko√ß √úniversitesi", "Sabancƒ± √úniversitesi", "Yeditepe √úniversitesi", "Bah√ße≈üehir √úniversitesi", "Kocaeli √úniversitesi", "D√ºzce √úniversitesi", "Bolu Abant ƒ∞zzet Baysal √úniversitesi", "Galatasaray √úniversitesi", "Mimar Sinan G√ºzel Sanatlar √úniversitesi"];
        const DEPARTMENTS_UNI = ["G√∂rsel ƒ∞leti≈üim Tasarƒ±mƒ±", "ƒ∞leti≈üim Tasarƒ±mƒ±", "Grafik Tasarƒ±m", "√áizgi Film ve Animasyon", "Radyo, Televizyon ve Sinema", "Halkla ƒ∞li≈ükiler ve Reklamcƒ±lƒ±k", "Yeni Medya ve ƒ∞leti≈üim", "Bilgisayar M√ºhendisliƒüi", "Yazƒ±lƒ±m M√ºhendisliƒüi", "End√ºstri M√ºhendisliƒüi", "ƒ∞≈ületme", "ƒ∞ktisat", "Maliye", "Uluslararasƒ± ƒ∞li≈ükiler", "Siyaset Bilimi ve Kamu Y√∂netimi", "Psikoloji", "Sosyoloji", "Felsefe", "Hukuk", "Tƒ±p", "Di≈ü Hekimliƒüi", "Eczacƒ±lƒ±k", "Hem≈üirelik", "Mimarlƒ±k", "ƒ∞√ß Mimarlƒ±k", "≈ûehir ve B√∂lge Planlama", "√ñzel Eƒüitim √ñƒüretmenliƒüi", "Okul √ñncesi √ñƒüretmenliƒüi", "Sƒ±nƒ±f √ñƒüretmenliƒüi", "ƒ∞ngilizce √ñƒüretmenliƒüi", "Matematik", "Fizik", "Kimya", "Biyoloji", "Tarih", "Coƒürafya", "T√ºrk Dili ve Edebiyatƒ±", "End√ºstriyel Tasarƒ±m", "Moda Tasarƒ±mƒ±", "Resim", "Heykel", "Seramik"];

        let curUser=null, uData={}, activeChatId=null;
        let unsubUser=null, unsubTasks=null, unsubTeam=null, unsubChat=null, unsubNotif=null, unsubDMs=null, unsubChannelMeta=null;
        let allUsersCache=[], allTasksCache={}, channelMetaCache={};
        let selectedTaskForStatus = null, selectedUserForEdit = null, selectedMsg = null, longPressTimer = null, currentReplyToId = null;
        let lbMode = 'departman';
        let currentTaskSort = 'newest'; 
        let adminTaskDeptFilter = 'all'; 
        let currentChatMsgs = []; 
        let pendingScrollMsgId = null; 
        
        let taskRenderLimit = 20;
        let chatRenderLimit = 30;
        let currentChatSnapshot = [];
        
        const isHiddenUser = (user) => user.roles && user.roles.includes('Admin');

        const NAME_COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e', '#e879f9', '#2dd4bf'];
        function getUserColor(uid) { let hash = 0; for (let i = 0; i < uid.length; i++) { hash = uid.charCodeAt(i) + ((hash << 5) - hash); } return NAME_COLORS[Math.abs(hash) % NAME_COLORS.length]; }

        window.showToast = (msg) => { const t = document.getElementById('app-toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        window.alert = window.showToast;
        window.customConfirm = (text, cb) => { document.getElementById('confirm-text').innerText = text; const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-confirm')); document.getElementById('confirm-btn-yes').onclick = () => { cb(); modal.hide(); }; modal.show(); };

        // Ortak Kopyalama Fonksiyonu
        window.copyText = (txt, label="Metin") => {
            if(!txt) return;
            const ta = document.createElement('textarea');
            ta.value = txt;
            ta.style.position = 'fixed';
            ta.style.top = '0';
            ta.style.left = '0';
            ta.style.opacity = '0';
            
            // BOOTSTRAP ODAK Kƒ∞Lƒ∞Dƒ∞ √á√ñZ√úM√ú: Eƒüer ekranda a√ßƒ±k bir modal varsa, textarea'yƒ± body yerine modalƒ±n i√ßine ekle.
            const container = document.querySelector('.modal.show') || document.body;
            container.appendChild(ta);
            
            ta.focus();
            ta.select();
            try { 
                document.execCommand('copy'); 
                showToast(label + " Panoya Kopyalandƒ±!"); 
            } catch(e) { 
                showToast("Kopyalama ba≈üarƒ±sƒ±z oldu."); 
            }
            container.removeChild(ta);
        };

        window.enableWebPush = () => {
            if(window.OneSignalDeferred) {
                OneSignalDeferred.push(async function(OneSignal) {
                    await OneSignal.Slidedown.promptPush();
                    showToast("Bildirim yetkisi tetiklendi. L√ºtfen tarayƒ±cƒ± izinlerini kontrol edin.");
                });
            } else {
                showToast("Bildirim altyapƒ±sƒ± y√ºklenemedi.");
            }
        };

        function getWeekRange() {
            const now = new Date();
            const day = now.getDay(); 
            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
            const start = new Date(now.setDate(diff)); start.setHours(0,0,0,0);
            const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999);
            return { start, end };
        }

        let chatOpen = false;
        window.onpopstate = () => {
            if(chatOpen) { closeChat(); return; }
            const activeModal = document.querySelector('.modal.show');
            if(activeModal) { bootstrap.Modal.getInstance(activeModal).hide(); }
        };
        const pushState = () => window.history.pushState(null, null, window.location.href);

        onAuthStateChanged(auth, async u => {
            if(u){
                curUser = u;
                unsubUser = onSnapshot(doc(db,"users",u.uid), s => {
                    if(s.exists()){
                        uData = s.data();
                        if(uData.isBanned) { signOut(auth); showToast("Hesap eri≈üimi engellendi."); return; }
                        if(!Array.isArray(uData.roles)) uData.roles = [uData.role || '√úye'];
                        if(!Array.isArray(uData.departments)) uData.departments = [uData.department || '...'];
                        if(!uData.readReceipts) uData.readReceipts = {}; 
                        if(u.email === ADMIN_EMAIL && !uData.roles.includes('Admin')) uData.roles.push('Admin');
                        
                        const lBtn = document.querySelector('#form-login button');
                        if(lBtn) { lBtn.innerText = "Giri≈ü Yap"; lBtn.disabled = false; }
                        
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('app-screen').style.display = 'block';
                        
                        checkUIState(); 
                        updateProfileBadges(); 
                        
                        if(!document.getElementById('btn-add-task').dataset.initialized) {
                            initApp();
                            document.getElementById('btn-add-task').dataset.initialized = "true";
                        }
                    } else {
                        signOut(auth);
                        showToast("Kritik Hata: Veritabanƒ± kaydƒ± yok. L√ºtfen yeniden kayƒ±t olun.");
                        const lBtn = document.querySelector('#form-login button');
                        if(lBtn) { lBtn.innerText = "Giri≈ü Yap"; lBtn.disabled = false; }
                    }
                });
                
                if(window.OneSignalDeferred) OneSignalDeferred.push(()=>OneSignal.login(u.uid));
                
                setTimeout(() => {
                    const iframe = document.createElement("iframe");
                    iframe.style.display = "none";
                    iframe.src = "median://onesignal/setExternalUserId?externalUserId=" + u.uid;
                    document.body.appendChild(iframe);
                    setTimeout(() => iframe.remove(), 1000);
                }, 1500);

            } else {
                cleanup(); document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-screen').style.display = 'none';
            }
        });

        const isAdmin = () => uData.roles?.includes('Admin');
        const isPres = () => uData.roles?.includes('Ba≈ükan');
        const canManageUsers = () => isAdmin() || isPres();
        
        const canSeeAllTasks = () => {
            return uData.roles?.some(r => ['Ba≈ükan', 'YK', 'Admin'].includes(r)) || 
                   uData.departments?.includes('Organizasyonel Geli≈üim');
        };
        const canSeeAllChannels = () => uData.roles?.some(r => ['YK','Ba≈ükan','Admin'].includes(r));
        const isBoard = () => uData.roles?.some(r => ['YK','YKY','Ba≈ükan','Admin'].includes(r));

        function checkUIState() {
            if(!canManageUsers() && !uData.roles.includes('YK') && !uData.roles.includes('YKY')) { 
                document.getElementById('btn-add-task').style.display = 'none'; 
            } else {
                document.getElementById('btn-add-task').style.display = 'block'; 
            }

            const filterWrapper = document.getElementById('admin-dept-filter-wrapper');
            if(canSeeAllTasks()) {
                filterWrapper.style.display = 'block';
            } else {
                filterWrapper.style.display = 'none';
            }
        }

        async function initApp() {
            loadProfile(); listenTasks(); listenTeam(); listenChannelMeta(); loadChannels(); listenNotifs(); loadRecentDMs();
            
            const dSelect = document.getElementById('t-dept'); dSelect.innerHTML='';
            DEPTS.forEach(d => dSelect.innerHTML += `<option>${d}</option>`);

            const filterMenu = document.getElementById('admin-dept-filter-menu');
            filterMenu.innerHTML = `<li><a class="dropdown-item active" href="#" onclick="changeAdminDeptFilter('all', this); event.preventDefault();">T√ºm Departmanlar</a></li>`;
            DEPTS.forEach(d => {
                filterMenu.innerHTML += `<li><a class="dropdown-item" href="#" onclick="changeAdminDeptFilter('${d}', this); event.preventDefault();">${d}</a></li>`;
            });
        }

        function cleanup() { if(unsubUser) unsubUser(); if(unsubTasks) unsubTasks(); if(unsubTeam) unsubTeam(); if(unsubChat) unsubChat(); if(unsubNotif) unsubNotif(); if(unsubDMs) unsubDMs(); if(unsubChannelMeta) unsubChannelMeta(); curUser=null; uData={}; currentChatMsgs=[]; document.getElementById('btn-add-task').dataset.initialized = ""; }

        window.updateProfileBadges = () => {
            if(!uData || !uData.roles) return;
            document.getElementById('prof-name').innerText = uData.name;
            const rDiv = document.getElementById('prof-roles'); rDiv.innerHTML='';
            rDiv.className = "d-flex justify-content-center flex-wrap gap-2 mb-2"; 
            uData.roles.forEach(r => rDiv.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            uData.departments.forEach(d => { 
                const abbr = DEPT_ABBR[d] || d.substring(0,3); 
                rDiv.innerHTML += `<span class="badge bg-dark border border-secondary text-muted small ms-1">${abbr}</span>`; 
            });
        };

        window.loadProfile = () => {
            document.getElementById('prof-img').src = uData.photoURL || 'https://via.placeholder.com/150';
            updateProfileBadges(); 
            
            const extId = document.getElementById('prof-external-id');
            extId.innerHTML = `<i class="fas fa-fingerprint me-1"></i> ${curUser.uid} <i class="fas fa-copy ms-1"></i>`;
            extId.dataset.uid = curUser.uid;
            
            document.getElementById('inp-uni').value = uData.university || '';
            document.getElementById('inp-sec').value = uData.uni_dept || '';
            document.getElementById('inp-city').value = uData.city || '';
            document.getElementById('inp-dist').value = uData.district || '';
            document.getElementById('inp-dob').value = uData.dob || '';
            document.getElementById('inp-phone').value = uData.phone || '';
            document.getElementById('inp-email').value = uData.contactEmail || uData.email || '';
            if(uData.socials) { ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => { document.getElementById(`sm-${k}`).value = uData.socials[k] || ''; }); }
            calcSuccessRate();
        };

        window.calcSuccessRate = () => {
            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => { 
                const isAssigned = (t.assignedType==='all' && t.createdByUid !== curUser.uid) || 
                                   (t.assignedType==='department' && uData.departments.includes(t.assignedTo) && t.createdByUid !== curUser.uid) || 
                                   (t.assignedType==='user' && t.assignedToUid===curUser.uid);
                if(isAssigned) {
                    total++;
                    if(t.statusMap && t.statusMap[curUser.uid] === 'done') done++;
                }
            });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('prof-rate').innerText = `%${rate}`;
            const circle = document.getElementById('prof-circle');
            circle.style.strokeDashoffset = (163.36 * (100 - rate)) / 100;
        };

        function parseMD(txt) {
            if(!txt) return '';
            let html = txt.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/_(.*?)_/g, '<i>$1</i>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            html = html.replace(/~(.*?)~/g, '<s>$1</s>');
            let lines = html.split('\n');
            let out = '', inList = false;
            for(let i=0; i<lines.length; i++) {
                let line = lines[i];
                if(line.trim().startsWith('- ')) {
                    if(!inList) { out += '<ul>'; inList = true; }
                    out += `<li>${line.trim().substring(2)}</li>`;
                } else if(/^\d+\.\s/.test(line.trim())) {
                    if(!inList) { out += '<ol>'; inList = true; }
                    out += `<li>${line.replace(/^\d+\.\s/, '')}</li>`;
                } else {
                    if(inList) { out += '</ul>'; inList = false; } 
                    out += line + (i < lines.length - 1 ? '<br>' : '');
                }
            }
            if(inList) out += '</ul>';
            return out.replace(/<\/ul><br>/g, '</ul>').replace(/<\/ol><br>/g, '</ol>');
        }

        window.openNotepad = () => {
            document.getElementById('notepad-text').value = uData.personalNotes || '';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-notepad')).show();
        };
        window.saveNotepad = async () => {
            const text = document.getElementById('notepad-text').value;
            await updateDoc(doc(db, "users", curUser.uid), { personalNotes: text });
            uData.personalNotes = text;
            showToast("Notlar kaydedildi!");
            bootstrap.Modal.getInstance(document.getElementById('modal-notepad')).hide();
        };
        
        window.clearNotepad = () => {
            customConfirm("T√ºm notlarƒ± silmek istediƒüine emin misin?", async () => { 
                document.getElementById('notepad-text').value = ''; 
                await updateDoc(doc(db, "users", curUser.uid), { personalNotes: '' });
                uData.personalNotes = '';
                previewNotepad();
                showToast("Notlar temizlendi!");
            });
        };
        window.previewNotepad = () => { document.getElementById('notepad-preview').innerHTML = linkify(parseMD(document.getElementById('notepad-text').value || 'Not yok.')); };

        window.saveEduInfo = async () => { 
            await updateDoc(doc(db,"users",curUser.uid), { 
                university: document.getElementById('inp-uni').value, 
                uni_dept: document.getElementById('inp-sec').value,
                city: document.getElementById('inp-city').value,
                district: document.getElementById('inp-dist').value,
                dob: document.getElementById('inp-dob').value,
                phone: document.getElementById('inp-phone').value,
                contactEmail: document.getElementById('inp-email').value
            }); 
            showToast("Kaydedildi!"); 
        };
        window.saveSocials = async () => { const soc = {}; ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => { const v = document.getElementById(`sm-${k}`).value.trim(); if(v) soc[k] = v; }); await updateDoc(doc(db,"users",curUser.uid), { socials: soc }); showToast("Kaydedildi!"); };
        
        window.editMyName = () => { document.getElementById('inp-new-name').value = uData.name; bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-name-edit')).show(); }
        window.saveMyName = async () => {
             const newName = document.getElementById('inp-new-name').value;
             if(newName) {
                 await updateDoc(doc(db,"users",curUser.uid), { name: newName });
                 showToast("ƒ∞sim g√ºncellendi.");
                 const m = bootstrap.Modal.getInstance(document.getElementById('modal-name-edit'));
                 if(m) m.hide();
             }
        }

        window.filterSearch = (type) => {
            const inp = document.getElementById(`inp-${type}`); const list = document.getElementById(`list-${type}`);
            const val = inp.value.toLowerCase(); const source = type === 'uni' ? UNIVERSITIES : DEPARTMENTS_UNI;
            list.innerHTML = ''; if(val.length < 1) { list.style.display='none'; return; }
            source.filter(s => s.toLowerCase().includes(val)).forEach(m => { const d = document.createElement('div'); d.innerText = m; d.onclick = () => { inp.value = m; list.style.display='none'; }; list.appendChild(d); });
            list.style.display = 'block';
        };

        window.togT=(v)=>{
            document.getElementById('t-dept').classList.toggle('d-none',v!=='department');
            document.getElementById('t-user').classList.toggle('d-none',v!=='user');
        };

        function linkify(text) {
            const urlRegex = /(^|\s|<br>|&nbsp;)((?:https?:\/\/|www\.)[^\s<]+|(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(?:\/[^\s<]*)?)/gi;
            return text.replace(urlRegex, function(match, p1, p2) {
                let href = p2;
                if (!href.match(/^https?:\/\//i)) { href = 'https://' + href; }
                return `${p1}<a href="${href}" target="_blank" style="color:#93c5fd">${p2}</a>`;
            });
        }

        function formatDeadline(dl) {
            if(!dl) return '';
            const date = new Date(dl);
            const dateStr = date.toLocaleString('tr-TR', { day: 'numeric', month: 'short', weekday: 'short', hour: '2-digit', minute: '2-digit' });
            
            const diff = date - new Date();
            if(diff < 0) return `<div class="d-flex flex-column align-items-end"><span class="small text-muted">${dateStr}</span><span class="badge bg-danger" style="font-size:10px">S√ºre Doldu!</span></div>`;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const timeRem = days > 0 ? `${days} g√ºn` : `${hours} saat`;
            return `<div class="d-flex flex-column align-items-end"><span class="small text-muted">${dateStr}</span><span class="badge bg-warning text-dark" style="font-size:10px">${timeRem} kaldƒ±</span></div>`;
        }

        window.changeTaskSort = (type, btn) => {
            currentTaskSort = type;
            taskRenderLimit = 20; 
            const menu = btn.closest('.dropdown-menu');
            menu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');
            renderTasksToPage(false); 
        };

        window.changeAdminDeptFilter = (dept, btn) => {
            adminTaskDeptFilter = dept;
            taskRenderLimit = 20; 
            const menu = btn.closest('.dropdown-menu');
            menu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');
            renderTasksToPage(false); 
        }

        document.addEventListener('input', function (event) {
            if (event.target.classList.contains('auto-expand')) {
                event.target.style.height = 'auto';
                event.target.style.height = (event.target.scrollHeight) + 'px';
            }
        }, false);

        window.renderTasksToPage = (preserveScroll = true) => {
             const list = document.getElementById('task-list'); 
             const view = document.getElementById('view-tasks');
             
             const scrollPos = view.scrollTop; 
             
             list.innerHTML = ''; 
             let tempArr = Object.values(allTasksCache);
             
             if (currentTaskSort === 'newest') {
                 tempArr.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
             } else if (currentTaskSort === 'oldest') {
                 tempArr.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
             } else if (currentTaskSort === 'importance') {
                 tempArr.sort((a,b) => {
                     const impA = a.importance || 0;
                     const impB = b.importance || 0;
                     if (impB !== impA) return impB - impA;
                     return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                 });
             }
             
             const filterBtn = document.querySelector('.btn-outline-secondary.active');
             const filter = filterBtn ? filterBtn.innerText : 'T√ºm√º';
             const { start, end } = getWeekRange();

             let filteredTasks = [];

             tempArr.forEach(t => {
                if(!t || !t.title || t.title === 'undefined') return;

                let myStatus = 'pending';
                if(t.statusMap) {
                    if(t.statusMap[curUser.uid]) myStatus = t.statusMap[curUser.uid];
                    else if(t.assignedToUid !== curUser.uid) myStatus = Object.values(t.statusMap)[0] || 'pending';
                }
                
                if(filter === 'Bu Hafta') {
                    const tSeconds = t.createdAt?.seconds || (Date.now()/1000);
                    const tDate = new Date(tSeconds * 1000);
                    if(tDate < start || tDate > end) return;
                }
                if(filter === 'Ba≈ülamadƒ±' && myStatus !== 'pending') return;
                if(filter === 'Yapƒ±lƒ±yor' && myStatus !== 'progress') return;
                if(filter === 'Bitti' && myStatus !== 'done') return;

                if(canSeeAllTasks() && adminTaskDeptFilter !== 'all') {
                    if(t.assignedType === 'department' && t.assignedTo !== adminTaskDeptFilter) return;
                    if(t.assignedType === 'user' && t.assignedToUid) {
                        const tgtU = allUsersCache.find(x => x.uid === t.assignedToUid);
                        if(tgtU && !tgtU.departments.includes(adminTaskDeptFilter)) return;
                    }
                }
                
                filteredTasks.push({ t, myStatus });
            });

            const slicedTasks = filteredTasks.slice(0, taskRenderLimit);

            slicedTasks.forEach(item => {
                const { t, myStatus } = item;
                
                let starsHtml = ''; for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning" style="font-size:10px"></i>';
                const stClass = myStatus === 'pending' ? 'st-pending' : (myStatus === 'progress' ? 'st-progress' : 'st-done');
                const stText = myStatus === 'pending' ? 'Ba≈ülamadƒ±' : (myStatus === 'progress' ? 'Yapƒ±lƒ±yor' : 'Bitti');
            
            const isAssignedToMe = (t.assignedType==='all' && t.createdByUid !== curUser.uid) || 
                                   (t.assignedType==='department' && uData.departments.includes(t.assignedTo) && t.createdByUid !== curUser.uid) || 
                                   (t.assignedType==='user' && t.assignedToUid===curUser.uid);
            
            const canChangeStatus = isAssignedToMe;
            const dlBadge = formatDeadline(t.deadline);
            const canEdit = (t.createdByUid === curUser.uid || isAdmin());

            let createdAtStr = '';
            if (t.createdAt && t.createdAt.seconds) {
                const cDate = new Date(t.createdAt.seconds * 1000);
                createdAtStr = cDate.toLocaleString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            }

            let assigneesHtml = '';
            if(t.assignedType === 'user' && t.assignedToUid) {
                const u = allUsersCache.find(x => x.uid === t.assignedToUid);
                const p = u ? u.photoURL : 'https://ui-avatars.com/api/?name=U';
                    const n = u ? u.name : t.assignedTo;
                    assigneesHtml = `<div class="d-flex align-items-center gap-2 px-3 py-1 border border-secondary rounded"><img src="${p}" class="rounded-circle" width="20"><span class="small">${n}</span></div>`;
                } else {
                    const abbr = DEPT_ABBR[t.assignedTo] || t.assignedTo;
                    assigneesHtml = `<span class="badge bg-dark border border-secondary text-muted">${abbr}</span>`;
                }

                let pureText = (t.description || '').replace(/<[^>]+>/g, '').replace(/[\*\_~-]/g, '');

            list.innerHTML += `
            <div class="card-custom position-relative" onclick="openTaskDetail('${t.id}'); pushState()">
                <div class="task-right-panel">
                    ${canEdit ? `<div class="task-icons">
                        <i class="fas fa-edit text-warning clickable" onclick="event.stopPropagation();openTaskModal('${t.id}')"></i>
                        <i class="fas fa-trash text-danger clickable" onclick="event.stopPropagation();delTask('${t.id}')"></i>
                    </div>` : ''}
                    ${dlBadge}
                </div>
                
                <div class="task-card-content" style="margin-right: 90px;">
                    <div class="text-muted" style="font-size: 9px; margin-bottom: 2px; opacity: 0.6;"><i class="fas fa-calendar-plus me-1"></i>${createdAtStr}</div>
                    <h6 class="fw-bold mb-1 text-truncate">${t.title}</h6>
                    <div class="d-flex align-items-center gap-2 mb-2">${assigneesHtml} <div class="d-flex" style="gap:2px">${starsHtml}</div></div>
                </div>

                <p class="text-muted small mb-3 text-truncate" style="margin-right:90px">${pureText}</p>
                
                <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2"><img src="${t.creatorPhoto || 'https://ui-avatars.com/api/?name=User'}" class="rounded-circle" width="20"><small class="text-muted" style="font-size:11px">${t.creatorName}</small></div>
                        ${canChangeStatus ? `<button class="btn btn-sm status-badge ${stClass}" onclick="event.stopPropagation();openStatusModal('${t.id}'); pushState()">${stText}</button>` : `<span class="status-badge ${stClass}">${stText}</span>`}
                    </div>
                </div>`;
            });

            if (filteredTasks.length > taskRenderLimit) {
                list.innerHTML += `<button class="btn btn-dark border-secondary text-primary w-100 mt-2 py-3 fw-bold shadow-sm rounded-4" onclick="loadMoreTasks()">Daha Fazla G√∂ster (${filteredTasks.length - taskRenderLimit} kaldƒ±)</button>`;
            }

            calcSuccessRate();
            
            if(preserveScroll) {
                setTimeout(() => { view.scrollTop = scrollPos; }, 0); 
            } else {
                view.scrollTop = 0; 
            }
        };

        window.loadMoreTasks = () => {
            taskRenderLimit += 20;
            renderTasksToPage(true); 
        };

        function listenTasks() {
            if(unsubTasks) unsubTasks();
            unsubTasks = onSnapshot(collection(db,"tasks"), s => {
                allTasksCache = {}; 
                s.forEach(d => {
                    const t = { id: d.id, ...d.data() }; 
                    const isAssignedToMe = (t.assignedType==='all' && t.createdByUid !== curUser.uid) || 
                                           (t.assignedType==='department' && uData.departments.includes(t.assignedTo) && t.createdByUid !== curUser.uid) || 
                                           (t.assignedType==='user' && t.assignedToUid===curUser.uid);
                    if(t.createdByUid === curUser.uid || isAssignedToMe || canSeeAllTasks()) { 
                        allTasksCache[t.id] = t; 
                    }
                });
                renderTasksToPage(); 
            });
        }

        window.openTaskModal = async (editId = null) => {
            document.getElementById('form-task').reset(); 
            document.getElementById('t-id').value = '';
            setStars(0);
            
            const userSelect = document.getElementById('t-user'); userSelect.innerHTML = '';
            allUsersCache.forEach(u => { 
                if(u.uid !== curUser.uid && !isHiddenUser(u))
                    userSelect.innerHTML += `<option value="${u.uid}" data-role="${u.roles}">${u.name}</option>`; 
            });

            if(editId) {
                const t = allTasksCache[editId];
                if(t) {
                    document.getElementById('t-id').value = editId;
                    document.getElementById('t-title').value = t.title;
                    document.getElementById('t-desc').value = t.description;
                    document.getElementById('t-deadline').value = t.deadline || '';
                    setStars(t.importance || 0);
                    document.getElementById('t-type').value = t.assignedType;
                    togT(t.assignedType);
                    setTimeout(() => {
                        if(t.assignedType === 'department') document.getElementById('t-dept').value = t.assignedTo;
                        if(t.assignedType === 'user') document.getElementById('t-user').value = t.assignedToUid;
                    }, 100);
                }
            } else {
                 document.getElementById('t-type').value = 'department';
                 togT('department');
            }

            bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-task')).show(); pushState();
        };

        window.openTaskDetail = (tid) => {
            const t = allTasksCache[tid]; if(!t) return;
            document.getElementById('td-title').innerText = t.title;
            document.getElementById('td-meta').innerHTML = formatDeadline(t.deadline);

            let assigneesHtml = '';
            if(t.assignedType === 'user' && t.assignedToUid) {
                 const u = allUsersCache.find(x => x.uid === t.assignedToUid);
                 const p = u ? u.photoURL : 'https://ui-avatars.com/api/?name=U';
                 const n = u ? u.name : t.assignedTo;
                 assigneesHtml = `<div class="d-flex align-items-center gap-2 px-3 py-1 border border-secondary rounded"><img src="${p}" class="rounded-circle" width="25"><span class="small">${n}</span></div>`;
            } else { assigneesHtml = `<span class="badge bg-secondary">${t.assignedTo}</span>`; }
            document.getElementById('td-assignees').innerHTML = assigneesHtml;

            document.getElementById('td-desc').innerHTML = linkify(parseMD(t.description || 'A√ßƒ±klama yok.'));
            let starsHtml = ''; for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning me-1"></i>';
            document.getElementById('td-stars-wrapper').innerHTML = starsHtml; 
            
            const isAssignedToMe = (t.assignedType==='all' && t.createdByUid !== curUser.uid) || 
                                   (t.assignedType==='department' && uData.departments.includes(t.assignedTo) && t.createdByUid !== curUser.uid) || 
                                   (t.assignedType==='user' && t.assignedToUid===curUser.uid);
            
            const subArea = document.getElementById('td-submission-area');
            if(isAssignedToMe) {
                subArea.style.display = 'block';
                document.getElementById('t-submission-input').value = (t.submissions && t.submissions[curUser.uid]) ? t.submissions[curUser.uid] : '';
                document.getElementById('t-submission-input').dataset.tid = t.id;
            } else {
                subArea.style.display = 'none';
            }

            const list = document.getElementById('td-status-list'); list.innerHTML = '';
            let expectedUsers = [];
            
            if (t.assignedType === 'all') {
                expectedUsers = allUsersCache.filter(u => !isHiddenUser(u) && u.uid !== t.createdByUid);
            } else if (t.assignedType === 'department') {
                expectedUsers = allUsersCache.filter(u => u.departments?.includes(t.assignedTo) && !isHiddenUser(u) && u.uid !== t.createdByUid);
            } else if (t.assignedType === 'user' && t.assignedToUid) {
                const u = allUsersCache.find(x => x.uid === t.assignedToUid);
                if(u) expectedUsers.push(u);
            }

            if (expectedUsers.length > 0) {
                expectedUsers.forEach(u => {
                    const status = (t.statusMap && t.statusMap[u.uid]) ? t.statusMap[u.uid] : 'pending';
                    const stText = status === 'pending' ? 'Ba≈ülamadƒ±' : (status === 'progress' ? 'Yapƒ±lƒ±yor' : 'Bitti');
                    const stColor = status === 'pending' ? 'text-secondary' : (status === 'progress' ? 'text-primary' : 'text-success');
                    
                    let submissionHtml = '';
                    if(t.submissions && t.submissions[u.uid]) {
                        submissionHtml = `<div class="mt-1 p-2 bg-dark rounded border border-secondary" style="font-size:11px; word-break: break-all; white-space: pre-wrap;">${linkify(t.submissions[u.uid])}</div>`;
                    }

                    list.innerHTML += `<div class="d-flex flex-column small border-bottom border-dark py-2">
                        <div class="d-flex justify-content-between align-items-center"><span>${u.name}</span><span class="fw-bold ${stColor}">${stText}</span></div>
                        ${submissionHtml}
                    </div>`;
                });
            } else {
                list.innerHTML = '<span class="text-muted small">Atanmƒ±≈ü kimse yok.</span>';
            }

            bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-task-detail')).show();
        };

        window.saveTaskSubmission = async () => {
            const inp = document.getElementById('t-submission-input');
            const tid = inp.dataset.tid;
            const text = inp.value.trim();
            if(!tid) return;

            try {
                await updateDoc(doc(db,"tasks",tid), { [`submissions.${curUser.uid}`]: text });
                showToast("Not/Link ba≈üarƒ±yla iletildi!");
                
                const m = bootstrap.Modal.getInstance(document.getElementById('modal-task-detail'));
                if(m) m.hide();
            } catch(e) {
                showToast("Kaydedilirken hata olu≈ütu.");
            }
        };

        window.setStars = (n) => { 
            const current = parseInt(document.getElementById('t-stars').value || 0);
            const newVal = (current === n) ? 0 : n; 
            document.getElementById('t-stars').value = newVal; 
            const stars = document.getElementById('star-select').getElementsByTagName('i'); 
            for(let i=0; i<5; i++) stars[i].className = i < newVal ? 'fas fa-star clickable' : 'far fa-star clickable'; 
        };

        window.saveTask = async () => {
            try {
                const editId = document.getElementById('t-id').value;
                const title = document.getElementById('t-title').value;
                const desc = document.getElementById('t-desc').value;
                const type = document.getElementById('t-type').value;
                const imp = parseInt(document.getElementById('t-stars').value);
                const deadline = document.getElementById('t-deadline').value;
                
                let to = "Herkes", uid = null;
                if(type === 'department') to = document.getElementById('t-dept').value;
                if(type === 'user') { 
                    const el = document.getElementById('t-user'); 
                    to = el.options[el.selectedIndex].text; 
                    uid = el.value; 
                }
                
                const taskData = { title, description: desc, assignedType: type, assignedTo: to, assignedToUid: uid, importance: imp, deadline: deadline };

                if(editId) {
                    await updateDoc(doc(db, "tasks", editId), taskData);
                    showToast("G√∂rev g√ºncellendi!");
                } else {
                    taskData.createdByUid = curUser.uid; taskData.creatorName = uData.name; taskData.creatorPhoto = uData.photoURL; taskData.createdAt = new Date(); taskData.statusMap = {};
                    if(type === 'user' && uid) { taskData.statusMap[uid] = 'pending'; }
                    const ref = await addDoc(collection(db,"tasks"), taskData);
                    const notifData = {text: `${uData.name} yeni bir g√∂rev ekledi: ${title}`, read:false, createdAt:new Date(), type:'task', linkId: ref.id};
                    if(type === 'all') { allUsersCache.forEach(u => { if(u.uid !== curUser.uid && !isHiddenUser(u)) addDoc(collection(db,"notifications"), {...notifData, to: u.uid}); }); } 
                    else if (type === 'department') { allUsersCache.forEach(u => { if(u.uid !== curUser.uid && u.departments.includes(to) && !isHiddenUser(u)) addDoc(collection(db,"notifications"), {...notifData, to: u.uid}); }); } 
                    else if (type === 'user' && uid && uid !== curUser.uid) { addDoc(collection(db,"notifications"), {...notifData, to: uid}); }
                }
                const m = bootstrap.Modal.getInstance(document.getElementById('modal-task'));
                if(m) m.hide();
                document.getElementById('form-task').reset();
                setStars(0);
            } catch(err) { showToast("Hata olu≈ütu: " + err.message); }
        };

        window.openStatusModal = (tid) => { selectedTaskForStatus = tid; bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-status')).show(); };
        
        window.updateTaskStatus = async (status) => { 
            if(!selectedTaskForStatus) return; 
            
            await updateDoc(doc(db,"tasks",selectedTaskForStatus), { [`statusMap.${curUser.uid}`]: status }); 
            
            const t = allTasksCache[selectedTaskForStatus];
            if(t && t.createdByUid !== curUser.uid) { 
                if(status === 'progress' || status === 'done') {
                    const statusTr = status === 'progress' ? 'Yapƒ±lƒ±yor' : 'Bitti';
                    addDoc(collection(db, "notifications"), {
                        to: t.createdByUid,
                        text: `${uData.name}, "${t.title}" g√∂revini ${statusTr} olarak i≈üaretledi.`,
                        read: false,
                        createdAt: new Date(),
                        type: 'task',
                        linkId: t.id
                    });
                }
            }

            const m = bootstrap.Modal.getInstance(document.getElementById('modal-status')); 
            if(m) m.hide(); 
        };
        
        window.filterTasks = (f, b) => { 
            taskRenderLimit = 20;
            document.querySelectorAll('#view-tasks .filter-btn').forEach(btn => btn.classList.remove('active')); 
            b.classList.add('active'); 
            renderTasksToPage(false); 
        };
        
        window.delTask=(id)=>{ customConfirm("G√∂revi silmek istediƒüine emin misin?", async () => await deleteDoc(doc(db,"tasks",id))); }

        function listenTeam() { 
            unsubTeam = onSnapshot(collection(db,"users"), s => { 
                allUsersCache = []; 
                s.forEach(d => { const u = d.data(); if(!u.isBanned) allUsersCache.push(u); }); 
                renderTeam(); renderTasksToPage();
            }); 
        }
        
        window.renderTeam = (filter='') => {
            const list = document.getElementById('team-list'); list.innerHTML = ''; const f = filter.toLowerCase();
            const groups = {}; DEPTS.forEach(d => groups[d] = []); groups["Diƒüer"] = [];
            
            allUsersCache.forEach(u => {
                if(isHiddenUser(u)) return;
                
                const searchStr = (u.name + ' ' + (u.roles||[]).join(' ') + ' ' + (u.departments||[]).map(d=>DEPT_ABBR[d]||d).join(' ')).toLowerCase();
                if(f && !searchStr.includes(f)) return;
                let placed = false;
                u.departments?.forEach(d => { if(DEPTS.includes(d)) { groups[d].push(u); placed=true; } });
                if(!placed) groups["Diƒüer"].push(u);
            });

            for (const [deptName, users] of Object.entries(groups)) {
                if (users.length === 0) continue;
                let uniqueUsers = [...new Set(users)]; 

                const roleWeights = { "Ba≈ükan": 1, "YK": 2, "YKY": 3, "√úye": 4 };
                const getWeight = (roles) => {
                    if (!roles || !roles.length) return 99;
                    return Math.min(...roles.map(r => roleWeights[r] || 99));
                };
                
                uniqueUsers.sort((a, b) => {
                    const wA = getWeight(a.roles);
                    const wB = getWeight(b.roles);
                    if (wA !== wB) return wA - wB; 
                    return (a.name || '').localeCompare(b.name || ''); 
                });

                list.innerHTML += `<div class="dept-header"><i class="fas fa-briefcase"></i> ${deptName}</div>`;
                const container = document.createElement('div'); container.className = 'dept-group';
                
                uniqueUsers.forEach(u => {
                    let badges = '';
                    u.roles?.forEach(r => badges += `<span class="role-badge border">${r}</span>`);
                    u.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); badges += `<span class="role-badge bg-dark border border-secondary text-muted">${abbr}</span>`; });
                    const canDelete = (canManageUsers() && u.uid !== curUser.uid);
                    container.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between p-2 mb-1 clickable" style="border-bottom:1px solid rgba(255,255,255,0.05)" onclick="openUserProfile('${u.uid}'); pushState()">
                        <div class="d-flex align-items-center gap-3"><img src="${u.photoURL}" class="rounded-circle" width="40" height="40"><div><div class="fw-bold" style="font-size:14px">${u.name}</div><div class="d-flex mt-1 gap-1">${badges}</div></div></div>
                        <div class="d-flex align-items-center gap-2">
                             ${canManageUsers() ? `<button class="btn btn-sm btn-dark text-warning border-secondary" onclick="event.stopPropagation();openUserEdit('${u.uid}'); pushState()"><i class="fas fa-edit"></i></button>` : ''}
                             <button class="btn btn-sm btn-outline-secondary rounded-3 py-1 px-2 text-white" onclick="event.stopPropagation();openChat('${[curUser.uid,u.uid].sort().join('_')}','${u.name}'); pushState()"><i class="far fa-paper-plane"></i></button>
                             ${canDelete ? `<button class="btn btn-sm btn-danger py-1 px-2" onclick="event.stopPropagation();deleteUser('${u.uid}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                });
                list.appendChild(container);
            }
        };

        window.openUserProfile = (uid) => {
            const u = allUsersCache.find(x => x.uid === uid); if(!u) return;
            document.getElementById('vp-img').src = u.photoURL;
            document.getElementById('vp-name').innerText = u.name;
            const bdg = document.getElementById('vp-badges'); bdg.innerHTML = '';
            u.roles?.forEach(r => bdg.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            u.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); bdg.innerHTML += `<span class="badge bg-dark border border-secondary text-muted">${abbr}</span>`; });
            
            // Diƒüer kullanƒ±cƒ±larƒ±n modallarƒ± i√ßin k√º√ß√ºk ID eklendi
            const extId = document.getElementById('vp-external-id');
            extId.innerHTML = `<i class="fas fa-fingerprint me-1"></i> ${u.uid} <i class="fas fa-copy ms-1"></i>`;
            extId.dataset.uid = u.uid;

            document.getElementById('vp-uni').innerText = u.university || 'Belirtilmemi≈ü';
            document.getElementById('vp-dept').innerText = u.uni_dept || 'Belirtilmemi≈ü';
            document.getElementById('vp-dob').innerText = (u.dob || '') ? (u.dob||'').split('-').reverse().join('.') : 'Belirtilmemi≈ü';
            document.getElementById('vp-address').innerText = (u.city && u.district) ? `${u.city} / ${u.district}` : 'Adres Girilmemi≈ü';
            document.getElementById('vp-phone').innerText = u.phone || 'Belirtilmemi≈ü';
            document.getElementById('vp-email').innerText = u.contactEmail || u.email || 'Belirtilmemi≈ü';

            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => { 
                const isAssigned = (t.assignedType==='all' && t.createdByUid !== uid) || 
                                   (t.assignedType==='department' && u.departments.includes(t.assignedTo) && t.createdByUid !== uid) || 
                                   (t.assignedType==='user' && t.assignedToUid===uid);
                if(isAssigned) {
                    total++;
                    if(t.statusMap && t.statusMap[uid] === 'done') done++;
                }
            });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('vp-rate').innerText = `%${rate}`;
            document.getElementById('vp-circle').style.strokeDashoffset = (163.36 * (100 - rate)) / 100;
            const socBox = document.getElementById('vp-socials'); socBox.innerHTML = '';
            
            if(u.socials) {
                if(u.socials.linkedin) socBox.innerHTML += `<a href="https://linkedin.com/in/${u.socials.linkedin}" target="_blank" class="text-secondary"><i class="fab fa-linkedin"></i></a>`;
                if(u.socials.instagram) socBox.innerHTML += `<a href="https://instagram.com/${u.socials.instagram}" target="_blank" class="text-secondary"><i class="fab fa-instagram"></i></a>`;
                if(u.socials.x) socBox.innerHTML += `<a href="https://x.com/${u.socials.x}" target="_blank" class="text-secondary"><i class="fab fa-twitter"></i></a>`;
                if(u.socials.tiktok) socBox.innerHTML += `<a href="https://tiktok.com/@${u.socials.tiktok}" target="_blank" class="text-secondary"><i class="fab fa-tiktok"></i></a>`;
                if(u.socials.youtube) socBox.innerHTML += `<a href="https://youtube.com/@${u.socials.youtube}" target="_blank" class="text-secondary"><i class="fab fa-youtube"></i></a>`;
                if(u.socials.kick) socBox.innerHTML += `<a href="https://kick.com/${u.socials.kick}" target="_blank" class="text-secondary"><i class="fab fa-kickstarter"></i></a>`;
            } else { socBox.innerHTML = '<small class="text-muted">Sosyal medya yok.</small>'; }
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-profile-view')).show();
        };

        window.deleteUser = async (uid) => { customConfirm("Kullanƒ±cƒ±yƒ± engellemek istiyor musun?", async () => await updateDoc(doc(db,"users",uid), { isBanned: true })); };
        window.openUserEdit = (uid) => {
            if(!canManageUsers()) return; selectedUserForEdit = uid; const u = allUsersCache.find(x => x.uid === uid);
            document.getElementById('ue-name').innerText = u.name;
            const rd = document.getElementById('ue-roles'); rd.innerHTML = ''; ROLES.forEach(r => { rd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${r}" ${u.roles?.includes(r)?'checked':''}><label class="form-check-label">${r}</label></div>`; });
            const dd = document.getElementById('ue-depts'); dd.innerHTML = ''; DEPTS.forEach(d => { dd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${d}" ${u.departments?.includes(d)?'checked':''}><label class="form-check-label">${d}</label></div>`; });
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-user-edit')).show();
        };
        window.saveUserEdit = async () => { const roles = Array.from(document.querySelectorAll('#ue-roles input:checked')).map(c=>c.value); const depts = Array.from(document.querySelectorAll('#ue-depts input:checked')).map(c=>c.value); await updateDoc(doc(db,"users",selectedUserForEdit), { roles, departments: depts }); const m = bootstrap.Modal.getInstance(document.getElementById('modal-user-edit')); if(m) m.hide(); };

        function listenChannelMeta() {
            if(unsubChannelMeta) unsubChannelMeta();
            unsubChannelMeta = onSnapshot(collection(db, "channelMeta"), s => {
                s.forEach(d => channelMetaCache[d.id] = d.data());
                renderChannelBadges();
            });
        }

        function renderChannelBadges() {
            if(!uData.readReceipts) return;
            document.querySelectorAll('.chat-badge-dot').forEach(el => el.remove());
            const items = document.querySelectorAll('[data-cid]');
            items.forEach(el => {
                const cid = el.getAttribute('data-cid');
                const lastMsgTime = channelMetaCache[cid]?.lastTime || 0;
                const myReadTime = uData.readReceipts[cid] || 0;
                if(lastMsgTime > myReadTime) {
                    el.innerHTML += `<div class="unread-dot chat-badge-dot" style="margin-left:auto;"></div>`;
                }
            });
        }

        function loadChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = `<div data-cid="Genel Sohbet" class="card-custom p-3 d-flex align-items-center mb-0 border border-secondary" onclick="openChat('Genel Sohbet','Genel Sohbet'); pushState()"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-hashtag"></i></div><div class="fw-bold">Sohbet</div></div>`;
            list.innerHTML += `<div data-cid="Business" class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-secondary" onclick="openChat('Business','Business'); pushState()"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-briefcase"></i></div><div class="fw-bold">Business</div></div>`;
            if(isBoard()) list.innerHTML += `<div data-cid="Y√∂netim Kurulu" class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-warning" onclick="openChat('Y√∂netim Kurulu','Y√∂netim Kurulu'); pushState()"><div class="bg-warning rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-crown text-black"></i></div><div class="fw-bold text-warning">Y√∂netim Kurulu</div></div>`;
            
            let sortedDepts = [...(canSeeAllChannels() ? DEPTS : (uData.departments || []))];
            if (isBoard() && uData.departments && uData.departments.length > 0) {
                const myDept = uData.departments[0];
                sortedDepts = sortedDepts.filter(d => d !== myDept); sortedDepts.unshift(myDept);
            }

            sortedDepts.forEach(d => { 
                const isMyDept = uData.departments?.includes(d) && isBoard();
                const style = isMyDept ? 'border: 1px solid #60a5fa !important; background: rgba(59, 130, 246, 0.1);' : 'border: 1px solid #0dcaf0;';
                list.innerHTML += `<div data-cid="${d}" class="card-custom p-3 d-flex align-items-center mb-0 mt-2" style="${style}" onclick="openChat('${d}','${d}'); pushState()"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-users text-info"></i></div><div class="fw-bold">${d}</div></div>`; 
            });
            renderChannelBadges(); 
        }

        function getChatDateLabel(seconds) {
            if (!seconds) return '';
            const d = new Date(seconds * 1000);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            const msgDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());

            if (msgDate.getTime() === today.getTime()) return "Bug√ºn";
            if (msgDate.getTime() === yesterday.getTime()) return "D√ºn";
            
            const months = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        window.openChat = (cid, title) => {
            activeChatId = cid; chatOpen = true; document.getElementById('chat-overlay-title').innerText = title;
            const body = document.getElementById('chat-overlay-body'); body.innerHTML = '';
            document.getElementById('chat-overlay').classList.add('open');
            chatRenderLimit = 30; 
            
            updateDoc(doc(db,"users",curUser.uid), { [`readReceipts.${cid}`]: Date.now() });
            uData.readReceipts[cid] = Date.now();
            renderChannelBadges();

            if(unsubChat) unsubChat();
            unsubChat = onSnapshot(query(collection(db,"messages"), where("channel","==",cid)), s => {
                let msgs = []; s.forEach(d => { const m = d.data(); if(!m.deletedFor || !m.deletedFor.includes(curUser.uid)) msgs.push({id:d.id, ...m}); });
                msgs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                currentChatSnapshot = msgs; 
                renderChatUI(true); 
            });
        };

        window.renderChatUI = (scrollToBottom = false) => {
            const body = document.getElementById('chat-overlay-body');
            const msgs = currentChatSnapshot;
            
            let html = '';
            let pinnedMsg = null;
            let lastDateLabel = null; 
            let isFirstDay = true;

            const msgsToRender = msgs.slice(-chatRenderLimit);

            if (msgs.length > chatRenderLimit) {
                html += `<div class="d-flex justify-content-center mb-3 mt-2"><button class="btn btn-sm btn-dark border-secondary text-info rounded-pill px-4 py-2" onclick="loadMoreChat()"><i class="fas fa-arrow-up me-2"></i>Eski Mesajlarƒ± Y√ºkle</button></div>`;
            }

            msgsToRender.forEach(m => {
                const me = m.senderId === curUser.uid;
                let content = m.text || '';
                if(m.isPinned) pinnedMsg = m; 
                
                let msgTime = m.createdAt?.seconds || (Date.now() / 1000);
                const dateLabel = getChatDateLabel(msgTime);
                
                if (dateLabel !== lastDateLabel) {
                    if (!isFirstDay) html += `</div>`; 
                    html += `<div class="day-container">
                                <div class="date-separator"><span class="date-separator-badge">${dateLabel}</span></div>`;
                    lastDateLabel = dateLabel;
                    isFirstDay = false;
                }

                content = linkify(parseMD(content)); 
                
                let specialTags = ['@Herkes'].concat(ROLES.map(r=>`@${r}`)).concat(DEPTS.map(d=>`@${d}`));
                specialTags.sort((a,b) => b.length - a.length); 
                
                specialTags.forEach(tag => {
                    if (content.includes(tag)) content = content.split(tag).join(`<span class="text-info fw-bold">${tag}</span>`);
                });

                const sortedUsers = [...allUsersCache].sort((a,b) => b.name.length - a.name.length);
                sortedUsers.forEach(u => { const tag = `@${u.name}`; if (content.includes(tag)) content = content.split(tag).join(`<span class="text-warning fw-bold">${tag}</span>`); });

                if(m.type === 'image') {
                    content = `<img src="${m.url}" class="chat-img" onclick="openImgViewer('${m.url}')">`;
                }
                
                let badgeHtml = '', senderPhoto = 'https://ui-avatars.com/api/?name=User';
                const sender = allUsersCache.find(u => u.uid === m.senderId);
                if(sender) {
                    senderPhoto = sender.photoURL;
                    sender.roles?.forEach(r => badgeHtml += `<span class="chat-badge cb-role">${r}</span>`);
                    sender.departments?.forEach(d => { badgeHtml += `<span class="chat-badge cb-dept">${DEPT_ABBR[d] || d.substring(0,3)}</span>`; });
                }

                let reactHtml = '';
                if(m.reactions) {
                    const counts = {}; Object.values(m.reactions).forEach(r => { counts[r.emoji] = (counts[r.emoji] || 0) + 1; });
                    Object.entries(counts).forEach(([em, count]) => { reactHtml += `<div class="reaction-pill" onclick="openReactionDetails('${m.id}'); event.stopPropagation();">${em} <span style="opacity:0.7">${count}</span></div>`; });
                }

                let replyHtml = '';
                if(m.replyTo) {
                    const rMsg = msgs.find(x => x.id === m.replyTo);
                    if(rMsg) {
                        const rText = rMsg.type === 'image' ? 'üì∏ Fotoƒüraf' : (rMsg.text || '').substring(0,30)+'...';
                        replyHtml = `<div class="replied-to-block" onclick="scrollToMsg('${m.replyTo}')"><div class="fw-bold" style="font-size:10px; color:var(--primary)"><i class="fas fa-reply me-1"></i>${rMsg.senderName} yanƒ±tlandƒ±</div>${parseMD(rText).replace(/<[^>]*>?/gm, '')}</div>`;
                    }
                }

                const safeM = JSON.stringify({id:m.id, senderId:m.senderId, text:m.text, isPinned: m.isPinned}).replace(/"/g, '&quot;');
                const nameColor = me ? '#fff' : getUserColor(m.senderId);

                html += `
                <div class="chat-row ${me?'right':'left'}" id="msg-${m.id}">
                    ${!me ? `<img src="${senderPhoto}" class="chat-avatar-img">` : ''}
                    <div class="msg-bubble ${me?'bubble-sent':'bubble-received'}"
                         oncontextmenu="handleMsgCtx(event, ${safeM}); return false;"
                         ontouchstart="startLongPress(event, ${safeM})" 
                         ontouchend="cancelLongPress()" 
                         ontouchmove="cancelLongPress()">
                        ${!me ? `<div class="sender-header"><span class="sender-name" style="color:${nameColor}">${m.senderName}</span>${badgeHtml}</div>` : ''}
                        ${replyHtml}
                        <div style="margin-top:2px;">${content}</div>
                        <div class="chat-meta">
                            ${m.isPinned ? '<i class="fas fa-thumbtack text-warning me-1"></i>' : ''}
                            ${m.isEdited ? '<span class="edited-label">d√ºzenlendi</span>' : ''}
                            ${m.createdAt?.seconds ? new Date(m.createdAt.seconds*1000).getHours() + ':' + String(new Date(m.createdAt.seconds*1000).getMinutes()).padStart(2,'0') : ''}
                        </div>
                    </div>
                </div>
                ${reactHtml ? `<div class="reaction-container ${me?'justify-content-end':'justify-content-start'}" style="margin-left:${!me?'45px':0}; margin-right:${me?'10px':0};">${reactHtml}</div>` : ''}`;
            });
            
            if (!isFirstDay) html += `</div>`; 
            
            const oldScrollHeight = body.scrollHeight;
            body.innerHTML = html; 
            
            if (scrollToBottom) {
                setTimeout(() => body.scrollTop = body.scrollHeight, 100);
            } else {
                body.scrollTop = body.scrollHeight - oldScrollHeight; 
            }
            
            currentChatMsgs = msgsToRender; 

            const pBar = document.getElementById('pinned-msg-bar');
            if(pinnedMsg) {
                document.getElementById('pinned-msg-text').innerText = (pinnedMsg.senderName + ': ' + (pinnedMsg.text || 'Fotoƒüraf')).substring(0, 40) + '...';
                pBar.style.display = 'flex';
                pBar.onclick = () => scrollToMsg(pinnedMsg.id);
            } else {
                pBar.style.display = 'none';
            }

            if (pendingScrollMsgId) {
                setTimeout(() => {
                    scrollToMsg(pendingScrollMsgId);
                    pendingScrollMsgId = null;
                }, 400);
            }
        };
        
        window.loadMoreChat = () => {
            chatRenderLimit += 50;
            renderChatUI(false); 
        };

        window.scrollToMsg = (id, attempts = 10) => {
            const el = document.getElementById('msg-' + id);
            if(el) { 
                el.scrollIntoView({behavior: "smooth", block: "center"}); 
                el.classList.add('highlight'); 
                setTimeout(()=>el.classList.remove('highlight'), 2000); 
            } else if(attempts > 0) {
                setTimeout(() => window.scrollToMsg(id, attempts - 1), 200);
            }
        };

        window.closeChat = () => { 
            document.getElementById('chat-overlay').classList.remove('open'); chatOpen = false; if(unsubChat) unsubChat(); activeChatId = null; 
            cancelReply();
        };

        const ctx = document.getElementById('context-menu');
        window.startLongPress = (e, msg) => { longPressTimer = setTimeout(() => handleMsgCtx(e.touches[0], msg), 800); };
        window.cancelLongPress = () => { if(longPressTimer) clearTimeout(longPressTimer); };

        window.handleMsgCtx = (e, msg) => {
            if(window.navigator.vibrate) window.navigator.vibrate(50);
            selectedMsg = msg; let html = ''; const isMine = msg.senderId === curUser.uid;
            
            html += `<div class="ctx-item text-primary" onclick="replyToMsg()"><i class="fas fa-reply"></i> Yanƒ±tla</div>`;
            
            if(msg.text) {
                html += `<div class="ctx-item text-light" onclick="copyMsg()"><i class="fas fa-copy"></i> Kopyala</div>`;
            }

            html += `<div class="ctx-item text-warning" onclick="togglePinMsg()"><i class="fas fa-thumbtack"></i> ${msg.isPinned ? 'Sabitlemeyi Kaldƒ±r' : 'Sohbete Sabitle'}</div>`; 
            
            const fullMsg = currentChatMsgs?.find(x => x.id === msg.id);
            if (fullMsg && fullMsg.reactions && Object.keys(fullMsg.reactions).length > 0) {
                html += `<div class="ctx-item text-info" onclick="openReactionDetails('${msg.id}')"><i class="fas fa-smile"></i> Tepki Verenler</div>`;
            }

            if(isMine) html += `<div class="ctx-item" onclick="editMsg()"><i class="fas fa-pen"></i> D√ºzenle</div>`;
            if(isMine || isAdmin()) html += `<div class="ctx-item delete" onclick="deleteMsg('all')"><i class="fas fa-trash"></i> Herkes i√ßin Sil</div>`;
            html += `<div class="ctx-item delete" onclick="deleteMsg('me')"><i class="fas fa-trash-alt"></i> Benden Sil</div>`;
            document.getElementById('ctx-options').innerHTML = html;
            
            ctx.style.display='flex';
            let x = e.clientX, y = e.clientY;
            if (x + ctx.offsetWidth > window.innerWidth) x = window.innerWidth - ctx.offsetWidth - 10;
            if (y + ctx.offsetHeight > window.innerHeight) y = e.clientY - ctx.offsetHeight;
            ctx.style.top = y + 'px'; ctx.style.left = x + 'px';
        };
        document.addEventListener('click', (e)=>{if(!ctx.contains(e.target))ctx.style.display='none';});
        
        window.replyToMsg = () => {
            ctx.style.display='none'; currentReplyToId = selectedMsg.id;
            document.getElementById('reply-preview-bar').style.display = 'flex';
            
            const fullMsg = currentChatMsgs?.find(x => x.id === selectedMsg.id);
            let pText = 'üì∏ Fotoƒüraf';
            if(fullMsg) {
                if(fullMsg.text) pText = fullMsg.text;
            }
            
            document.getElementById('reply-preview-text').innerText = pText;
            document.getElementById('chat-input').focus();
        };
        window.cancelReply = () => { currentReplyToId = null; document.getElementById('reply-preview-bar').style.display = 'none'; };
        
        window.togglePinMsg = async () => {
            ctx.style.display='none';
            await updateDoc(doc(db,"messages",selectedMsg.id), { isPinned: !selectedMsg.isPinned });
        };

        window.copyMsg = () => {
            ctx.style.display='none';
            if(!selectedMsg || !selectedMsg.text) return;
            const ta = document.createElement('textarea');
            ta.value = selectedMsg.text;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast("Mesaj panoya kopyalandƒ±!");
            } catch(e) {
                showToast("Kopyalama ba≈üarƒ±sƒ±z oldu.");
            }
            document.body.removeChild(ta);
        };

        window.addReaction = async (emoji, msgId = null) => { 
            ctx.style.display='none'; 
            const targetId = msgId || selectedMsg?.id;
            if(!targetId) return; 

            const targetMsg = currentChatMsgs?.find(x => x.id === targetId);
            if(!targetMsg) return;

            const c = targetMsg.reactions || {}; 
            if(c[curUser.uid] && c[curUser.uid].emoji === emoji) {
                await updateDoc(doc(db,"messages",targetId),{[`reactions.${curUser.uid}`]:deleteField()}); 
            } else {
                await updateDoc(doc(db,"messages",targetId),{[`reactions.${curUser.uid}`]:{emoji,name:uData.name,uid:curUser.uid}}); 
            }
        };

        window.openReactionDetails = (mid) => { 
            ctx.style.display='none';
            const m = currentChatMsgs?.find(x=>x.id===mid); 
            if(!m?.reactions) return; 
            const l=document.getElementById('reaction-list'); l.innerHTML=''; 
            Object.values(m.reactions).forEach(r=>{ 
                const u=allUsersCache.find(x=>x.uid===r.uid); 
                l.innerHTML+=`<div class="d-flex align-items-center justify-content-between border-bottom border-dark py-2"><div class="d-flex align-items-center gap-2"><img src="${u?.photoURL}" class="rounded-circle" width="25"><span>${r.name}</span></div><span class="fs-5">${r.emoji}</span></div>`; 
            }); 
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-reactions')).show(); 
        };

        window.deleteMsg = async (t) => { ctx.style.display='none'; if(t==='all'){ customConfirm("Herkesden sil?",async()=>await deleteDoc(doc(db,"messages",selectedMsg.id))); } else { await updateDoc(doc(db,"messages",selectedMsg.id),{deletedFor:arrayUnion(curUser.uid)}); showToast("Silindi."); } };
        window.editMsg = () => { ctx.style.display='none'; document.getElementById('edit-msg-input').value=selectedMsg.text; bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-edit-msg')).show(); };
        window.submitEditMsg = async () => { await updateDoc(doc(db,"messages",selectedMsg.id),{text:document.getElementById('edit-msg-input').value,isEdited:true}); const m = bootstrap.Modal.getInstance(document.getElementById('modal-edit-msg')); if(m) m.hide(); };
        
        document.getElementById('chat-file-inp').addEventListener('change', async e => { 
            const files = e.target.files; 
            if(!files || files.length === 0) return; 

            let nonImageCount = 0;
            let imageCount = 0;

            showToast(`${files.length} dosya i≈üleniyor...`);

            for(let i = 0; i < files.length; i++) {
                const f = files[i];
                
                if(f.type.startsWith('image/')) {
                    imageCount++;
                    await new Promise((resolve) => {
                        const r = new FileReader(); 
                        r.readAsDataURL(f); 
                        r.onload = (ev) => { 
                            const img = new Image(); img.src = ev.target.result; 
                            img.onload = async () => { 
                                const c = document.createElement('canvas'); const x = c.getContext('2d'); 
                                let w = img.width, h = img.height, m = 800; 
                                if(w > h){if(w > m){h *= m/w; w = m;}} else {if(h > m){w *= m/h; h = m;}} 
                                c.width = w; c.height = h; x.drawImage(img, 0, 0, w, h); 
                                
                                try {
                                    await addDoc(collection(db,"messages"),{type:'image',url:c.toDataURL('image/jpeg',0.6),channel:activeChatId,senderId:curUser.uid,senderName:uData.name,createdAt:new Date(), replyTo: currentReplyToId}); 
                                    setDoc(doc(db, "channelMeta", activeChatId), { lastTime: Date.now() }, {merge:true});
                                } catch(err) {
                                    console.error("G√∂rsel y√ºklenemedi:", err);
                                }
                                resolve(); 
                            };
                            img.onerror = () => resolve(); 
                        };
                    });
                } else {
                    nonImageCount++;
                }
            }

            document.getElementById('chat-file-inp').value = '';
            cancelReply();

            if (nonImageCount > 0) {
                customConfirm(`Se√ßtiƒüiniz ${files.length} dosyanƒ±n ${nonImageCount} tanesi fotoƒüraf deƒüildi. Sadece fotoƒüraflar g√∂nderildi. Belge payla≈üƒ±mlarƒ± i√ßin l√ºtfen Drive vb. linkleri kullanƒ±n.`, () => {});
            } else if (imageCount > 0) {
                showToast(`${imageCount} fotoƒüraf ba≈üarƒ±yla g√∂nderildi!`);
            }
        });
        
        const vImg = document.getElementById('img-viewer'); const vImgSrc = document.getElementById('img-viewer-src');
        let sc=1, pX=0, pY=0, sX=0, sY=0, lDist=0, isP=false;
        vImg.addEventListener('touchstart', e => {
            if(e.touches.length===2) { isP=false; lDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY); } 
            else if(e.touches.length===1 && sc>1) { isP=true; sX=e.touches[0].pageX-pX; sY=e.touches[0].pageY-pY; }
        });
        vImg.addEventListener('touchmove', e => {
            if(e.touches.length===2) {
                let dist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
                sc = Math.min(Math.max(1, sc + (dist-lDist)*0.015), 4); lDist=dist; setTrans(); e.preventDefault();
            } else if(isP && e.touches.length===1 && sc>1) { pX=e.touches[0].pageX-sX; pY=e.touches[0].pageY-sY; setTrans(); e.preventDefault(); }
        });
        vImg.addEventListener('touchend', () => isP=false);
        function setTrans() { vImgSrc.style.transform = `translate(${pX}px, ${pY}px) scale(${sc})`; }
        
        window.closeImgViewer=()=>{ vImg.style.display='none'; sc=1;pX=0;pY=0; setTrans(); };
        window.openImgViewer=(src)=>{ vImgSrc.src=src; vImg.style.display='flex'; sc=1;pX=0;pY=0; setTrans(); };


        window.switchLB = (mode, el) => { lbMode = mode; document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); openLeaderboard(true); };
        window.openLeaderboard = (refresh = false) => {
            const list = document.getElementById('lb-list'); list.innerHTML = ''; const scores = []; const { start, end } = getWeekRange();
            allUsersCache.forEach(u => {
                if(isHiddenUser(u)) return;

                if(lbMode !== 'herkes' && !isAdmin() && !u.departments.some(d => uData.departments.includes(d))) return;
                
                let total = 0, done = 0;
                Object.values(allTasksCache).forEach(t => {
                    if(lbMode === 'haftalik') { const tDate = t.createdAt.toDate(); if(tDate < start || tDate > end) return; }
                    
                    const isAssigned = (t.assignedType==='all' && t.createdByUid !== u.uid) || 
                                       (t.assignedType==='department' && u.departments.includes(t.assignedTo) && t.createdByUid !== u.uid) || 
                                       (t.assignedType==='user' && t.assignedToUid===u.uid);
                    if(isAssigned) {
                        total++;
                        if(t.statusMap && t.statusMap[u.uid] === 'done') done++;
                    } 
                });
                if(total > 0 || isAdmin()) scores.push({ ...u, rate: total===0?0:(done/total)*100, done, total });
            });
            scores.sort((a,b) => b.rate - a.rate);
            if(scores.length === 0) list.innerHTML = '<div class="text-center text-muted mt-3">Veri yok.</div>';
            scores.forEach((s, idx) => { list.innerHTML += `<div class="d-flex align-items-center justify-content-between p-2 border-bottom border-secondary"><div class="d-flex align-items-center gap-3"><div class="fw-bold" style="width:20px;">${idx+1}</div><img src="${s.photoURL}" class="rounded-circle" width="35"><div><div class="fw-bold small">${s.name}</div><div class="text-muted" style="font-size:10px">${s.done}/${s.total} G√∂rev</div></div></div><div class="fw-bold text-success">%${Math.round(s.rate)}</div></div>`; });
            if(!refresh) bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-leaderboard')).show(); pushState();
        };

        window.goTab = (t,b) => { document.getElementById('page-title').innerText = {'tasks':'G√∂rev Panosu','messages':'Sohbetler','team':'Ekip Listesi','profile':'Profilim'}[t]; document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); };
        
        const chatInputEl = document.getElementById('chat-input');
        const mentionMenu = document.getElementById('mention-menu');
        
        chatInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });

        let currentMentionSearch = null;

        chatInputEl.addEventListener('input', function() {
            this.style.height = '45px';
            this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + 'px';

            const val = this.value;
            const cursorPos = this.selectionStart;
            const textBefore = val.substring(0, cursorPos);
            
            const match = textBefore.match(/@([a-zA-Zƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á\s]*)$/);
            
            if (match) {
                currentMentionSearch = match[1].toLowerCase();
                renderMentionMenu(currentMentionSearch);
            } else {
                currentMentionSearch = null;
                mentionMenu.style.display = 'none';
            }
        });

        function renderMentionMenu(search) {
            mentionMenu.innerHTML = '';
            let count = 0;

            const addOption = (title, subtitle, iconHtml, insertText) => {
                count++;
                mentionMenu.innerHTML += `
                <div class="mention-item" onclick="insertMention('${insertText}')">
                    ${iconHtml}
                    <div>
                        <div class="mention-title">${title}</div>
                        ${subtitle ? `<div class="mention-sub">${subtitle}</div>` : ''}
                    </div>
                </div>`;
            };

            if ("herkes".includes(search)) addOption("Herkes", "T√ºm odayƒ± etiketle", '<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:25px;height:25px;font-size:10px"><i class="fas fa-bullhorn"></i></div>', 'Herkes');

            ROLES.forEach(r => {
                if(r.toLowerCase().includes(search)) addOption(r, "Bu role sahip herkes", '<div class="rounded-circle bg-warning text-dark d-flex align-items-center justify-content-center" style="width:25px;height:25px;font-size:10px"><i class="fas fa-id-badge"></i></div>', r);
            });

            DEPTS.forEach(d => {
                if(d.toLowerCase().includes(search)) addOption(d, "Bu departmandaki herkes", '<div class="rounded-circle bg-info text-dark d-flex align-items-center justify-content-center" style="width:25px;height:25px;font-size:10px"><i class="fas fa-users"></i></div>', d);
            });

            const sortedUsers = [...allUsersCache].sort((a,b) => a.name.localeCompare(b.name));
            sortedUsers.forEach(u => {
                if (isHiddenUser(u)) return; 
                if (u.name.toLowerCase().includes(search)) {
                    let deptStr = u.departments && u.departments.length > 0 ? DEPT_ABBR[u.departments[0]] || u.departments[0] : '';
                    let roleStr = u.roles && u.roles.length > 0 ? u.roles[0] : '';
                    addOption(u.name, `${roleStr} ‚Ä¢ ${deptStr}`, `<img src="${u.photoURL}">`, u.name);
                }
            });

            mentionMenu.style.display = count > 0 ? 'block' : 'none';
        }

        window.insertMention = (text) => {
            const val = chatInputEl.value;
            const cursorPos = chatInputEl.selectionStart;
            const textBefore = val.substring(0, cursorPos);
            const textAfter = val.substring(cursorPos);
            
            const lastAtIndex = textBefore.lastIndexOf('@');
            if (lastAtIndex !== -1) {
                const newTextBefore = textBefore.substring(0, lastAtIndex) + '@' + text + ' ';
                chatInputEl.value = newTextBefore + textAfter;
                chatInputEl.focus();
                chatInputEl.selectionEnd = newTextBefore.length;
            }
            mentionMenu.style.display = 'none';
        };

        document.getElementById('chat-form').addEventListener('submit',async e=>{
            e.preventDefault(); const t=document.getElementById('chat-input').value.trim(); if(!t)return; 
            
            const msgRef = await addDoc(collection(db,"messages"),{text:t, type:'text', channel:activeChatId,senderId:curUser.uid,senderName:uData.name,createdAt:new Date(), replyTo: currentReplyToId}); 
            
            setDoc(doc(db, "channelMeta", activeChatId), { lastTime: Date.now() }, {merge:true});
            updateDoc(doc(db,"users",curUser.uid), { [`readReceipts.${activeChatId}`]: Date.now() });

            const channelName = document.getElementById('chat-overlay-title').innerText;
            const txtLower = t.toLowerCase();
            let taggedUids = new Set();

            if (txtLower.includes('@herkes')) {
                allUsersCache.forEach(u => { if(u.uid !== curUser.uid && !isHiddenUser(u)) taggedUids.add(u.uid); });
            } else {
                const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const checkTag = (tag) => {
                    const regex = new RegExp(`@${escapeRegExp(tag.toLowerCase())}(?![a-zƒü√º≈üƒ±√∂√ß])`, 'i');
                    return regex.test(txtLower);
                };

                allUsersCache.forEach(u => {
                    if (u.uid === curUser.uid || isHiddenUser(u)) return;
                    if (checkTag(u.name)) taggedUids.add(u.uid);
                    u.roles?.forEach(r => { if(checkTag(r)) taggedUids.add(u.uid); });
                    u.departments?.forEach(d => { if(checkTag(d)) taggedUids.add(u.uid); });
                });
            }

            taggedUids.forEach(uid => {
                addDoc(collection(db, "notifications"), {
                    to: uid,
                    text: `${uData.name} senden "${channelName}" grubunda bahsetti!`,
                    read: false,
                    createdAt: new Date(),
                    type: 'chat_tag',
                    linkId: activeChatId,
                    linkTitle: channelName,
                    targetMsgId: msgRef.id 
                });
            });
            
            cancelReply();
            document.getElementById('chat-input').value=''; 
            chatInputEl.style.height = '45px'; 
        });
        
        function listenNotifs(){ unsubNotif = onSnapshot(query(collection(db,"notifications"),where("to","==",curUser.uid),where("read","==",false)), s=>{ document.getElementById('notif-dot').style.display=s.empty?'none':'block'; }); }
        
        window.handleNotifClick = async (type, linkId, linkTitle, targetMsgId) => {
            const m = bootstrap.Modal.getInstance(document.getElementById('modal-notif'));
            if(m) m.hide();
            
            if(type === 'task' && linkId) { 
                if(!allTasksCache[linkId]) { try { const snap = await getDoc(doc(db,"tasks",linkId)); if(snap.exists()) { allTasksCache[linkId] = {id: snap.id, ...snap.data()}; openTaskDetail(linkId); } } catch(e) {} } else { openTaskDetail(linkId); } pushState(); 
            } 
            else if(type === 'chat' || type === 'chat_tag') { 
                if(type === 'chat') { 
                    const u = allUsersCache.find(x => x.uid === linkId); if(u) { openChat([curUser.uid, linkId].sort().join('_'), u.name); pushState(); } 
                } else { 
                    if (targetMsgId && targetMsgId !== 'undefined') pendingScrollMsgId = targetMsgId;
                    openChat(linkId, linkTitle || 'Sohbet'); 
                    pushState(); 
                } 
            }
        };

        window.openNotifs=async()=>{ 
            const md = bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-notif')); md.show(); pushState(); const l=document.getElementById('notif-list'); l.innerHTML='...'; 
            const q = query(collection(db,"notifications"), where("to","==",curUser.uid)); const s=await getDocs(q); const n=[]; s.forEach(d=>n.push({id:d.id,...d.data()})); n.sort((a,b)=>b.createdAt-a.createdAt); 
            l.innerHTML=''; if(n.length===0)l.innerHTML='<div class="text-center p-3 text-muted">Yok.</div>'; 
            n.forEach(d=>{ 
                const safeTitle = (d.linkTitle || '').replace(/'/g, "\\'");
                const targetMsg = d.targetMsgId || '';
                l.innerHTML+=`<div class="p-3 border-bottom border-secondary clickable" onclick="handleNotifClick('${d.type}', '${d.linkId}', '${safeTitle}', '${targetMsg}')"><small class="fw-bold">${d.text}</small></div>`; 
                updateDoc(doc(db,"notifications",d.id),{read:true}); 
            }); 
            document.getElementById('notif-dot').style.display='none'; 
        };
        
        async function loadRecentDMs(){ 
            if(unsubDMs)unsubDMs(); 
            unsubDMs=onSnapshot(collection(db,"messages"),s=>{ 
                const pairs = new Map(); 
                s.forEach(d=>{ const m = d.data(); const c=m.channel; if(c&&c.includes('_')&&c.includes(curUser.uid)) { const other = c.split('_').find(x=>x!==curUser.uid); const time = m.createdAt?.seconds || 0; if(!pairs.has(other) || time > pairs.get(other)) pairs.set(other, time); }}); 
                const l=document.getElementById('dm-list'); l.innerHTML=''; 
                Array.from(pairs.entries()).sort((a,b) => b[1] - a[1]).forEach(([id, time])=>{ 
                    const u=allUsersCache.find(x=>x.uid===id); 
                    if(u && !isHiddenUser(u)) { 
                        const cid = [curUser.uid,id].sort().join('_'); 
                        const hasNew = (channelMetaCache[cid]?.lastTime || 0) > (uData.readReceipts[cid] || 0); 
                        l.innerHTML+=`<div data-cid="${cid}" class="card-custom p-3 d-flex align-items-center mb-0 mt-1 gap-3" onclick="openChat('${cid}','${u.name}');pushState()"><img src="${u.photoURL}" class="rounded-circle" width="40"><div><div class="fw-bold">${u.name}</div></div>${hasNew?`<div class="unread-dot chat-badge-dot" style="margin-left:auto;"></div>`:''}</div>`; 
                    }
                }); 
            }); 
        }
        
        window.logout = async () => { await signOut(auth); window.location.reload(); };

        document.getElementById('form-register').addEventListener('submit',async e=>{ e.preventDefault(); const n=document.getElementById('r-name').value, em=document.getElementById('r-email').value, ps=document.getElementById('r-pass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,ps); const p=`https://ui-avatars.com/api/?name=${n}&background=random&color=fff`; await setDoc(doc(db,"users",c.user.uid),{ uid:c.user.uid, name:n, email:em, photoURL:p, createdAt:new Date(), isBanned:false, roles: ['√úye'], departments: ['...'] }); await updateProfile(c.user,{displayName:n,photoURL:p}); } catch(err){ showToast(err.message) } });
        document.getElementById('form-login').addEventListener('submit',async e=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth,document.getElementById('l-email').value,document.getElementById('l-pass').value) } catch(err){ showToast("Hata: " + err.message); } });
        window.uploadPhoto=(i)=>{const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{const im=new Image();im.src=e.target.result;im.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=150/Math.max(im.width,im.height);c.width=im.width*s;c.height=im.height*s;x.drawImage(im,0,0,c.width,c.height);const b=c.toDataURL('image/jpeg',0.7);updateDoc(doc(db,"users",curUser.uid),{photoURL:b}).then(()=>{uData.photoURL=b;loadProfile()})}};r.readAsDataURL(f);}
        
        window.aiSummarizeChat = async () => { 
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
            
            const todaysMsgs = currentChatMsgs.filter(x => x.createdAt?.seconds >= startOfToday);

            if(!todaysMsgs || todaysMsgs.length === 0) return showToast("Bug√ºn √∂zetlenecek mesaj yok."); 
            
            showToast("‚ú® AI bug√ºnk√º mesajlarƒ± okuyor..."); 
            try { 
                const txt = todaysMsgs.slice(-40).map(x => `${x.senderName}: ${x.text || '[Medya/Dosya]'}`).join('\n'); 
                const res = await fetchGemini(`A≈üaƒüƒ±daki bug√ºne ait sohbeti kƒ±saca √∂zetle:\n\n${txt}`); 
                const b = document.getElementById('chat-overlay-body'); 
                b.innerHTML += `
                <div class="text-center my-3 position-relative">
                    <span class="badge bg-dark border border-warning text-warning text-wrap text-start p-3 pe-4 shadow position-relative" style="max-width:90%; font-size:13px; line-height: 1.5;">
                        <i class="fas fa-times position-absolute top-0 end-0 m-2 fs-6 clickable" style="opacity:0.7" onclick="this.parentElement.parentElement.remove()" title="Kapat"></i>
                        <div class="fw-bold mb-2 fs-6">‚ú® G√ºn√ºn √ñzeti</div>
                        ${parseMD(res)}
                    </span>
                </div>`; 
                b.scrollTop = b.scrollHeight; 
            } catch(e) { 
                console.error("AI Baƒülantƒ± Hatasƒ±:", e);
                showToast("AI Hatasƒ±: L√ºtfen API anahtarƒ±nƒ±zƒ± g√ºncelleyin."); 
            } 
        };
    </script>
</body>
</html>
