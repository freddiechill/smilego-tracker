<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmileGO V6.0 - Ultimate Management</title>
    
    <script src="https://cdn.median.co/median.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400,300&display=swap" rel="stylesheet">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "2657219b-d29e-46e1-ac6f-68d2cdb8014d" });
      });
    </script>

    <style>
        :root { --bg-dark: #09090b; --nav-dark: #101012; --primary: #818cf8; --sent-bg: #4f46e5; --recv-bg: #27272a; }
        body { background-color: var(--bg-dark); font-family: 'Satoshi', sans-serif; color: #fff; height: 100vh; overflow: hidden; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        /* TIKLAMA GARANTİSİ */
        button, a, input, select, textarea, .card-custom, .nav-btn, .notif-btn, .msg-bubble, .clickable { cursor: pointer; pointer-events: auto !important; }

        .modal { z-index: 1000005 !important; }
        .modal-backdrop { z-index: 1000004 !important; }
        #context-menu { z-index: 1000006 !important; }
        
        .app-header { 
            height: 70px; position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; 
            z-index: 9999; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; 
        }
        .bottom-nav { 
            height: 85px; position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(16, 16, 18, 0.98); border-top: 1px solid #27272a; 
            z-index: 9999; display: flex; align-items: center; justify-content: space-around; padding-bottom: 15px; 
        }

        .main-content { 
            position: fixed; top: 70px; bottom: 85px; width: 100%; 
            overflow-y: auto; padding: 20px; display: none; z-index: 1; 
        }
        .main-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Helpers */
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .card-custom { background: #18181b; border: 1px solid #27272a; border-radius: 20px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition:0.2s; position: relative; }
        .card-custom:active { background: #202023; }
        .form-control, .form-select { background: #27272a; border: 1px solid #3f3f46; color: white; padding: 12px; border-radius: 12px; font-size: 14px; }
        .form-control:focus, .form-select:focus { background: #27272a; color: white; border-color: var(--primary); box-shadow: none; }
        .btn-primary-soft { background: var(--primary); color: #000; font-weight: 700; border-radius: 14px; border: none; padding: 14px; width: 100%; }
        
        /* CHAT */
        #chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: none; flex-direction: column; }
        #chat-overlay.open { display: flex; }
        .chat-body-scroll { flex: 1 1 auto; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #050505; }
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14.5px; position: relative; word-wrap: break-word; }
        .bubble-sent { background: var(--sent-bg); color: #fff; border-bottom-right-radius: 4px; margin-left: auto; }
        .bubble-received { background: var(--recv-bg); color: #fff; border-bottom-left-radius: 4px; margin-right: auto; }
        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }

        /* TASKS */
        .star-rating i { color: #fbbf24; font-size: 12px; margin-right: 1px; }
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .st-pending { background: rgba(255,255,255,0.1); color: #aaa; }
        .st-progress { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        
        /* PROFILE SOCIALS */
        .social-icon { font-size: 20px; width: 30px; text-align: center; }
        .si-linkedin { color: #0077b5; } .si-instagram { color: #e1306c; } .si-x { color: #fff; }
        .si-tiktok { color: #ff0050; } .si-youtube { color: #ff0000; } .si-kick { color: #53fc18; }

        /* LOADING & UTILS */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000007; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #img-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000000; display: none; align-items: center; justify-content: center; }
        #img-viewer img { max-width: 100%; max-height: 100%; }
        .nav-btn { background: none; border: none; color: #52525b; flex: 1; height: 100%; font-size: 24px; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); }
        .role-badge { font-size: 10px; padding: 3px 6px; border-radius: 4px; background: #333; color: #ccc; margin-left: 4px; }
        
        /* SEARCHABLE DROPDOWN SIMULATION */
        .search-list { max-height: 200px; overflow-y: auto; background: #202023; border: 1px solid #333; border-radius: 0 0 12px 12px; display: none; position: absolute; width: 100%; z-index: 1000; }
        .search-list div { padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2d; font-size: 13px; }
        .search-list div:hover { background: var(--primary); color: black; }

        .progress-ring { width: 60px; height: 60px; }
        .progress-ring__circle { transition: 0.35s stroke-dashoffset; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <div class="text-white mt-3 fw-bold" id="loading-text">Yükleniyor...</div>
    </div>

    <div id="img-viewer">
        <button style="position:absolute;top:40px;right:20px;background:none;border:none;color:white;font-size:30px;z-index:2000001" onclick="document.getElementById('img-viewer').style.display='none'"><i class="fas fa-times"></i></button>
        <img id="img-viewer-src" src="">
    </div>

    <div id="context-menu" style="position: fixed; background: #1c1c1e; border: 1px solid #333; border-radius: 12px; display: none; flex-direction: column; min-width: 160px; box-shadow: 0 4px 20px rgba(0,0,0,0.9);"></div>

    <div id="auth-screen">
        <div id="auth-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at top right, #312e81 0%, #09090b 60%);z-index:-1"></div>
        <div class="d-flex align-items-center justify-content-center h-100 w-100">
            <div class="glass-card">
                <div class="text-center mb-4"><img src="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/smilegologotracker.png" alt="SmileGO" style="width: 170px;"></div>
                <ul class="nav nav-pills nav-fill mb-4 bg-dark rounded p-1" style="border: 1px solid #333"><li class="nav-item"><a class="nav-link active rounded" data-bs-toggle="pill" href="#tab-login">Giriş</a></li><li class="nav-item"><a class="nav-link rounded" data-bs-toggle="pill" href="#tab-register">Kayıt</a></li></ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-login"><form id="form-login"><input type="email" id="l-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="l-pass" class="form-control mb-4" placeholder="Şifre" required><button class="btn-primary-soft">Giriş Yap</button></form></div>
                    <div class="tab-pane fade" id="tab-register"><form id="form-register"><input id="r-name" class="form-control mb-3" placeholder="Ad Soyad" required><input id="r-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="r-pass" class="form-control mb-3" placeholder="Şifre (min 6)" required><div class="text-muted small mb-2">Departman ve Rol Admin tarafından atanacaktır.</div><button class="btn-primary-soft">Kayıt Ol</button></form></div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <header class="app-header">
            <h5 class="m-0 fw-bold" id="page-title">Görev Panosu</h5>
            <div class="d-flex gap-3 align-items-center">
                <button class="notif-btn" onclick="openLeaderboard()"><i class="fas fa-trophy text-warning"></i></button>
                <button class="notif-btn" onclick="openNotifs()"><i class="fas fa-bell"></i><div id="notif-dot" class="notif-dot" style="position:absolute;top:0;right:0;width:8px;height:8px;background:red;border-radius:50%;display:none;"></div></button>
            </div>
        </header>

        <div id="view-tasks" class="main-content active">
            <button class="btn-primary-soft mb-4 shadow-sm" onclick="openTaskModal()"><i class="fas fa-plus me-2"></i> Yeni Görev Ekle</button>
            
            <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
                <button class="btn btn-sm btn-outline-secondary rounded-pill active" onclick="filterTasks('all', this)">Tümü</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterTasks('pending', this)">Başlamadı</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterTasks('progress', this)">Yapılıyor</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterTasks('done', this)">Bitti</button>
            </div>

            <div id="task-list" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="view-messages" class="main-content">
            <h6 class="text-muted small fw-bold mb-3 ls-1">GRUPLAR</h6>
            <div id="channel-list" class="d-flex flex-column gap-2 mb-4"></div>
            <h6 class="text-muted small fw-bold mb-3 ls-1">ÖZEL MESAJLAR</h6>
            <div id="dm-list" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="view-team" class="main-content">
            <input type="text" class="form-control mb-4" placeholder="Ekipte ara..." onkeyup="renderTeam(this.value)">
            <div id="team-list"></div>
        </div>

        <div id="view-profile" class="main-content">
            <div class="text-center">
                <div class="mb-3 position-relative d-inline-block">
                    <img id="prof-img" src="" class="rounded-circle border border-2 border-secondary p-1" width="110" height="110" style="object-fit: cover;">
                    <label for="file-inp" class="position-absolute bottom-0 end-0 bg-white text-dark rounded-circle d-flex align-items-center justify-content-center shadow" style="width:35px;height:35px;cursor:pointer"><i class="fas fa-camera small"></i></label>
                    <input type="file" id="file-inp" class="d-none" accept="image/*" onchange="uploadPhoto(this)">
                </div>
                <h4 id="prof-name" class="fw-bold mb-1">...</h4>
                <div id="prof-roles" class="d-flex justify-content-center gap-1 mb-2"></div>
                
                <div class="card-custom p-3 mt-3 d-flex align-items-center justify-content-between">
                    <div class="text-start">
                        <div class="text-muted small">Görev Başarımı</div>
                        <h4 class="fw-bold m-0" id="prof-rate">0%</h4>
                    </div>
                    <svg class="progress-ring" width="60" height="60">
                        <circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="prof-circle" stroke-dasharray="163.36" stroke-dashoffset="163.36"/>
                    </svg>
                </div>
            </div>

            <div class="card-custom mt-3">
                <h6 class="fw-bold text-muted mb-3">KİŞİSEL BİLGİLER</h6>
                
                <div class="mb-3 position-relative">
                    <label class="small text-muted">Üniversite</label>
                    <input type="text" class="form-control" id="inp-uni" placeholder="Üniversite Ara..." onkeyup="filterSearch('uni')">
                    <div class="search-list" id="list-uni"></div>
                </div>

                <div class="mb-3 position-relative">
                    <label class="small text-muted">Bölüm</label>
                    <input type="text" class="form-control" id="inp-sec" placeholder="Bölüm Ara..." onkeyup="filterSearch('sec')">
                    <div class="search-list" id="list-sec"></div>
                </div>

                <button class="btn btn-sm btn-success w-100" onclick="saveEduInfo()">Bilgileri Kaydet</button>
             </div>

             <div class="card-custom mt-2">
                <h6 class="fw-bold text-muted mb-3">SOSYAL MEDYA (Kullanıcı Adları)</h6>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-linkedin"></i></span><input id="sm-linkedin" class="form-control" placeholder="LinkedIn"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-instagram"></i></span><input id="sm-instagram" class="form-control" placeholder="Instagram"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-twitter"></i></span><input id="sm-x" class="form-control" placeholder="X (Twitter)"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-tiktok"></i></span><input id="sm-tiktok" class="form-control" placeholder="TikTok"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-youtube"></i></span><input id="sm-youtube" class="form-control" placeholder="YouTube"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-kickstarter"></i></span><input id="sm-kick" class="form-control" placeholder="Kick"></div>
                <button class="btn btn-sm btn-success w-100 mt-2" onclick="saveSocials()">Sosyal Medyayı Kaydet</button>
             </div>

             <div id="admin-zone" class="d-none mt-3">
                 <div class="card-custom border-danger">
                     <h6 class="text-danger fw-bold">YÖNETİCİ PANELİ</h6>
                     <p class="small text-muted">Kullanıcı düzenlemek için Ekip sayfasından kişiye tıklayın.</p>
                 </div>
             </div>

             <button class="btn btn-outline-danger w-100 mt-4 py-3 rounded-4 fw-bold" onclick="logout()">Çıkış Yap</button>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="goTab('tasks',this)"><i class="fas fa-check-circle"></i></button>
            <button class="nav-btn" onclick="goTab('messages',this)"><i class="fas fa-paper-plane"></i></button>
            <button class="nav-btn" onclick="goTab('team',this)"><i class="fas fa-users"></i></button>
            <button class="nav-btn" onclick="goTab('profile',this)"><i class="fas fa-user"></i></button>
        </nav>
    </div>

    <div id="chat-overlay">
        <div style="flex: 0 0 70px; background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; display: flex; align-items: center; padding: 0 20px;">
            <button class="btn text-white me-2 p-0" onclick="closeChat()"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h6 class="m-0 fw-bold text-white" id="chat-overlay-title">Sohbet</h6>
        </div>
        <div class="chat-body-scroll" id="chat-overlay-body"></div>
        <form id="chat-form" style="flex: 0 0 auto; background: var(--nav-dark); border-top: 1px solid #27272a; padding: 15px; padding-bottom: 25px; display: flex; gap: 10px;">
            <input type="file" id="chat-file-inp" hidden>
            <button type="button" class="btn btn-dark text-muted rounded-circle" style="width:45px;height:45px" onclick="document.getElementById('chat-file-inp').click()"><i class="fas fa-paperclip"></i></button>
            <input id="chat-input" class="form-control" placeholder="Mesaj yaz..." style="border-radius:20px" autocomplete="off">
            <button type="submit" class="btn btn-primary rounded-circle" style="width:45px;height:45px"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div class="modal fade" id="modal-task" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Yeni Görev</h5><form id="form-task">
        <input id="t-title" class="form-control mb-3" placeholder="Başlık" required>
        <textarea id="t-desc" class="form-control mb-3" placeholder="Açıklama" rows="3"></textarea>
        
        <label class="small text-muted mb-1">Önem Derecesi</label>
        <div class="mb-3 fs-4 text-warning" id="star-select">
            <i class="far fa-star clickable" onclick="setStars(1)"></i>
            <i class="far fa-star clickable" onclick="setStars(2)"></i>
            <i class="far fa-star clickable" onclick="setStars(3)"></i>
            <i class="far fa-star clickable" onclick="setStars(4)"></i>
            <i class="far fa-star clickable" onclick="setStars(5)"></i>
        </div>
        <input type="hidden" id="t-stars" value="0">

        <select id="t-type" class="form-select mb-3" onchange="togT(this.value)">
            <option value="department">Departman</option>
            <option value="user">Kişi</option>
            <option value="all">Herkes</option>
        </select>
        <select id="t-dept" class="form-select mb-3"></select>
        <select id="t-user" class="form-select mb-4 d-none"></select>
        <button class="btn-primary-soft">Oluştur</button>
    </form></div></div></div>

    <div class="modal fade" id="modal-user-edit" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3">
        <h5 class="fw-bold mb-3">Üye Düzenle (Admin)</h5>
        <h6 id="ue-name" class="text-primary mb-3"></h6>
        <div class="mb-2 small">Roller (Birden fazla seçilebilir)</div>
        <div id="ue-roles" class="d-flex flex-wrap gap-2 mb-3"></div>
        <div class="mb-2 small">Departmanlar (Birden fazla seçilebilir)</div>
        <div id="ue-depts" class="d-flex flex-wrap gap-2 mb-3"></div>
        <button class="btn btn-success w-100" onclick="saveUserEdit()">Kaydet</button>
    </div></div></div>

    <div class="modal fade" id="modal-leaderboard" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-0 overflow-hidden">
        <div class="bg-primary p-3 text-center"><h5 class="fw-bold m-0 text-black"><i class="fas fa-trophy me-2"></i>Sıralama</h5><small class="text-black opacity-75">Departman İçi Başarı</small></div>
        <div id="lb-list" class="p-3" style="max-height: 50vh; overflow-y: auto;"></div>
    </div></div></div>

    <div class="modal fade" id="modal-notif" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Bildirimler</h5><div id="notif-list" style="max-height:50vh;overflow-y:auto"></div></div></div></div>

    <div class="modal fade" id="modal-status" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content card-custom border-0 p-3 text-center">
        <h6 class="mb-3">Durum Güncelle</h6>
        <div class="d-grid gap-2">
            <button class="btn btn-outline-secondary" onclick="updateTaskStatus('pending')">Başlamadı</button>
            <button class="btn btn-outline-primary" onclick="updateTaskStatus('progress')">Yapılıyor</button>
            <button class="btn btn-outline-success" onclick="updateTaskStatus('done')">Bitti</button>
        </div>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, query, where, onSnapshot, orderBy, updateDoc, deleteDoc, getDocs, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDHbuPLeir2dn9BFI7Rt2AxUp_6E0VFy_8", authDomain: "smilego-tracker.firebaseapp.com", projectId: "smilego-tracker", storageBucket: "smilego-tracker.firebasestorage.app", messagingSenderId: "49933018016", appId: "1:49933018016:web:f69bf14464bfd4399a3ac5" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        // --- CONSTANTS & DATA ---
        const ADMIN_EMAIL = "yenerarda7@gmail.com";
        const DEPTS = ["Organizasyonel Gelişim","Sosyal Medya","Bölge Koordinatörlüğü","Psikolog İlişkileri","Data & Planlama","Kurumsal İletişim", "Yazılım"];
        const ROLES = ["Başkan", "YK", "YKY", "Üye", "Admin"];
        const UNIVERSITIES = ["Sakarya Üniversitesi", "Sakarya Uygulamalı Bilimler Üniversitesi", "İstanbul Üniversitesi", "ODTÜ", "İTÜ", "Boğaziçi Üniversitesi", "Marmara Üniversitesi", "Yıldız Teknik Üniversitesi", "Hacettepe Üniversitesi", "Ankara Üniversitesi", "Ege Üniversitesi", "Dokuz Eylül Üniversitesi", "Gazi Üniversitesi", "Anadolu Üniversitesi", "Akdeniz Üniversitesi", "Çukurova Üniversitesi", "Bilkent Üniversitesi", "Koç Üniversitesi", "Sabancı Üniversitesi", "Yeditepe Üniversitesi", "Bahçeşehir Üniversitesi"]; // Demo listesi, gerçekte çok daha uzun
        const DEPARTMENTS_UNI = ["İşletme", "Bilgisayar Mühendisliği", "Hukuk", "Tıp", "Psikoloji", "Mimarlık", "Endüstri Mühendisliği", "Makine Mühendisliği", "Elektrik-Elektronik Müh.", "İnşaat Mühendisliği", "Siyaset Bilimi", "Uluslararası İlişkiler", "Diş Hekimliği", "Eczacılık", "Hemşirelik", "Öğretmenlik", "Grafik Tasarım", "İletişim Tasarımı", "Sosyoloji", "Felsefe"]; // Demo

        let curUser=null, uData={}, activeChatId=null;
        let unsubUser=null, unsubTasks=null, unsubTeam=null, unsubChat=null, unsubNotif=null;
        let allUsersCache=[], allTasksCache={};
        let selectedTaskForStatus = null; // ID of task being updated
        let selectedUserForEdit = null; // UID for Admin edit

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async u => {
            if(u){
                curUser = u;
                unsubUser = onSnapshot(doc(db,"users",u.uid), s => {
                    if(s.exists()){
                        uData = s.data();
                        if(uData.isBanned) { signOut(auth); alert("Hesap erişimi engellendi."); return; }
                        // Geriye dönük uyumluluk (Array yapısı yoksa çevir)
                        if(!Array.isArray(uData.roles)) uData.roles = [uData.role || 'Üye'];
                        if(!Array.isArray(uData.departments)) uData.departments = [uData.department || '...'];
                        if(u.email === ADMIN_EMAIL && !uData.roles.includes('Admin')) uData.roles.push('Admin');
                        
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('app-screen').style.display = 'block';
                        initApp();
                    }
                });
                // OneSignal Login
                if(window.OneSignalDeferred) OneSignalDeferred.push(()=>OneSignal.login(u.uid));
            } else {
                cleanup();
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function initApp() {
            loadProfile();
            listenTasks();
            listenTeam();
            loadChannels();
            listenNotifs();
            loadRecentDMs();
            
            // Populate Selects
            const dSelect = document.getElementById('t-dept'); dSelect.innerHTML='';
            DEPTS.forEach(d => dSelect.innerHTML += `<option>${d}</option>`);
            
            // Check Admin Zone
            if(isAdminOrPres()) document.getElementById('admin-zone').classList.remove('d-none');
        }

        function cleanup() {
            if(unsubUser) unsubUser(); if(unsubTasks) unsubTasks(); 
            if(unsubTeam) unsubTeam(); if(unsubChat) unsubChat(); if(unsubNotif) unsubNotif();
            curUser=null; uData={};
        }

        const isAdmin = () => uData.roles?.includes('Admin');
        const isPres = () => uData.roles?.includes('Başkan');
        const isAdminOrPres = () => isAdmin() || isPres();
        const isBoard = () => uData.roles?.some(r => ['YK','YKY','Başkan','Admin'].includes(r));

        // --- PROFILE LOGIC ---
        window.loadProfile = () => {
            document.getElementById('prof-img').src = uData.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('prof-name').innerText = uData.name;
            
            const rDiv = document.getElementById('prof-roles'); rDiv.innerHTML='';
            uData.roles.forEach(r => rDiv.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            
            // Fill Inputs
            document.getElementById('inp-uni').value = uData.university || '';
            document.getElementById('inp-sec').value = uData.uni_dept || '';
            
            if(uData.socials) {
                ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => {
                    document.getElementById(`sm-${k}`).value = uData.socials[k] || '';
                });
            }

            calcSuccessRate();
        };

        window.calcSuccessRate = () => {
            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => {
                if(t.statusMap && t.statusMap[curUser.uid]) {
                    total++;
                    if(t.statusMap[curUser.uid] === 'done') done++;
                }
            });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('prof-rate').innerText = `%${rate}`;
            const circle = document.getElementById('prof-circle');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (rate / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        };

        window.saveEduInfo = async () => {
            const uni = document.getElementById('inp-uni').value;
            const sec = document.getElementById('inp-sec').value;
            await updateDoc(doc(db,"users",curUser.uid), { university: uni, uni_dept: sec });
            alert("Eğitim bilgileri güncellendi!");
        };

        window.saveSocials = async () => {
            const soc = {};
            ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => {
                const v = document.getElementById(`sm-${k}`).value.trim();
                if(v) soc[k] = v;
            });
            await updateDoc(doc(db,"users",curUser.uid), { socials: soc });
            alert("Sosyal medya güncellendi!");
        };

        // --- SEARCHABLE SELECT LOGIC ---
        window.filterSearch = (type) => {
            const inp = document.getElementById(`inp-${type}`);
            const list = document.getElementById(`list-${type}`);
            const val = inp.value.toLowerCase();
            const source = type === 'uni' ? UNIVERSITIES : DEPARTMENTS_UNI;
            
            list.innerHTML = '';
            if(val.length < 1) { list.style.display='none'; return; }
            
            const matches = source.filter(s => s.toLowerCase().includes(val));
            matches.forEach(m => {
                const d = document.createElement('div');
                d.innerText = m;
                d.onclick = () => { inp.value = m; list.style.display='none'; };
                list.appendChild(d);
            });
            list.style.display = matches.length ? 'block' : 'none';
        };

        // --- TASKS LOGIC ---
        function listenTasks() {
            if(unsubTasks) unsubTasks();
            unsubTasks = onSnapshot(collection(db,"tasks"), s => {
                const list = document.getElementById('task-list');
                list.innerHTML = '';
                allTasksCache = {};
                
                let tempArr = [];
                s.forEach(d => {
                    const t = { id: d.id, ...d.data() };
                    allTasksCache[t.id] = t;
                    
                    // Filter: Can I see this task?
                    // 1. I created it
                    // 2. Assigned to Me directly
                    // 3. Assigned to 'Herkes'
                    // 4. Assigned to one of my Departments
                    // 5. I am Admin/Pres
                    const isCreator = t.createdByUid === curUser.uid;
                    const isMine = t.assignedType === 'user' && t.assignedToUid === curUser.uid;
                    const isAll = t.assignedType === 'all';
                    const isMyDept = t.assignedType === 'department' && uData.departments?.includes(t.assignedTo);
                    
                    if(isCreator || isMine || isAll || isMyDept || isAdminOrPres()) {
                        tempArr.push(t);
                    }
                });

                tempArr.sort((a,b) => b.createdAt - a.createdAt);
                
                // RENDER
                const filter = document.querySelector('.btn-outline-secondary.active').innerText; // Tümü, Başlamadı vs.
                
                tempArr.forEach(t => {
                    // My Status
                    let myStatus = 'pending';
                    if(t.statusMap && t.statusMap[curUser.uid]) myStatus = t.statusMap[curUser.uid];
                    else if(t.statusMap && t.assignedType === 'user' && t.assignedToUid !== curUser.uid) {
                         // Viewing someone else's task
                         myStatus = Object.values(t.statusMap)[0];
                    }

                    // Filter UI
                    if(filter === 'Başlamadı' && myStatus !== 'pending') return;
                    if(filter === 'Yapılıyor' && myStatus !== 'progress') return;
                    if(filter === 'Bitti' && myStatus !== 'done') return;

                    // Star Rendering
                    let starsHtml = '';
                    for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning" style="font-size:10px"></i>';

                    // Status Badge Class
                    const stClass = myStatus === 'pending' ? 'st-pending' : (myStatus === 'progress' ? 'st-progress' : 'st-done');
                    const stText = myStatus === 'pending' ? 'Başlamadı' : (myStatus === 'progress' ? 'Yapılıyor' : 'Bitti');
                    
                    // Button Logic
                    const isAssignedToMe = (t.assignedType==='all') || (t.assignedType==='department' && uData.departments.includes(t.assignedTo)) || (t.assignedType==='user' && t.assignedToUid===curUser.uid);

                    list.innerHTML += `
                    <div class="card-custom">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="badge bg-dark border border-secondary text-muted">${t.assignedTo}</span>
                            <div>${starsHtml}</div>
                        </div>
                        <h6 class="fw-bold mb-1">${t.title}</h6>
                        <p class="text-muted small mb-2 text-truncate">${t.description || ''}</p>
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-2">
                                <img src="${t.creatorPhoto || 'https://ui-avatars.com/api/?name=User'}" class="rounded-circle" width="20">
                                <small class="text-muted" style="font-size:11px">${t.creatorName}</small>
                            </div>
                            ${isAssignedToMe ? 
                                `<button class="btn btn-sm status-badge ${stClass}" onclick="openStatusModal('${t.id}')">${stText}</button>` : 
                                `<span class="status-badge ${stClass}">${stText}</span>`
                            }
                        </div>
                        ${(t.createdByUid === curUser.uid || isAdminOrPres()) ? `<i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3" onclick="delTask('${t.id}')"></i>` : ''}
                    </div>`;
                });
                
                calcSuccessRate(); // Recalc profile stats
            });
        }

        window.openTaskModal = async () => {
            const userSelect = document.getElementById('t-user');
            userSelect.innerHTML = '';
            // Only Members logic not strictly enforced here but handled in submit
            const snap = await getDocs(collection(db,"users"));
            snap.forEach(d => {
                if(d.id !== curUser.uid) userSelect.innerHTML += `<option value="${d.id}" data-role="${d.data().roles}">${d.data().name}</option>`;
            });
            new bootstrap.Modal(document.getElementById('modal-task')).show();
        };

        window.setStars = (n) => {
            document.getElementById('t-stars').value = n;
            const container = document.getElementById('star-select');
            const stars = container.getElementsByTagName('i');
            for(let i=0; i<5; i++) {
                stars[i].className = i < n ? 'fas fa-star clickable' : 'far fa-star clickable';
            }
        };

        document.getElementById('form-task').addEventListener('submit', async e => {
            e.preventDefault();
            const title = document.getElementById('t-title').value;
            const desc = document.getElementById('t-desc').value;
            const type = document.getElementById('t-type').value;
            const imp = parseInt(document.getElementById('t-stars').value);
            let to = "Herkes", uid = null;
            
            // Restriction Logic: Members cannot assign to YK/Pres
            const myRoles = uData.roles;
            const isJustMember = myRoles.length === 1 && myRoles[0] === 'Üye';
            
            if(type === 'department') to = document.getElementById('t-dept').value;
            if(type === 'user') {
                const el = document.getElementById('t-user');
                to = el.options[el.selectedIndex].text;
                uid = el.value;
                const targetRoles = el.options[el.selectedIndex].getAttribute('data-role');
                
                if(isJustMember && (targetRoles.includes('YK') || targetRoles.includes('Başkan') || targetRoles.includes('YKY'))) {
                    alert("Üyeler YK veya Başkana görev atayamaz!");
                    return;
                }
            }

            // Init status for assigned user immediately if single user
            let initialStatusMap = {};
            if(type === 'user' && uid) initialStatusMap[uid] = 'pending';
            
            await addDoc(collection(db,"tasks"), {
                title, description: desc, assignedType: type, assignedTo: to, assignedToUid: uid,
                importance: imp, createdByUid: curUser.uid, creatorName: uData.name, creatorPhoto: uData.photoURL,
                createdAt: new Date(), statusMap: initialStatusMap
            });

            // Notification logic
            if(uid) sendNotif(uid, 'Yeni Görev', title, 'task', uid); // Simplification
            
            bootstrap.Modal.getInstance(document.getElementById('modal-task')).hide();
            e.target.reset(); setStars(0);
        });

        window.openStatusModal = (tid) => {
            selectedTaskForStatus = tid;
            new bootstrap.Modal(document.getElementById('modal-status')).show();
        };

        window.updateTaskStatus = async (status) => {
            if(!selectedTaskForStatus) return;
            // Update specific key in map: "statusMap.USER_ID"
            const updateKey = `statusMap.${curUser.uid}`;
            await updateDoc(doc(db,"tasks",selectedTaskForStatus), {
                [updateKey]: status
            });
            bootstrap.Modal.getInstance(document.getElementById('modal-status')).hide();
        };

        window.filterTasks = (filter, btn) => {
            document.querySelectorAll('#view-tasks .btn-outline-secondary').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Re-trigger render by essentially reloading (or just logic inside onSnapshot handles it if we store filter state)
            // For simplicity, just update UI text and let onSnapshot re-render next time or trigger reload
            // In this architecture, best to just store filter in a var and call render function.
            // But since onSnapshot is active, we can just hack it:
            if(unsubTasks) { unsubTasks(); listenTasks(); } // Poor man's re-render
        };

        // --- TEAM & ADMIN LOGIC ---
        function listenTeam() {
            unsubTeam = onSnapshot(collection(db,"users"), s => {
                allUsersCache = [];
                s.forEach(d => allUsersCache.push(d.data()));
                renderTeam();
            });
        }

        window.renderTeam = (filter='') => {
            const list = document.getElementById('team-list'); list.innerHTML = '';
            const f = filter.toLowerCase();
            
            allUsersCache.forEach(u => {
                if(!u.name.toLowerCase().includes(f)) return;
                
                // Badges
                let badges = '';
                u.roles?.forEach(r => badges += `<span class="role-badge border">${r}</span>`);
                u.departments?.forEach(d => badges += `<span class="role-badge bg-dark border border-secondary text-muted">${d.substring(0,3)}</span>`);

                const isAdminView = isAdminOrPres();
                
                list.innerHTML += `
                <div class="d-flex align-items-center justify-content-between p-3 border-bottom border-dark clickable" onclick="${isAdminView ? `openUserEdit('${u.uid}')` : `openChat('${[curUser.uid,u.uid].sort().join('_')}','${u.name}')`}">
                    <div class="d-flex align-items-center gap-3">
                        <img src="${u.photoURL}" class="rounded-circle" width="45" height="45" style="object-fit:cover">
                        <div>
                            <div class="fw-bold">${u.name}</div>
                            <div class="d-flex mt-1">${badges}</div>
                        </div>
                    </div>
                    ${u.socials?.linkedin ? `<i class="fab fa-linkedin text-primary"></i>` : ''}
                </div>`;
            });
        };

        // ADMIN EDIT USER
        window.openUserEdit = (uid) => {
            if(!isAdminOrPres()) return;
            selectedUserForEdit = uid;
            const u = allUsersCache.find(x => x.uid === uid);
            document.getElementById('ue-name').innerText = u.name;
            
            // Roles Checkboxes
            const rd = document.getElementById('ue-roles'); rd.innerHTML = '';
            ROLES.forEach(r => {
                const checked = u.roles?.includes(r) ? 'checked' : '';
                rd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${r}" ${checked}><label class="form-check-label">${r}</label></div>`;
            });

            // Depts Checkboxes
            const dd = document.getElementById('ue-depts'); dd.innerHTML = '';
            DEPTS.forEach(d => {
                const checked = u.departments?.includes(d) ? 'checked' : '';
                dd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${d}" ${checked}><label class="form-check-label">${d}</label></div>`;
            });

            new bootstrap.Modal(document.getElementById('modal-user-edit')).show();
        };

        window.saveUserEdit = async () => {
            const roles = Array.from(document.querySelectorAll('#ue-roles input:checked')).map(cb => cb.value);
            const depts = Array.from(document.querySelectorAll('#ue-depts input:checked')).map(cb => cb.value);
            
            await updateDoc(doc(db,"users",selectedUserForEdit), { roles, departments: depts });
            bootstrap.Modal.getInstance(document.getElementById('modal-user-edit')).hide();
        };

        // --- CHAT LOGIC ---
        function loadChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = `
            <div class="card-custom p-3 d-flex align-items-center mb-0" onclick="openChat('Sohbet','Genel Sohbet')">
                <div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-hashtag"></i></div>
                <div class="fw-bold">Sohbet</div>
            </div>
            <div class="card-custom p-3 d-flex align-items-center mb-0 mt-2" onclick="openChat('Business','Business')">
                <div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-briefcase"></i></div>
                <div class="fw-bold">Business</div>
            </div>`;

            if(isBoard()) {
                list.innerHTML += `
                <div class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-warning" onclick="openChat('Yonetim','Yönetim Kurulu')">
                    <div class="bg-warning rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-crown text-black"></i></div>
                    <div class="fw-bold text-warning">Yönetim Kurulu</div>
                </div>`;
            }
            
            // Dept Channels
            uData.departments?.forEach(d => {
                list.innerHTML += `
                <div class="card-custom p-3 d-flex align-items-center mb-0 mt-2" onclick="openChat('${d}','${d}')">
                    <div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-users text-info"></i></div>
                    <div class="fw-bold">${d}</div>
                </div>`;
            });
        }

        window.openChat = (cid, title) => {
            activeChatId = cid;
            document.getElementById('chat-overlay-title').innerText = title;
            const body = document.getElementById('chat-overlay-body');
            body.innerHTML = '';
            document.getElementById('chat-overlay').classList.add('open');
            
            if(unsubChat) unsubChat();
            const q = query(collection(db,"messages"), where("channel","==",cid), orderBy("createdAt","asc"));
            
            unsubChat = onSnapshot(q, s => {
                let html = '';
                s.forEach(d => {
                    const m = d.data();
                    const me = m.senderId === curUser.uid;
                    let content = m.text;
                    if(m.type === 'image') content = `<img src="${m.url}" class="chat-img" onclick="openImgViewer('${m.url}')">`;
                    
                    html += `<div class="d-flex w-100 mb-1 ${me?'justify-content-end':'justify-content-start'}">
                        <div class="msg-bubble ${me?'bubble-sent':'bubble-received'}">
                            ${!me ? `<small class="d-block fw-bold mb-1 text-warning" style="font-size:10px">${m.senderName}</small>` : ''}
                            ${content}
                            <div style="font-size:9px; opacity:0.6; text-align:right; margin-top:2px">${m.createdAt?.seconds ? new Date(m.createdAt.seconds*1000).getHours() + ':' + String(new Date(m.createdAt.seconds*1000).getMinutes()).padStart(2,'0') : ''}</div>
                        </div>
                    </div>`;
                });
                body.innerHTML = html;
                body.scrollTop = body.scrollHeight;
            });
        };

        window.closeChat = () => {
             document.getElementById('chat-overlay').classList.remove('open'); 
             if(unsubChat) unsubChat(); 
             activeChatId = null;
        };

        // --- IMAGE UPLOAD FIX (COMPRESSION + CHUNKING if needed, simpler Base64 Resize here) ---
        // Firestore 1MB limit workaround: Resize image to max 800px and 0.6 quality jpg
        document.getElementById('chat-file-inp').addEventListener('change', async e => {
            const f = e.target.files[0];
            if(!f || !activeChatId) return;
            
            // Show Spinner
            const btn = document.querySelector('#chat-form button[type=button]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const reader = new FileReader();
            reader.readAsDataURL(f);
            reader.onload = (ev) => {
                const img = new Image();
                img.src = ev.target.result;
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize logic
                    const MAX_W = 800;
                    const MAX_H = 800;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; } } 
                    else { if (h > MAX_H) { w *= MAX_H / h; h = MAX_H; } }
                    
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    // Compress to JPEG 0.6
                    const base64 = canvas.toDataURL('image/jpeg', 0.6); 
                    
                    // Upload
                    await addDoc(collection(db,"messages"), {
                        type: 'image', url: base64, channel: activeChatId, 
                        senderId: curUser.uid, senderName: uData.name, createdAt: new Date()
                    });
                    
                    btn.innerHTML = '<i class="fas fa-paperclip"></i>';
                    notifyChat(activeChatId);
                };
            };
        });

        // --- LEADERBOARD ---
        window.openLeaderboard = () => {
            const list = document.getElementById('lb-list');
            list.innerHTML = '';
            
            // Calculate scores for everyone
            const scores = [];
            allUsersCache.forEach(u => {
                let total = 0, done = 0;
                Object.values(allTasksCache).forEach(t => {
                    if(t.statusMap && t.statusMap[u.uid]) {
                        total++;
                        if(t.statusMap[u.uid] === 'done') done++;
                    }
                });
                const rate = total === 0 ? 0 : (done/total)*100;
                scores.push({ ...u, rate, done, total });
            });
            
            scores.sort((a,b) => b.rate - a.rate);
            
            scores.forEach((s, idx) => {
                // Only show my departments
                const sameDept = s.departments.some(d => uData.departments.includes(d));
                if(!sameDept && !isAdmin()) return;

                let color = idx === 0 ? 'gold' : (idx === 1 ? 'silver' : (idx===2 ? '#cd7f32' : 'white'));
                list.innerHTML += `
                <div class="d-flex align-items-center justify-content-between p-2 border-bottom border-secondary" style="background:${idx<3?'rgba(255,255,255,0.05)':''}">
                    <div class="d-flex align-items-center gap-3">
                        <div class="fw-bold" style="width:20px; color:${color}">${idx+1}</div>
                        <img src="${s.photoURL}" class="rounded-circle" width="35">
                        <div>
                            <div class="fw-bold small">${s.name}</div>
                            <div class="text-muted" style="font-size:10px">${s.done}/${s.total} Görev</div>
                        </div>
                    </div>
                    <div class="fw-bold text-success">%${Math.round(s.rate)}</div>
                </div>`;
            });
            new bootstrap.Modal(document.getElementById('modal-leaderboard')).show();
        };

        // --- UTILS ---
        window.goTab = (t,b) => {
            document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            b.classList.add('active');
        };
        
        window.togT=(v)=>{document.getElementById('t-dept').classList.toggle('d-none',v!=='department');document.getElementById('t-user').classList.toggle('d-none',v!=='user')};
        
        document.getElementById('chat-form').addEventListener('submit',async e=>{e.preventDefault(); const t=document.getElementById('chat-input').value.trim(); if(!t)return; await addDoc(collection(db,"messages"),{text:t, type:'text', channel:activeChatId,senderId:curUser.uid,senderName:uData.name,createdAt:new Date()}); document.getElementById('chat-input').value=''; notifyChat(activeChatId);});

        function notifyChat(cid) { 
            if(cid.includes('_')){ 
                const tg=cid.split('_').find(x=>x!==curUser.uid); 
                addDoc(collection(db,"notifications"),{to:tg,text:`${uData.name} mesaj attı`,read:false,createdAt:new Date()});
            } 
        }

        function listenNotifs(){ 
            unsubNotif = onSnapshot(query(collection(db,"notifications"),where("to","==",curUser.uid),where("read","==",false)), s=>{ document.getElementById('notif-dot').style.display=s.empty?'none':'block'; }); 
        }
        
        window.openNotifs=async()=>{
            const m=new bootstrap.Modal(document.getElementById('modal-notif')); m.show(); 
            const l=document.getElementById('notif-list'); l.innerHTML='...'; 
            const s=await getDocs(query(collection(db,"notifications"),where("to","==",curUser.uid))); 
            l.innerHTML='';
            s.forEach(d=>{
                const n = d.data();
                l.innerHTML+=`<div class="p-2 border-bottom border-secondary ${n.read?'opacity-50':''}"><small>${n.text}</small></div>`;
                updateDoc(doc(db,"notifications",d.id),{read:true});
            });
            document.getElementById('notif-dot').style.display='none';
        }
        
        async function loadRecentDMs() {
             const dList = document.getElementById('dm-list');
             const s = await getDocs(collection(db, "messages")); // In production, optimize this query!
             let pairs = new Set();
             s.forEach(d => {
                 const c = d.data().channel;
                 if(c && c.includes('_') && c.includes(curUser.uid)) {
                     const other = c.split('_').find(x => x!==curUser.uid);
                     pairs.add(other);
                 }
             });
             dList.innerHTML = '';
             pairs.forEach(async uid => {
                 const u = allUsersCache.find(x=>x.uid===uid); // Likely loaded from team listener
                 if(u) dList.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-1" onclick="openChat('${[curUser.uid,uid].sort().join('_')}','${u.name}')"><img src="${u.photoURL}" class="rounded-circle me-3" width="40"><div><div class="fw-bold">${u.name}</div></div></div>`;
             });
        }
        
        window.logout = () => signOut(auth);
        
        // Register Logic
        document.getElementById('form-register').addEventListener('submit',async e=>{
            e.preventDefault(); 
            const n=document.getElementById('r-name').value, em=document.getElementById('r-email').value, ps=document.getElementById('r-pass').value; 
            try{ 
                const c=await createUserWithEmailAndPassword(auth,em,ps); 
                const p=`https://ui-avatars.com/api/?name=${n}&background=random&color=fff`; 
                await setDoc(doc(db,"users",c.user.uid),{
                    uid:c.user.uid, name:n, email:em, photoURL:p, createdAt:new Date(), isBanned:false,
                    roles: ['Üye'], departments: ['...'] // Default
                }); 
                await updateProfile(c.user,{displayName:n,photoURL:p}); 
            } catch(err){ alert(err.message) }
        });
        
        document.getElementById('form-login').addEventListener('submit',async e=>{
            e.preventDefault(); 
            try{ await signInWithEmailAndPassword(auth,document.getElementById('l-email').value,document.getElementById('l-pass').value) } 
            catch(err){ alert("Hata: " + err.message); }
        });
        
        // Photo Update (Profile)
        window.uploadPhoto=(i)=>{const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{const im=new Image();im.src=e.target.result;im.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=150/Math.max(im.width,im.height);c.width=im.width*s;c.height=im.height*s;x.drawImage(im,0,0,c.width,c.height);const b=c.toDataURL('image/jpeg',0.7);updateDoc(doc(db,"users",curUser.uid),{photoURL:b}).then(()=>{uData.photoURL=b;loadProfile()})}};r.readAsDataURL(f);}
        
        window.openImgViewer = (src) => { document.getElementById('img-viewer-src').src = src; document.getElementById('img-viewer').style.display='flex'; }

    </script>
</body>
</html>
