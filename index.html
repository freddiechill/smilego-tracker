<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmileGO V11.0 - Ultimate Interaction</title>
    
    <script src="https://cdn.median.co/median.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400,300&display=swap" rel="stylesheet">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "2657219b-d29e-46e1-ac6f-68d2cdb8014d" });
      });
    </script>

    <style>
        :root { --bg-dark: #09090b; --nav-dark: #101012; --primary: #818cf8; --sent-bg: #4f46e5; --recv-bg: #27272a; }
        body { background-color: var(--bg-dark); font-family: 'Satoshi', sans-serif; color: #fff; height: 100vh; overflow: hidden; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        /* TIKLAMA GARANTİSİ */
        button, a, input, select, textarea, .card-custom, .nav-btn, .clickable { cursor: pointer; pointer-events: auto !important; }

        .modal { z-index: 1000005 !important; }
        .modal-backdrop { z-index: 1000004 !important; }
        
        /* HEADER & NAV */
        .app-header { 
            height: 70px; position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; 
            z-index: 9999; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; 
        }
        .header-icon-btn { background: transparent !important; border: none !important; padding: 0 8px !important; color: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .bottom-nav { 
            height: 85px; position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(16, 16, 18, 0.98); border-top: 1px solid #27272a; 
            z-index: 9999; display: flex; align-items: center; justify-content: space-around; padding-bottom: 15px; 
        }

        .main-content { 
            position: fixed; top: 70px; bottom: 85px; width: 100%; 
            overflow-y: auto; padding: 20px; display: none; z-index: 1; 
        }
        .main-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Helpers */
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .card-custom { background: #18181b; border: 1px solid #27272a; border-radius: 20px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition:0.2s; position: relative; }
        .card-custom:active { background: #202023; }
        .form-control, .form-select { background: #27272a; border: 1px solid #3f3f46; color: white; padding: 12px; border-radius: 12px; font-size: 14px; }
        .form-control:focus, .form-select:focus { background: #27272a; color: white; border-color: var(--primary); box-shadow: none; }
        .btn-primary-soft { background: var(--primary); color: #000; font-weight: 700; border-radius: 14px; border: none; padding: 14px; width: 100%; }
        
        /* CHAT */
        #chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: none; flex-direction: column; }
        #chat-overlay.open { display: flex; }
        .chat-body-scroll { flex: 1 1 auto; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #050505; }
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14.5px; position: relative; word-wrap: break-word; user-select: none; }
        .bubble-sent { background: var(--sent-bg); color: #fff; border-bottom-right-radius: 4px; margin-left: auto; }
        .bubble-received { background: var(--recv-bg); color: #fff; border-bottom-left-radius: 4px; margin-right: auto; }
        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        
        /* Chat Badges */
        .chat-badge-role { display: inline-block; font-size: 9px; padding: 2px 5px; border-radius: 4px; background: #333; border: 1px solid #333; color: #ccc; margin-left: 4px; vertical-align: middle; }
        .chat-badge-dept { display: inline-block; font-size: 9px; padding: 2px 5px; border-radius: 4px; background: transparent; border: 1px solid #444; color: #aaa; margin-left: 2px; vertical-align: middle; }

        /* CUSTOM ALERT (TOAST) */
        #app-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(30, 30, 35, 0.95); border: 1px solid #444; backdrop-filter: blur(10px);
            padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000008; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px; min-width: 300px; justify-content: center;
        }
        #app-toast.show { transform: translateX(-50%) translateY(0); }
        
        /* CONTEXT MENU */
        #context-menu {
            position: fixed; background: #1c1c1e; border: 1px solid #333; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.9); display: none; flex-direction: column;
            min-width: 180px; overflow: hidden; z-index: 2000006;
        }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; gap: 10px; transition:0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .ctx-item:active { background: #333; }
        .ctx-item:last-child { border-bottom: none; }
        .ctx-item.delete { color: #ff6b6b; }

        /* TASKS & TEAM */
        .star-rating i { color: #fbbf24; font-size: 12px; margin-right: 1px; }
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .st-pending { background: rgba(255,255,255,0.1); color: #aaa; }
        .st-progress { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        
        .dept-header { color: var(--primary); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 20px; margin-bottom: 10px; padding-left: 5px; border-left: 3px solid var(--primary); }
        .dept-group { background: rgba(255,255,255,0.02); border-radius: 16px; padding: 5px; border: 1px solid #27272a; margin-bottom: 10px; }
        .rounded-circle { border-radius: 50% !important; aspect-ratio: 1 / 1; object-fit: cover; }
        .role-badge { font-size: 9px; padding: 2px 5px; border-radius: 4px; background: #333; color: #ccc; margin-left: 3px; }
        .search-list { max-height: 200px; overflow-y: auto; background: #202023; border: 1px solid #333; border-radius: 0 0 12px 12px; display: none; position: absolute; width: 100%; z-index: 1000; }
        .search-list div { padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2d; font-size: 13px; }
        .search-list div:hover { background: var(--primary); color: black; }
        .progress-ring { width: 60px; height: 60px; }
        .progress-ring__circle { transition: 0.35s stroke-dashoffset; transform: rotate(-90deg); transform-origin: 50% 50%; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000007; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #img-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000000; display: none; align-items: center; justify-content: center; }
        #img-viewer img { max-width: 100%; max-height: 100%; }
        .nav-btn { background: none; border: none; color: #52525b; flex: 1; height: 100%; font-size: 24px; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); }
    </style>
</head>
<body>

    <div id="app-toast">
        <i class="fas fa-info-circle text-primary fs-5"></i>
        <span id="toast-msg" class="fw-bold small">...</span>
    </div>

    <div id="context-menu"></div>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <div class="text-white mt-3 fw-bold" id="loading-text">Yükleniyor...</div>
    </div>

    <div id="img-viewer">
        <button style="position:absolute;top:40px;right:20px;background:none;border:none;color:white;font-size:30px;z-index:2000001" onclick="document.getElementById('img-viewer').style.display='none'"><i class="fas fa-times"></i></button>
        <img id="img-viewer-src" src="">
    </div>

    <div id="auth-screen" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div id="auth-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at top right, #312e81 0%, #09090b 60%);z-index:-1"></div>
        <div class="glass-card">
            <div class="text-center mb-4"><img src="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/smilegologotracker.png" alt="SmileGO" style="width: 170px;"></div>
            <ul class="nav nav-pills nav-fill mb-4 bg-dark rounded p-1" style="border: 1px solid #333"><li class="nav-item"><a class="nav-link active rounded" data-bs-toggle="pill" href="#tab-login">Giriş</a></li><li class="nav-item"><a class="nav-link rounded" data-bs-toggle="pill" href="#tab-register">Kayıt</a></li></ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-login"><form id="form-login"><input type="email" id="l-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="l-pass" class="form-control mb-4" placeholder="Şifre" required><button class="btn-primary-soft">Giriş Yap</button></form></div>
                <div class="tab-pane fade" id="tab-register"><form id="form-register"><input id="r-name" class="form-control mb-3" placeholder="Ad Soyad" required><input id="r-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="r-pass" class="form-control mb-3" placeholder="Şifre (min 6)" required><div class="text-muted small mb-2">Departman ve Rol Admin tarafından atanacaktır.</div><button class="btn-primary-soft">Kayıt Ol</button></form></div>
            </div>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <header class="app-header">
            <h5 class="m-0 fw-bold" id="page-title">Görev Panosu</h5>
            <div class="d-flex gap-2 align-items-center">
                <button class="header-icon-btn" onclick="openLeaderboard()"><i class="fas fa-trophy text-warning"></i></button>
                <div class="position-relative">
                    <button class="header-icon-btn" onclick="openNotifs()"><i class="fas fa-bell"></i></button>
                    <div id="notif-dot" class="notif-dot" style="position:absolute;top:5px;right:5px;width:8px;height:8px;background:red;border-radius:50%;display:none;border:1px solid #000"></div>
                </div>
            </div>
        </header>

        <div id="view-tasks" class="main-content active">
            <button id="btn-add-task" class="btn-primary-soft mb-4 shadow-sm" onclick="openTaskModal()"><i class="fas fa-plus me-2"></i> Yeni Görev Ekle</button>
            <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
                <button class="btn btn-sm btn-outline-secondary rounded-pill active" onclick="filterTasks('all', this)">Tümü</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterTasks('pending', this)">Başlamadı</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterTasks('progress', this)">Yapılıyor</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterTasks('done', this)">Bitti</button>
            </div>
            <div id="task-list" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="view-messages" class="main-content">
            <h6 class="text-muted small fw-bold mb-3 ls-1">GRUPLAR</h6>
            <div id="channel-list" class="d-flex flex-column gap-2 mb-4"></div>
            <h6 class="text-muted small fw-bold mb-3 ls-1">ÖZEL MESAJLAR</h6>
            <div id="dm-list" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="view-team" class="main-content">
            <input type="text" class="form-control mb-4" placeholder="Ekipte ara..." onkeyup="renderTeam(this.value)">
            <div id="team-list"></div>
        </div>

        <div id="view-profile" class="main-content">
            <div class="text-center">
                <div class="mb-3 position-relative d-inline-block">
                    <img id="prof-img" src="" class="rounded-circle border border-2 border-secondary p-1" width="110" height="110">
                    <label for="file-inp" class="position-absolute bottom-0 end-0 bg-white text-dark rounded-circle d-flex align-items-center justify-content-center shadow" style="width:35px;height:35px;cursor:pointer"><i class="fas fa-camera small"></i></label>
                    <input type="file" id="file-inp" class="d-none" accept="image/*" onchange="uploadPhoto(this)">
                </div>
                <h4 id="prof-name" class="fw-bold mb-1">...</h4>
                <div id="prof-roles" class="d-flex justify-content-center gap-1 mb-2"></div>
                <div class="card-custom p-3 mt-3 d-flex align-items-center justify-content-between">
                    <div class="text-start"><div class="text-muted small">Görev Başarımı</div><h4 class="fw-bold m-0" id="prof-rate">0%</h4></div>
                    <svg class="progress-ring" width="60" height="60"><circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="prof-circle" stroke-dasharray="163.36" stroke-dashoffset="163.36"/></svg>
                </div>
            </div>

             <div class="card-custom mt-3">
                <h6 class="fw-bold text-muted mb-3">KİŞİSEL BİLGİLER</h6>
                <div class="mb-3 position-relative">
                    <label class="small text-muted">Üniversite</label>
                    <input type="text" class="form-control" id="inp-uni" placeholder="Üniversite Ara..." onkeyup="filterSearch('uni')">
                    <div class="search-list" id="list-uni"></div>
                </div>
                <div class="mb-3 position-relative">
                    <label class="small text-muted">Bölüm</label>
                    <input type="text" class="form-control" id="inp-sec" placeholder="Bölüm Ara..." onkeyup="filterSearch('sec')">
                    <div class="search-list" id="list-sec"></div>
                </div>
                <button class="btn btn-sm btn-success w-100" onclick="saveEduInfo()">Bilgileri Kaydet</button>
             </div>

             <div class="card-custom mt-2">
                <h6 class="fw-bold text-muted mb-3">SOSYAL MEDYA (Kullanıcı Adları)</h6>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-linkedin"></i></span><input id="sm-linkedin" class="form-control" placeholder="LinkedIn"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-instagram"></i></span><input id="sm-instagram" class="form-control" placeholder="Instagram"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-twitter"></i></span><input id="sm-x" class="form-control" placeholder="X (Twitter)"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-tiktok"></i></span><input id="sm-tiktok" class="form-control" placeholder="TikTok"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-youtube"></i></span><input id="sm-youtube" class="form-control" placeholder="YouTube"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-kickstarter"></i></span><input id="sm-kick" class="form-control" placeholder="Kick"></div>
                <button class="btn btn-sm btn-success w-100 mt-2" onclick="saveSocials()">Sosyal Medyayı Kaydet</button>
             </div>
             
             <button class="btn btn-outline-danger w-100 mt-4 py-3 rounded-4 fw-bold" onclick="logout()">Çıkış Yap</button>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="goTab('tasks',this)"><i class="fas fa-check-circle"></i></button>
            <button class="nav-btn" onclick="goTab('messages',this)"><i class="fas fa-paper-plane"></i></button>
            <button class="nav-btn" onclick="goTab('team',this)"><i class="fas fa-users"></i></button>
            <button class="nav-btn" onclick="goTab('profile',this)"><i class="fas fa-user"></i></button>
        </nav>
    </div>

    <div id="chat-overlay">
        <div style="flex: 0 0 70px; background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; display: flex; align-items: center; padding: 0 20px;">
            <button class="btn text-white me-2 p-0" onclick="closeChat()"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h6 class="m-0 fw-bold text-white" id="chat-overlay-title">Sohbet</h6>
        </div>
        <div class="chat-body-scroll" id="chat-overlay-body"></div>
        <form id="chat-form" style="flex: 0 0 auto; background: var(--nav-dark); border-top: 1px solid #27272a; padding: 15px; padding-bottom: 25px; display: flex; gap: 10px;">
            <input type="file" id="chat-file-inp" hidden>
            <button type="button" class="btn btn-dark text-muted rounded-circle" style="width:45px;height:45px" onclick="document.getElementById('chat-file-inp').click()"><i class="fas fa-paperclip"></i></button>
            <input id="chat-input" class="form-control" placeholder="Mesaj yaz..." style="border-radius:20px" autocomplete="off">
            <button type="submit" class="btn btn-primary rounded-circle" style="width:45px;height:45px"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div class="modal fade" id="modal-edit-msg" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Mesajı Düzenle</h5><input id="edit-msg-input" class="form-control mb-3"><button class="btn-primary-soft" onclick="submitEditMsg()">Kaydet</button></div></div></div>
    
    <div class="modal fade" id="modal-task" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Yeni Görev</h5><form id="form-task">
        <input id="t-title" class="form-control mb-3" placeholder="Başlık" required>
        <textarea id="t-desc" class="form-control mb-3" placeholder="Açıklama" rows="3"></textarea>
        <div class="mb-3 fs-4 text-warning" id="star-select"><i class="far fa-star clickable" onclick="setStars(1)"></i><i class="far fa-star clickable" onclick="setStars(2)"></i><i class="far fa-star clickable" onclick="setStars(3)"></i><i class="far fa-star clickable" onclick="setStars(4)"></i><i class="far fa-star clickable" onclick="setStars(5)"></i></div>
        <input type="hidden" id="t-stars" value="0">
        <select id="t-type" class="form-select mb-3" onchange="togT(this.value)"><option value="department">Departman</option><option value="user">Kişi</option><option value="all">Herkes</option></select>
        <select id="t-dept" class="form-select mb-3"></select><select id="t-user" class="form-select mb-4 d-none"></select>
        <button class="btn-primary-soft">Oluştur</button>
    </form></div></div></div>

    <div class="modal fade" id="modal-task-detail" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3">
        <h5 class="fw-bold mb-1" id="td-title">...</h5>
        <div id="td-stars" class="mb-3 text-warning small"></div>
        <p class="text-muted small" id="td-desc">...</p><hr class="border-secondary"><h6 class="small fw-bold text-muted mb-2">DURUM LİSTESİ</h6><div id="td-status-list" class="d-flex flex-column gap-2" style="max-height: 200px; overflow-y: auto;"></div>
        <div class="d-flex justify-content-end mt-3"><button class="btn btn-dark border-secondary btn-sm" data-bs-dismiss="modal">Kapat</button></div>
    </div></div></div>

    <div class="modal fade" id="modal-profile-view" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-4 position-relative">
        <button class="btn btn-sm btn-dark position-absolute top-0 end-0 m-3 rounded-circle" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
        <div class="d-flex align-items-center gap-3 mb-3 text-start">
            <img id="vp-img" src="" class="rounded-circle border border-2 border-secondary p-1" width="80" height="80">
            <div><h4 id="vp-name" class="fw-bold mb-1">...</h4><div id="vp-badges" class="d-flex flex-wrap gap-1"></div></div>
        </div>
        <div class="mb-3 text-start">
             <div class="small text-muted"><i class="fas fa-university me-1"></i> <span id="vp-uni" class="text-white">...</span></div>
             <div class="small text-muted"><i class="fas fa-graduation-cap me-1"></i> <span id="vp-dept" class="text-white">...</span></div>
        </div>
        <div class="card-custom bg-dark p-3 d-flex align-items-center justify-content-between mb-3">
            <div class="text-start"><div class="text-muted small">Genel Başarı</div><h4 class="fw-bold m-0" id="vp-rate">0%</h4></div>
            <svg class="progress-ring" width="50" height="50"><circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="21" cx="25" cy="25" id="vp-circle" stroke-dasharray="131.95" stroke-dashoffset="131.95"/></svg>
        </div>
        <h6 class="small fw-bold text-muted mb-2">SOSYAL MEDYA</h6>
        <div id="vp-socials" class="d-flex justify-content-center gap-3 fs-3"></div>
    </div></div></div>

    <div class="modal fade" id="modal-user-edit" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3">
        <h5 class="fw-bold mb-3">Üye Düzenle (Admin)</h5><h6 id="ue-name" class="text-primary mb-3"></h6>
        <div id="ue-roles" class="d-flex flex-wrap gap-2 mb-3"></div><div id="ue-depts" class="d-flex flex-wrap gap-2 mb-3"></div>
        <button class="btn btn-success w-100" onclick="saveUserEdit()">Kaydet</button>
    </div></div></div>

    <div class="modal fade" id="modal-leaderboard" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-0 overflow-hidden">
        <div class="bg-primary p-3 text-center"><h5 class="fw-bold m-0 text-black"><i class="fas fa-trophy me-2"></i>Sıralama</h5></div>
        <div id="lb-list" class="p-3" style="max-height: 50vh; overflow-y: auto;"></div>
    </div></div></div>

    <div class="modal fade" id="modal-notif" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Bildirimler</h5><div id="notif-list" style="max-height:50vh;overflow-y:auto"></div></div></div></div>
    <div class="modal fade" id="modal-status" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content card-custom border-0 p-3 text-center"><h6 class="mb-3">Durum Güncelle</h6><div class="d-grid gap-2"><button class="btn btn-outline-secondary" onclick="updateTaskStatus('pending')">Başlamadı</button><button class="btn btn-outline-primary" onclick="updateTaskStatus('progress')">Yapılıyor</button><button class="btn btn-outline-success" onclick="updateTaskStatus('done')">Bitti</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, query, where, onSnapshot, orderBy, updateDoc, deleteDoc, getDocs, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDHbuPLeir2dn9BFI7Rt2AxUp_6E0VFy_8", authDomain: "smilego-tracker.firebaseapp.com", projectId: "smilego-tracker", storageBucket: "smilego-tracker.firebasestorage.app", messagingSenderId: "49933018016", appId: "1:49933018016:web:f69bf14464bfd4399a3ac5" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        const ADMIN_EMAIL = "yenerarda7@gmail.com";
        const DEPTS = ["Organizasyonel Gelişim","Sosyal Medya","Bölge Koordinatörlüğü","Psikolog İlişkileri","Data & Planlama","Kurumsal İletişim", "Yazılım"];
        const DEPT_ABBR = { "Sosyal Medya": "SMD", "Psikolog İlişkileri": "PİD", "Data & Planlama": "DPD", "Bölge Koordinatörlüğü": "BKD", "Kurumsal İletişim": "KİD", "Organizasyonel Gelişim": "OGD", "Yazılım": "YD" };
        const ROLES = ["Başkan", "YK", "YKY", "Üye", "Admin"];
        const UNIVERSITIES = ["Sakarya Üniversitesi", "Sakarya Uygulamalı Bilimler Üniversitesi", "İstanbul Üniversitesi", "ODTÜ", "İTÜ", "Boğaziçi Üniversitesi", "Marmara Üniversitesi", "Yıldız Teknik Üniversitesi", "Hacettepe Üniversitesi", "Ankara Üniversitesi", "Ege Üniversitesi", "Dokuz Eylül Üniversitesi", "Gazi Üniversitesi", "Anadolu Üniversitesi", "Akdeniz Üniversitesi", "Çukurova Üniversitesi", "Bilkent Üniversitesi", "Koç Üniversitesi", "Sabancı Üniversitesi", "Yeditepe Üniversitesi", "Bahçeşehir Üniversitesi"];
        const DEPARTMENTS_UNI = ["İşletme", "Bilgisayar Mühendisliği", "Hukuk", "Tıp", "Psikoloji", "Mimarlık", "Endüstri Mühendisliği", "Makine Mühendisliği", "Elektrik-Elektronik Müh.", "İnşaat Mühendisliği", "Siyaset Bilimi", "Uluslararası İlişkiler", "Diş Hekimliği", "Eczacılık", "Hemşirelik", "Öğretmenlik", "Grafik Tasarım", "İletişim Tasarımı", "Sosyoloji", "Felsefe"];

        let curUser=null, uData={}, activeChatId=null;
        let unsubUser=null, unsubTasks=null, unsubTeam=null, unsubChat=null, unsubNotif=null, unsubDMs=null;
        let allUsersCache=[], allTasksCache={};
        let selectedTaskForStatus = null, selectedUserForEdit = null, selectedMsg = null, longPressTimer = null;

        // Custom Toast Function
        window.showToast = (msg) => {
            const t = document.getElementById('app-toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };
        // Replace Alerts
        window.alert = window.showToast;

        onAuthStateChanged(auth, async u => {
            if(u){
                curUser = u;
                unsubUser = onSnapshot(doc(db,"users",u.uid), s => {
                    if(s.exists()){
                        uData = s.data();
                        if(uData.isBanned) { signOut(auth); showToast("Hesap erişimi engellendi."); return; }
                        if(!Array.isArray(uData.roles)) uData.roles = [uData.role || 'Üye'];
                        if(!Array.isArray(uData.departments)) uData.departments = [uData.department || '...'];
                        if(u.email === ADMIN_EMAIL && !uData.roles.includes('Admin')) uData.roles.push('Admin');
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('app-screen').style.display = 'block';
                        initApp();
                    }
                });
                if(window.OneSignalDeferred) OneSignalDeferred.push(()=>OneSignal.login(u.uid));
            } else {
                cleanup(); document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function initApp() {
            loadProfile(); listenTasks(); listenTeam(); loadChannels(); listenNotifs(); loadRecentDMs();
            const dSelect = document.getElementById('t-dept'); dSelect.innerHTML='';
            DEPTS.forEach(d => dSelect.innerHTML += `<option>${d}</option>`);
            
            if(!canManageUsers() && !uData.roles.includes('YK') && !uData.roles.includes('YKY')) {
                document.getElementById('btn-add-task').style.display = 'none';
            }
        }

        function cleanup() { if(unsubUser) unsubUser(); if(unsubTasks) unsubTasks(); if(unsubTeam) unsubTeam(); if(unsubChat) unsubChat(); if(unsubNotif) unsubNotif(); if(unsubDMs) unsubDMs(); curUser=null; uData={}; }
        
        const isAdmin = () => uData.roles?.includes('Admin');
        const isPres = () => uData.roles?.includes('Başkan');
        const canManageUsers = () => isAdmin() || isPres();
        const canSeeAllTasks = () => isAdmin(); 
        const canSeeAllChannels = () => isBoard() || uData.roles?.includes('YK');
        const isBoard = () => uData.roles?.some(r => ['YK','YKY','Başkan','Admin'].includes(r));

        window.loadProfile = () => {
            document.getElementById('prof-img').src = uData.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('prof-name').innerText = uData.name;
            const rDiv = document.getElementById('prof-roles'); rDiv.innerHTML='';
            uData.roles.forEach(r => rDiv.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            document.getElementById('inp-uni').value = uData.university || '';
            document.getElementById('inp-sec').value = uData.uni_dept || '';
            if(uData.socials) { ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => { document.getElementById(`sm-${k}`).value = uData.socials[k] || ''; }); }
            calcSuccessRate();
        };

        window.calcSuccessRate = () => {
            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => { if(t.statusMap && t.statusMap[curUser.uid]) { total++; if(t.statusMap[curUser.uid] === 'done') done++; } });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('prof-rate').innerText = `%${rate}`;
            const circle = document.getElementById('prof-circle');
            circle.style.strokeDashoffset = (163.36 * (100 - rate)) / 100;
        };

        window.saveEduInfo = async () => { await updateDoc(doc(db,"users",curUser.uid), { university: document.getElementById('inp-uni').value, uni_dept: document.getElementById('inp-sec').value }); showToast("Kaydedildi!"); };
        window.saveSocials = async () => { const soc = {}; ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => { const v = document.getElementById(`sm-${k}`).value.trim(); if(v) soc[k] = v; }); await updateDoc(doc(db,"users",curUser.uid), { socials: soc }); showToast("Kaydedildi!"); };

        window.filterSearch = (type) => {
            const inp = document.getElementById(`inp-${type}`); const list = document.getElementById(`list-${type}`);
            const val = inp.value.toLowerCase(); const source = type === 'uni' ? UNIVERSITIES : DEPARTMENTS_UNI;
            list.innerHTML = ''; if(val.length < 1) { list.style.display='none'; return; }
            source.filter(s => s.toLowerCase().includes(val)).forEach(m => { const d = document.createElement('div'); d.innerText = m; d.onclick = () => { inp.value = m; list.style.display='none'; }; list.appendChild(d); });
            list.style.display = 'block';
        };

        function listenTasks() {
            if(unsubTasks) unsubTasks();
            unsubTasks = onSnapshot(collection(db,"tasks"), s => {
                const list = document.getElementById('task-list'); list.innerHTML = ''; allTasksCache = {};
                let tempArr = [];
                s.forEach(d => {
                    const t = { id: d.id, ...d.data() }; allTasksCache[t.id] = t;
                    const isAssignedToMe = (t.assignedType==='all') || (t.assignedType==='department' && uData.departments.includes(t.assignedTo)) || (t.assignedType==='user' && t.assignedToUid===curUser.uid);
                    if(t.createdByUid === curUser.uid || isAssignedToMe || canSeeAllTasks()) { tempArr.push(t); }
                });
                tempArr.sort((a,b) => b.createdAt - a.createdAt);
                
                const filter = document.querySelector('.btn-outline-secondary.active').innerText;
                tempArr.forEach(t => {
                    let myStatus = t.statusMap && t.statusMap[curUser.uid] ? t.statusMap[curUser.uid] : 'pending';
                    if(t.assignedType === 'user' && t.assignedToUid !== curUser.uid) myStatus = Object.values(t.statusMap || {})[0] || 'pending';
                    if(filter === 'Başlamadı' && myStatus !== 'pending') return;
                    if(filter === 'Yapılıyor' && myStatus !== 'progress') return;
                    if(filter === 'Bitti' && myStatus !== 'done') return;

                    let starsHtml = ''; for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning" style="font-size:10px"></i>';
                    const stClass = myStatus === 'pending' ? 'st-pending' : (myStatus === 'progress' ? 'st-progress' : 'st-done');
                    const stText = myStatus === 'pending' ? 'Başlamadı' : (myStatus === 'progress' ? 'Yapılıyor' : 'Bitti');
                    const isAssignedToMe = (t.assignedType==='all') || (t.assignedType==='department' && uData.departments.includes(t.assignedTo)) || (t.assignedType==='user' && t.assignedToUid===curUser.uid);

                    list.innerHTML += `
                    <div class="card-custom" onclick="openTaskDetail('${t.id}')">
                        <div class="d-flex justify-content-between mb-1"><span class="badge bg-dark border border-secondary text-muted">${t.assignedTo}</span><div>${starsHtml}</div></div>
                        <h6 class="fw-bold mb-1">${t.title}</h6>
                        <p class="text-muted small mb-2 text-truncate">${t.description || ''}</p>
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-2"><img src="${t.creatorPhoto || 'https://ui-avatars.com/api/?name=User'}" class="rounded-circle" width="20"><small class="text-muted" style="font-size:11px">${t.creatorName}</small></div>
                            ${isAssignedToMe ? `<button class="btn btn-sm status-badge ${stClass}" onclick="event.stopPropagation();openStatusModal('${t.id}')">${stText}</button>` : `<span class="status-badge ${stClass}">${stText}</span>`}
                        </div>
                        ${(t.createdByUid === curUser.uid || isAdmin()) ? `<i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3" onclick="event.stopPropagation();delTask('${t.id}')"></i>` : ''}
                    </div>`;
                });
                calcSuccessRate();
            });
        }

        window.openTaskModal = async () => {
            const userSelect = document.getElementById('t-user'); userSelect.innerHTML = '';
            const snap = await getDocs(collection(db,"users"));
            snap.forEach(d => { if(d.id !== curUser.uid) userSelect.innerHTML += `<option value="${d.id}" data-role="${d.data().roles}">${d.data().name}</option>`; });
            new bootstrap.Modal(document.getElementById('modal-task')).show();
        };

        window.openTaskDetail = (tid) => {
            const t = allTasksCache[tid]; if(!t) return;
            document.getElementById('td-title').innerText = t.title;
            document.getElementById('td-desc').innerText = t.description || 'Açıklama yok.';
            let starsHtml = ''; for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning me-1"></i>';
            document.getElementById('td-stars').innerHTML = starsHtml;

            const list = document.getElementById('td-status-list'); list.innerHTML = '';
            if(t.statusMap) {
                Object.entries(t.statusMap).forEach(([uid, status]) => {
                    const user = allUsersCache.find(u => u.uid === uid);
                    const name = user ? user.name : "Kullanıcı";
                    const stText = status === 'pending' ? 'Başlamadı' : (status === 'progress' ? 'Yapılıyor' : 'Bitti');
                    const stColor = status === 'pending' ? 'text-secondary' : (status === 'progress' ? 'text-primary' : 'text-success');
                    list.innerHTML += `<div class="d-flex justify-content-between small border-bottom border-dark py-2"><span>${name}</span><span class="fw-bold ${stColor}">${stText}</span></div>`;
                });
            } else { list.innerHTML = '<span class="text-muted small">Henüz işlem yapılmamış.</span>'; }
            new bootstrap.Modal(document.getElementById('modal-task-detail')).show();
        };

        window.setStars = (n) => { document.getElementById('t-stars').value = n; const stars = document.getElementById('star-select').getElementsByTagName('i'); for(let i=0; i<5; i++) stars[i].className = i < n ? 'fas fa-star clickable' : 'far fa-star clickable'; };
        document.getElementById('form-task').addEventListener('submit', async e => {
            e.preventDefault();
            const title = document.getElementById('t-title').value, desc = document.getElementById('t-desc').value, type = document.getElementById('t-type').value, imp = parseInt(document.getElementById('t-stars').value);
            let to = "Herkes", uid = null;
            if(type === 'department') to = document.getElementById('t-dept').value;
            if(type === 'user') { const el = document.getElementById('t-user'); to = el.options[el.selectedIndex].text; uid = el.value; const roles = el.options[el.selectedIndex].getAttribute('data-role'); if(uData.roles.includes('Üye') && uData.roles.length===1 && (roles.includes('YK') || roles.includes('Başkan'))) { showToast("Yetkisiz işlem."); return; } }
            let initialStatusMap = {}; if(type === 'user' && uid) initialStatusMap[uid] = 'pending';
            await addDoc(collection(db,"tasks"), { title, description: desc, assignedType: type, assignedTo: to, assignedToUid: uid, importance: imp, createdByUid: curUser.uid, creatorName: uData.name, creatorPhoto: uData.photoURL, createdAt: new Date(), statusMap: initialStatusMap });
            if(uid) addDoc(collection(db,"notifications"),{to:uid,text:`Yeni Görev: ${title}`,read:false,createdAt:new Date(), type:'task', linkId: null});
            bootstrap.Modal.getInstance(document.getElementById('modal-task')).hide(); e.target.reset(); setStars(0);
        });

        window.openStatusModal = (tid) => { selectedTaskForStatus = tid; new bootstrap.Modal(document.getElementById('modal-status')).show(); };
        window.updateTaskStatus = async (status) => { if(!selectedTaskForStatus) return; await updateDoc(doc(db,"tasks",selectedTaskForStatus), { [`statusMap.${curUser.uid}`]: status }); bootstrap.Modal.getInstance(document.getElementById('modal-status')).hide(); };
        window.filterTasks = (f, b) => { document.querySelectorAll('#view-tasks .btn-outline-secondary').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); if(unsubTasks) { unsubTasks(); listenTasks(); } };
        window.delTask=(id)=>{if(confirm("Silinsin mi?")) deleteDoc(doc(db,"tasks",id));}

        function listenTeam() { unsubTeam = onSnapshot(collection(db,"users"), s => { allUsersCache = []; s.forEach(d => { const u = d.data(); if(!u.isBanned) allUsersCache.push(u); }); renderTeam(); }); }
        
        window.renderTeam = (filter='') => {
            const list = document.getElementById('team-list'); list.innerHTML = ''; const f = filter.toLowerCase();
            const groups = {}; DEPTS.forEach(d => groups[d] = []); groups["Diğer"] = [];
            
            allUsersCache.forEach(u => {
                if(f && !u.name.toLowerCase().includes(f)) return;
                let placed = false;
                u.departments?.forEach(d => { if(DEPTS.includes(d)) { groups[d].push(u); placed=true; } });
                if(!placed) groups["Diğer"].push(u);
            });

            for (const [deptName, users] of Object.entries(groups)) {
                if (users.length === 0) continue;
                const uniqueUsers = [...new Set(users)]; 

                list.innerHTML += `<div class="dept-header"><i class="fas fa-briefcase"></i> ${deptName}</div>`;
                const container = document.createElement('div'); container.className = 'dept-group';
                
                uniqueUsers.forEach(u => {
                    let badges = '';
                    u.roles?.forEach(r => badges += `<span class="role-badge border">${r}</span>`);
                    u.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); badges += `<span class="role-badge bg-dark border border-secondary text-muted">${abbr}</span>`; });
                    
                    const canDelete = (canManageUsers() && u.uid !== curUser.uid);
                    
                    container.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between p-2 mb-1 clickable" style="border-bottom:1px solid rgba(255,255,255,0.05)" onclick="openUserProfile('${u.uid}')">
                        <div class="d-flex align-items-center gap-3">
                            <img src="${u.photoURL}" class="rounded-circle" width="40" height="40">
                            <div><div class="fw-bold" style="font-size:14px">${u.name}</div><div class="d-flex mt-1">${badges}</div></div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                             ${canManageUsers() ? `<button class="btn btn-sm btn-dark text-warning border-secondary" onclick="event.stopPropagation();openUserEdit('${u.uid}')"><i class="fas fa-edit"></i></button>` : ''}
                             <button class="btn btn-sm btn-outline-secondary rounded-3 py-1 px-2 text-white" onclick="event.stopPropagation();openChat('${[curUser.uid,u.uid].sort().join('_')}','${u.name}')"><i class="far fa-paper-plane"></i></button>
                             ${canDelete ? `<button class="btn btn-sm btn-danger py-1 px-2" onclick="event.stopPropagation();deleteUser('${u.uid}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                });
                list.appendChild(container);
            }
        };

        window.openUserProfile = (uid) => {
            const u = allUsersCache.find(x => x.uid === uid); if(!u) return;
            document.getElementById('vp-img').src = u.photoURL;
            document.getElementById('vp-name').innerText = u.name;
            const bdg = document.getElementById('vp-badges'); bdg.innerHTML = '';
            u.roles?.forEach(r => bdg.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            u.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); bdg.innerHTML += `<span class="badge bg-dark border border-secondary text-muted">${abbr}</span>`; });

            document.getElementById('vp-uni').innerText = u.university || 'Belirtilmemiş';
            document.getElementById('vp-dept').innerText = u.uni_dept || 'Belirtilmemiş';

            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => { if(t.statusMap && t.statusMap[uid]) { total++; if(t.statusMap[uid] === 'done') done++; } });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('vp-rate').innerText = `%${rate}`;
            document.getElementById('vp-circle').style.strokeDashoffset = (131.95 * (100 - rate)) / 100;

            const socBox = document.getElementById('vp-socials'); socBox.innerHTML = '';
            if(u.socials) {
                if(u.socials.linkedin) socBox.innerHTML += `<a href="https://linkedin.com/in/${u.socials.linkedin}" target="_blank" class="text-secondary"><i class="fab fa-linkedin"></i></a>`;
                if(u.socials.instagram) socBox.innerHTML += `<a href="https://instagram.com/${u.socials.instagram}" target="_blank" class="text-secondary"><i class="fab fa-instagram"></i></a>`;
                if(u.socials.x) socBox.innerHTML += `<a href="https://x.com/${u.socials.x}" target="_blank" class="text-secondary"><i class="fab fa-twitter"></i></a>`;
                if(u.socials.tiktok) socBox.innerHTML += `<a href="https://tiktok.com/@${u.socials.tiktok}" target="_blank" class="text-secondary"><i class="fab fa-tiktok"></i></a>`;
                if(u.socials.youtube) socBox.innerHTML += `<a href="https://youtube.com/@${u.socials.youtube}" target="_blank" class="text-secondary"><i class="fab fa-youtube"></i></a>`;
                if(u.socials.kick) socBox.innerHTML += `<a href="https://kick.com/${u.socials.kick}" target="_blank" class="text-secondary"><i class="fab fa-kickstarter"></i></a>`;
            } else { socBox.innerHTML = '<small class="text-muted">Sosyal medya yok.</small>'; }
            
            new bootstrap.Modal(document.getElementById('modal-profile-view')).show();
        };

        window.deleteUser = async (uid) => { if(confirm("Kullanıcıyı silmek (engellemek) istediğinize emin misiniz?")) await updateDoc(doc(db,"users",uid), { isBanned: true }); };

        window.openUserEdit = (uid) => {
            if(!canManageUsers()) return; selectedUserForEdit = uid; const u = allUsersCache.find(x => x.uid === uid);
            document.getElementById('ue-name').innerText = u.name;
            const rd = document.getElementById('ue-roles'); rd.innerHTML = ''; ROLES.forEach(r => { rd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${r}" ${u.roles?.includes(r)?'checked':''}><label class="form-check-label">${r}</label></div>`; });
            const dd = document.getElementById('ue-depts'); dd.innerHTML = ''; DEPTS.forEach(d => { dd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${d}" ${u.departments?.includes(d)?'checked':''}><label class="form-check-label">${d}</label></div>`; });
            new bootstrap.Modal(document.getElementById('modal-user-edit')).show();
        };
        window.saveUserEdit = async () => { const roles = Array.from(document.querySelectorAll('#ue-roles input:checked')).map(c=>c.value); const depts = Array.from(document.querySelectorAll('#ue-depts input:checked')).map(c=>c.value); await updateDoc(doc(db,"users",selectedUserForEdit), { roles, departments: depts }); bootstrap.Modal.getInstance(document.getElementById('modal-user-edit')).hide(); };

        function loadChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = `<div class="card-custom p-3 d-flex align-items-center mb-0 border border-secondary" onclick="openChat('Sohbet','Genel Sohbet')"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-hashtag"></i></div><div class="fw-bold">Sohbet</div></div>`;
            list.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-secondary" onclick="openChat('Business','Business')"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-briefcase"></i></div><div class="fw-bold">Business</div></div>`;
            if(isBoard()) list.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-warning" onclick="openChat('Yonetim','Yönetim Kurulu')"><div class="bg-warning rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-crown text-black"></i></div><div class="fw-bold text-warning">Yönetim Kurulu</div></div>`;
            
            const deptsToShow = canSeeAllChannels() ? DEPTS : uData.departments;
            deptsToShow?.forEach(d => { list.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-info" onclick="openChat('${d}','${d}')"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-users text-info"></i></div><div class="fw-bold">${d}</div></div>`; });
        }

        window.openChat = (cid, title) => {
            activeChatId = cid; document.getElementById('chat-overlay-title').innerText = title;
            const body = document.getElementById('chat-overlay-body'); body.innerHTML = '';
            document.getElementById('chat-overlay').classList.add('open');
            if(unsubChat) unsubChat();
            unsubChat = onSnapshot(query(collection(db,"messages"), where("channel","==",cid)), s => {
                let msgs = []; s.forEach(d => { const m = d.data(); if(!m.deletedFor || !m.deletedFor.includes(curUser.uid)) msgs.push({id:d.id, ...m}); });
                msgs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                let html = '';
                msgs.forEach(m => {
                    const me = m.senderId === curUser.uid;
                    let content = m.text; if(m.type === 'image') content = `<img src="${m.url}" class="chat-img" onclick="openImgViewer('${m.url}')">`;
                    
                    let badgeHtml = '';
                    const sender = allUsersCache.find(u => u.uid === m.senderId);
                    if(sender && !me) {
                        sender.roles?.forEach(r => badgeHtml += `<span class="chat-badge-role">${r}</span>`);
                        sender.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); badgeHtml += `<span class="chat-badge-dept">${abbr}</span>`; });
                    }

                    // Safe Quote for event handlers
                    const safeM = JSON.stringify({id:m.id, senderId:m.senderId, text:m.text}).replace(/"/g, '&quot;');

                    html += `
                    <div class="d-flex w-100 mb-1 ${me?'justify-content-end':'justify-content-start'}">
                        <div class="msg-bubble ${me?'bubble-sent':'bubble-received'}" 
                             oncontextmenu="handleMsgCtx(event, ${safeM}); return false;"
                             ontouchstart="startLongPress(event, ${safeM})" 
                             ontouchend="cancelLongPress()" 
                             ontouchmove="cancelLongPress()">
                            ${!me ? `<div class="mb-1 d-flex align-items-center"><span class="fw-bold text-white small me-1">${m.senderName}</span>${badgeHtml}</div>` : ''}
                            ${content}
                            <div style="font-size:9px; opacity:0.6; text-align:right; margin-top:2px">
                                ${m.createdAt?.seconds ? new Date(m.createdAt.seconds*1000).getHours() + ':' + String(new Date(m.createdAt.seconds*1000).getMinutes()).padStart(2,'0') : ''}
                            </div>
                        </div>
                    </div>`;
                });
                body.innerHTML = html; body.scrollTop = body.scrollHeight;
            });
        };
        window.closeChat = () => { document.getElementById('chat-overlay').classList.remove('open'); if(unsubChat) unsubChat(); activeChatId = null; };

        // --- CONTEXT MENU & LONG PRESS ---
        const ctx = document.getElementById('context-menu');
        window.startLongPress = (e, msg) => { longPressTimer = setTimeout(() => handleMsgCtx(e.touches[0], msg), 800); };
        window.cancelLongPress = () => { if(longPressTimer) clearTimeout(longPressTimer); };

        window.handleMsgCtx = (e, msg) => {
            if(window.navigator.vibrate) window.navigator.vibrate(50);
            selectedMsg = msg;
            
            let html = '';
            const isMine = msg.senderId === curUser.uid;
            
            // Options Logic
            if(isMine) html += `<div class="ctx-item" onclick="editMsg()"><i class="fas fa-pen"></i> Düzenle</div>`;
            if(isMine || isAdmin()) html += `<div class="ctx-item delete" onclick="deleteMsg('all')"><i class="fas fa-trash"></i> Herkes için Sil</div>`;
            html += `<div class="ctx-item delete" onclick="deleteMsg('me')"><i class="fas fa-trash-alt"></i> Benden Sil</div>`;

            if(!html) return;

            let x = e.clientX, y = e.clientY;
            if(x + 180 > window.innerWidth) x -= 180;
            if(y + 150 > window.innerHeight) y -= 150;

            ctx.innerHTML = html;
            ctx.style.top = y + 'px'; ctx.style.left = x + 'px';
            ctx.style.display = 'flex';
        };
        
        document.addEventListener('click', (e) => { if(!ctx.contains(e.target)) ctx.style.display='none'; });

        window.deleteMsg = async (type) => {
            ctx.style.display='none';
            if(type === 'all') {
                if(confirm("Bu mesaj herkesden silinecek?")) await deleteDoc(doc(db,"messages",selectedMsg.id));
            } else {
                await updateDoc(doc(db,"messages",selectedMsg.id), { deletedFor: arrayUnion(curUser.uid) });
                showToast("Mesaj sizden silindi.");
            }
        };

        window.editMsg = () => {
            ctx.style.display='none';
            document.getElementById('edit-msg-input').value = selectedMsg.text;
            new bootstrap.Modal(document.getElementById('modal-edit-msg')).show();
        };

        window.submitEditMsg = async () => {
            const txt = document.getElementById('edit-msg-input').value;
            await updateDoc(doc(db,"messages",selectedMsg.id), { text: txt + ' (düzenlendi)' });
            bootstrap.Modal.getInstance(document.getElementById('modal-edit-msg')).hide();
        };

        document.getElementById('chat-file-inp').addEventListener('change', async e => {
            const f = e.target.files[0]; if(!f || !activeChatId) return;
            const btn = document.querySelector('#chat-form button[type=button]'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const reader = new FileReader(); reader.readAsDataURL(f);
            reader.onload = (ev) => {
                const img = new Image(); img.src = ev.target.result;
                img.onload = async () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    let w = img.width, h = img.height; const max = 800;
                    if(w>h){if(w>max){h*=max/w;w=max;}}else{if(h>max){w*=max/h;h=max;}}
                    c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
                    await addDoc(collection(db,"messages"), { type: 'image', url: c.toDataURL('image/jpeg',0.6), channel: activeChatId, senderId: curUser.uid, senderName: uData.name, createdAt: new Date() });
                    btn.innerHTML = '<i class="fas fa-paperclip"></i>'; notifyChat(activeChatId);
                };
            };
        });

        window.openLeaderboard = () => {
            const list = document.getElementById('lb-list'); list.innerHTML = '';
            const scores = [];
            allUsersCache.forEach(u => {
                let total = 0, done = 0;
                Object.values(allTasksCache).forEach(t => { if(t.statusMap && t.statusMap[u.uid]) { total++; if(t.statusMap[u.uid] === 'done') done++; } });
                const rate = total === 0 ? 0 : (done/total)*100; scores.push({ ...u, rate, done, total });
            });
            scores.sort((a,b) => b.rate - a.rate);
            scores.forEach((s, idx) => {
                list.innerHTML += `<div class="d-flex align-items-center justify-content-between p-2 border-bottom border-secondary"><div class="d-flex align-items-center gap-3"><div class="fw-bold" style="width:20px;">${idx+1}</div><img src="${s.photoURL}" class="rounded-circle" width="35"><div><div class="fw-bold small">${s.name}</div><div class="text-muted" style="font-size:10px">${s.done}/${s.total} Görev</div></div></div><div class="fw-bold text-success">%${Math.round(s.rate)}</div></div>`;
            });
            new bootstrap.Modal(document.getElementById('modal-leaderboard')).show();
        };

        window.goTab = (t,b) => { document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); };
        window.togT=(v)=>{document.getElementById('t-dept').classList.toggle('d-none',v!=='department');document.getElementById('t-user').classList.toggle('d-none',v!=='user')};
        document.getElementById('chat-form').addEventListener('submit',async e=>{e.preventDefault(); const t=document.getElementById('chat-input').value.trim(); if(!t)return; await addDoc(collection(db,"messages"),{text:t, type:'text', channel:activeChatId,senderId:curUser.uid,senderName:uData.name,createdAt:new Date()}); document.getElementById('chat-input').value=''; notifyChat(activeChatId);});
        function notifyChat(cid) { if(cid.includes('_')){ const tg=cid.split('_').find(x=>x!==curUser.uid); addDoc(collection(db,"notifications"),{to:tg,text:`${uData.name} mesaj attı`,read:false,createdAt:new Date(), type:'chat', linkId:curUser.uid}); } }
        function listenNotifs(){ unsubNotif = onSnapshot(query(collection(db,"notifications"),where("to","==",curUser.uid),where("read","==",false)), s=>{ document.getElementById('notif-dot').style.display=s.empty?'none':'block'; }); }
        
        window.openNotifs=async()=>{ 
            const m=new bootstrap.Modal(document.getElementById('modal-notif')); m.show(); 
            const l=document.getElementById('notif-list'); l.innerHTML='...'; 
            const s=await getDocs(query(collection(db,"notifications"),where("to","==",curUser.uid))); 
            l.innerHTML=''; 
            s.forEach(d=>{ 
                const n = d.data(); 
                let action = '';
                if(n.type === 'chat' && n.linkId) {
                    const sender = allUsersCache.find(x => x.uid === n.linkId);
                    if(sender) action = `onclick="openChat('${[curUser.uid, n.linkId].sort().join('_')}', '${sender.name}'); bootstrap.Modal.getInstance(document.getElementById('modal-notif')).hide()"`;
                } else if(n.type === 'task' && n.linkId) {
                    action = `onclick="openTaskDetail('${n.linkId}'); bootstrap.Modal.getInstance(document.getElementById('modal-notif')).hide()"`;
                }
                l.innerHTML+=`<div class="p-2 border-bottom border-secondary ${n.read?'opacity-50':''} clickable" ${action}><small>${n.text}</small></div>`; 
                updateDoc(doc(db,"notifications",d.id),{read:true}); 
            }); 
            document.getElementById('notif-dot').style.display='none'; 
        }

        async function loadRecentDMs() { 
            if(unsubDMs) unsubDMs();
            unsubDMs = onSnapshot(collection(db, "messages"), s => {
                const dList = document.getElementById('dm-list'); 
                let pairs = new Set();
                s.forEach(d => { const c = d.data().channel; if(c && c.includes('_') && c.includes(curUser.uid)) { const other = c.split('_').find(x => x!==curUser.uid); pairs.add(other); } }); 
                dList.innerHTML = ''; 
                if(pairs.size === 0) dList.innerHTML = '<div class="text-center text-muted small mt-3">Henüz mesaj yok.</div>';
                pairs.forEach(uid => { 
                    const u = allUsersCache.find(x=>x.uid===uid); 
                    if(u) dList.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-1" onclick="openChat('${[curUser.uid,uid].sort().join('_')}','${u.name}')"><img src="${u.photoURL}" class="rounded-circle me-3" width="40"><div><div class="fw-bold">${u.name}</div></div></div>`; 
                }); 
            });
        }
        
        window.logout = () => signOut(auth);
        document.getElementById('form-register').addEventListener('submit',async e=>{ e.preventDefault(); const n=document.getElementById('r-name').value, em=document.getElementById('r-email').value, ps=document.getElementById('r-pass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,ps); const p=`https://ui-avatars.com/api/?name=${n}&background=random&color=fff`; await setDoc(doc(db,"users",c.user.uid),{ uid:c.user.uid, name:n, email:em, photoURL:p, createdAt:new Date(), isBanned:false, roles: ['Üye'], departments: ['...'] }); await updateProfile(c.user,{displayName:n,photoURL:p}); } catch(err){ showToast(err.message) } });
        document.getElementById('form-login').addEventListener('submit',async e=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth,document.getElementById('l-email').value,document.getElementById('l-pass').value) } catch(err){ showToast("Hata: " + err.message); } });
        window.uploadPhoto=(i)=>{const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{const im=new Image();im.src=e.target.result;im.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=150/Math.max(im.width,im.height);c.width=im.width*s;c.height=im.height*s;x.drawImage(im,0,0,c.width,c.height);const b=c.toDataURL('image/jpeg',0.7);updateDoc(doc(db,"users",curUser.uid),{photoURL:b}).then(()=>{uData.photoURL=b;loadProfile()})}};r.readAsDataURL(f);}
        window.openImgViewer = (src) => { document.getElementById('img-viewer-src').src = src; document.getElementById('img-viewer').style.display='flex'; }
    </script>
</body>
</html>
