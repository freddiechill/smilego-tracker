<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmileGO Tracker</title>
    
    <script src="https://cdn.median.co/median.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400,300&display=swap" rel="stylesheet">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "2657219b-d29e-46e1-ac6f-68d2cdb8014d" });
      });
    </script>

    <style>
        :root { --bg-dark: #09090b; --nav-dark: #101012; --primary: #818cf8; --sent-bg: #4f46e5; --recv-bg: #27272a; }
        body { background-color: var(--bg-dark); font-family: 'Satoshi', sans-serif; color: #fff; height: 100vh; overflow: hidden; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        button, a, input, select, textarea, .card-custom, .nav-btn, .clickable { cursor: pointer; pointer-events: auto !important; }

        .modal { z-index: 1000005 !important; }
        .modal-backdrop { z-index: 1000004 !important; }
        
        .app-header { height: 70px; position: fixed; top: 0; left: 0; width: 100%; background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; z-index: 9999; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-icon-btn { background: transparent !important; border: none !important; padding: 0 8px !important; color: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .bottom-nav { height: 85px; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(16, 16, 18, 0.98); border-top: 1px solid #27272a; z-index: 9999; display: flex; align-items: center; justify-content: space-around; padding-bottom: 15px; }
        .main-content { position: fixed; top: 70px; bottom: 85px; width: 100%; overflow-y: auto; padding: 20px; display: none; z-index: 1; }
        .main-content.active { display: block; animation: fadeIn 0.3s ease; }

        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .card-custom { background: #18181b; border: 1px solid #27272a; border-radius: 20px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition:0.2s; position: relative; }
        .card-custom:active { background: #202023; }
        .form-control, .form-select { background: #27272a; border: 1px solid #3f3f46; color: white; padding: 12px; border-radius: 12px; font-size: 14px; }
        .btn-primary-soft { background: var(--primary); color: #000; font-weight: 700; border-radius: 14px; border: none; padding: 14px; width: 100%; }

        /* CHAT */
        #chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: none; flex-direction: column; }
        #chat-overlay.open { display: flex; }
        .chat-body-scroll { flex: 1 1 auto; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 6px; background: #0b0b0d; }
        .chat-row { display: flex; width: 100%; align-items: flex-start; gap: 8px; margin-bottom: 2px; }
        .chat-row.right { justify-content: flex-end; }
        .chat-row.left { justify-content: flex-start; }
        .chat-avatar-img { width: 35px; height: 35px; border-radius: 50% !important; object-fit: cover !important; flex-shrink: 0; } 
        .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 14.5px; position: relative; word-wrap: break-word; user-select: none; display: flex; flex-direction: column; }
        .bubble-sent { background: var(--sent-bg); color: #fff; border-top-right-radius: 2px; margin-left: auto; }
        .bubble-received { background: var(--recv-bg); color: #fff; border-top-left-radius: 2px; margin-right: auto; }
        .msg-bubble a { color: #93c5fd; text-decoration: underline; word-break: break-all; }
        .sender-header { margin-bottom: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; line-height: 1.2; }
        .sender-name { font-weight: 800; font-size: 13px; }
        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        .chat-meta { font-size: 9px; opacity: 0.6; text-align: right; margin-top: 2px; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
        .edited-label { font-style: italic; }
        .reaction-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: -2px; margin-bottom: 6px; position: relative; z-index: 2; }
        .reaction-pill { background: #222; border: 1px solid #444; border-radius: 10px; padding: 1px 6px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .chat-badge { font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: 600; display: inline-block; }
        .cb-role { background: #3f3f46; color: #ddd; }
        .cb-dept { border: 1px solid #52525b; color: #a1a1aa; background: transparent; }

        /* Task & Stars */
        #star-select { display: flex; gap: 2px; align-items: center; }
        #star-select i { font-size: 24px; cursor: pointer; width: 24px; text-align: center; }
        
        .task-right-panel { 
            position: absolute; top: 12px; right: 12px; 
            display: flex; flex-direction: column; align-items: flex-end; gap: 4px; 
            width: 110px; pointer-events: none;
            text-align: right;
        }
        .task-icons { display: flex; gap: 8px; pointer-events: auto; margin-bottom: 2px; justify-content: flex-end; }
        .task-icons i { cursor: pointer; }
        .task-card-content { margin-right: 115px; }

        /* Filters */
        .filter-scroll-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .filter-scroll-container::-webkit-scrollbar { display: none; }
        .filter-btn { flex: 0 0 auto; min-width: auto; padding: 6px 16px; border-radius: 50px; font-size: 12px; }

        /* General UI */
        .dept-header { color: var(--primary); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 20px; margin-bottom: 10px; padding-left: 5px; border-left: 3px solid var(--primary); }
        .dept-group { background: rgba(255,255,255,0.02); border-radius: 16px; padding: 5px; border: 1px solid #27272a; margin-bottom: 10px; }
        .rounded-circle { border-radius: 50% !important; aspect-ratio: 1 / 1; object-fit: cover !important; }
        .role-badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #333; color: #ccc; border: 1px solid #444; }
        .dept-group > div:last-child, #td-status-list > div:last-child, #notif-list > div:last-child, #lb-list > div:last-child { border-bottom: none !important; margin-bottom: 0 !important; }
        .search-list { max-height: 200px; overflow-y: auto; background: #202023; border: 1px solid #333; border-radius: 0 0 12px 12px; display: none; position: absolute; width: 100%; z-index: 1000; }
        .search-list div { padding: 10px; cursor: pointer; border-bottom: 1px solid #2a2a2d; font-size: 13px; }
        .search-list div:hover { background: var(--primary); color: black; }

        .progress-ring { width: 60px; height: 60px; }
        .progress-ring__bg { stroke: rgba(255,255,255,0.1); }
        .progress-ring__circle { transition: 0.35s stroke-dashoffset; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .st-pending { background: rgba(255,255,255,0.1); color: #aaa; }
        .st-progress { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        .lb-tabs { display: flex; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .lb-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: bold; color: rgba(0,0,0,0.5); background: var(--bs-warning); transition: 0.2s; }
        .lb-tab.active { color: #000; border-bottom: 3px solid #000; }

        #app-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(30, 30, 35, 0.95); border: 1px solid #444; backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000008; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; min-width: 300px; justify-content: center; }
        #app-toast.show { transform: translateX(-50%) translateY(0); }
        
        #context-menu { position: fixed; background: #1c1c1e; border: 1px solid #333; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.9); display: none; flex-direction: column; min-width: 200px; overflow: hidden; z-index: 2000006; }
        .ctx-reactions { display: flex; padding: 10px; gap: 5px; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: #252529; }
        .ctx-emoji { font-size: 20px; cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 50%; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; gap: 10px; transition:0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .ctx-item:active { background: #333; }
        .ctx-item.delete { color: #ff6b6b; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000007; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #img-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000000; display: none; align-items: center; justify-content: center; }
        #img-viewer img { max-width: 100%; max-height: 100%; }
        .nav-btn { background: none; border: none; color: #52525b; flex: 1; height: 100%; font-size: 24px; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); }
    </style>
</head>
<body>

    <div id="app-toast"><i class="fas fa-info-circle text-primary fs-5"></i><span id="toast-msg" class="fw-bold small">...</span></div>
    <div class="modal fade" id="modal-confirm" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-4 text-center"><i class="fas fa-question-circle text-warning fa-3x mb-3"></i><h5 class="fw-bold mb-2">Emin misiniz?</h5><p class="text-muted small mb-4" id="confirm-text">...</p><div class="d-flex gap-2 justify-content-center"><button class="btn btn-dark border-secondary w-50" data-bs-dismiss="modal">Ä°ptal</button><button class="btn btn-danger w-50" id="confirm-btn-yes">Evet</button></div></div></div></div>
    <div id="context-menu"><div class="ctx-reactions"><span class="ctx-emoji" onclick="addReaction('â¤ï¸')">â¤ï¸</span><span class="ctx-emoji" onclick="addReaction('ğŸ‘')">ğŸ‘</span><span class="ctx-emoji" onclick="addReaction('ğŸ‘')">ğŸ‘</span><span class="ctx-emoji" onclick="addReaction('ğŸ™')">ğŸ™</span><span class="ctx-emoji" onclick="addReaction('âœï¸')">âœï¸</span><span class="ctx-emoji" onclick="addReaction('âœ…')">âœ…</span></div><div id="ctx-options"></div></div>
    <div id="loading-overlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div><div class="text-white mt-3 fw-bold" id="loading-text">YÃ¼kleniyor...</div></div>
    <div id="img-viewer"><button style="position:absolute;top:40px;right:20px;background:none;border:none;color:white;font-size:30px;z-index:2000001" onclick="closeImgViewer()"><i class="fas fa-times"></i></button><img id="img-viewer-src" src=""></div>

    <div id="auth-screen" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div id="auth-bg" style="position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at top right, #312e81 0%, #09090b 60%);z-index:-1"></div>
        <div class="glass-card">
            <div class="text-center mb-4"><img src="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/smilegologotracker.png" alt="SmileGO" style="width: 170px;"></div>
            <ul class="nav nav-pills nav-fill mb-4 bg-dark rounded p-1" style="border: 1px solid #333"><li class="nav-item"><a class="nav-link active rounded" data-bs-toggle="pill" href="#tab-login">GiriÅŸ</a></li><li class="nav-item"><a class="nav-link rounded" data-bs-toggle="pill" href="#tab-register">KayÄ±t</a></li></ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-login"><form id="form-login"><input type="email" id="l-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="l-pass" class="form-control mb-4" placeholder="Åifre" required><button class="btn-primary-soft">GiriÅŸ Yap</button></form></div>
                <div class="tab-pane fade" id="tab-register"><form id="form-register"><input id="r-name" class="form-control mb-3" placeholder="Ad Soyad" required><input id="r-email" class="form-control mb-3" placeholder="Email" required><input type="password" id="r-pass" class="form-control mb-3" placeholder="Åifre (min 6)" required><div class="text-muted small mb-2">Departman ve Rol Admin tarafÄ±ndan atanacaktÄ±r.</div><button class="btn-primary-soft">KayÄ±t Ol</button></form></div>
            </div>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <header class="app-header">
            <h5 class="m-0 fw-bold" id="page-title">GÃ¶rev Panosu</h5>
            <div class="d-flex gap-2 align-items-center">
                <button class="header-icon-btn" onclick="openLeaderboard()"><i class="fas fa-trophy text-warning"></i></button>
                <div class="position-relative"><button class="header-icon-btn" onclick="openNotifs()"><i class="fas fa-bell"></i></button><div id="notif-dot" class="notif-dot" style="position:absolute;top:5px;right:5px;width:8px;height:8px;background:red;border-radius:50%;display:none;border:1px solid #000"></div></div>
            </div>
        </header>

        <div id="view-tasks" class="main-content active">
            <button id="btn-add-task" class="btn-primary-soft mb-4 shadow-sm" onclick="openTaskModal()"><i class="fas fa-plus me-2"></i> Yeni GÃ¶rev Ekle</button>
            <div class="filter-scroll-container mb-3">
                <button class="btn btn-outline-secondary rounded-pill filter-btn active" onclick="filterTasks('all', this)">TÃ¼mÃ¼</button>
                <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('week', this)">Bu Hafta</button>
                <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('pending', this)">BaÅŸlamadÄ±</button>
                <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('progress', this)">YapÄ±lÄ±yor</button>
                <button class="btn btn-outline-secondary rounded-pill filter-btn" onclick="filterTasks('done', this)">Bitti</button>
            </div>
            <div id="task-list" class="d-flex flex-column gap-2"></div>
        </div>

        <div id="view-messages" class="main-content"><h6 class="text-muted small fw-bold mb-3 ls-1">GRUPLAR</h6><div id="channel-list" class="d-flex flex-column gap-2 mb-4"></div><h6 class="text-muted small fw-bold mb-3 ls-1">Ã–ZEL MESAJLAR</h6><div id="dm-list" class="d-flex flex-column gap-2"></div></div>
        <div id="view-team" class="main-content"><input type="text" class="form-control mb-4" placeholder="Ekipte ara (Ä°sim, Rol, Dept)..." onkeyup="renderTeam(this.value)"><div id="team-list"></div></div>
        
        <div id="view-profile" class="main-content">
            <div class="text-center">
                <div class="mb-3 position-relative d-inline-block">
                    <img id="prof-img" src="" class="rounded-circle border border-2 border-secondary p-1" style="width:110px; height:110px;">
                    <label for="file-inp" class="position-absolute bottom-0 end-0 bg-white text-dark rounded-circle d-flex align-items-center justify-content-center shadow" style="width:35px;height:35px;cursor:pointer"><i class="fas fa-camera small"></i></label>
                    <input type="file" id="file-inp" class="d-none" accept="image/*" onchange="uploadPhoto(this)">
                </div>
                <div class="d-flex align-items-center justify-content-center gap-2 mb-1"><h4 id="prof-name" class="fw-bold m-0">...</h4><i class="fas fa-pen text-secondary clickable" onclick="editMyName()"></i></div>
                <div id="prof-roles" class="d-flex justify-content-center flex-wrap gap-2 mb-2"></div>
                <div class="card-custom p-3 mt-3 d-flex align-items-center justify-content-between">
                    <div class="text-start"><div class="text-muted small">GÃ¶rev BaÅŸarÄ±mÄ±</div><h4 class="fw-bold m-0" id="prof-rate">0%</h4></div>
                    <svg class="progress-ring" width="60" height="60"><circle class="progress-ring__bg" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"/><circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="prof-circle" stroke-dasharray="163.36" stroke-dashoffset="163.36"/></svg>
                </div>
            </div>
             <div class="card-custom mt-3">
                <h6 class="fw-bold text-muted mb-3">KÄ°ÅÄ°SEL BÄ°LGÄ°LER</h6>
                <div class="mb-3 position-relative"><label class="small text-muted">Ãœniversite</label><input type="text" class="form-control" id="inp-uni" placeholder="Ãœniversite Ara..." onkeyup="filterSearch('uni')"><div class="search-list" id="list-uni"></div></div>
                <div class="mb-3 position-relative"><label class="small text-muted">BÃ¶lÃ¼m</label><input type="text" class="form-control" id="inp-sec" placeholder="BÃ¶lÃ¼m Ara..." onkeyup="filterSearch('sec')"><div class="search-list" id="list-sec"></div></div>
                <div class="row"><div class="col-6 mb-3"><label class="small text-muted">Ä°l</label><input type="text" class="form-control" id="inp-city" placeholder="Ä°l"></div><div class="col-6 mb-3"><label class="small text-muted">Ä°lÃ§e</label><input type="text" class="form-control" id="inp-dist" placeholder="Ä°lÃ§e"></div></div>
                <div class="mb-3"><label class="small text-muted">DoÄŸum Tarihi</label><input type="date" class="form-control" id="inp-dob"></div>
                <div class="mb-3"><label class="small text-muted">Telefon</label><input type="tel" class="form-control" id="inp-phone" placeholder="0555..."></div>
                <div class="mb-3"><label class="small text-muted">E-Posta</label><input type="email" class="form-control" id="inp-email" placeholder="iletisim@..."></div>
                <button class="btn btn-sm btn-success w-100" onclick="saveEduInfo()">Bilgileri Kaydet</button>
             </div>
             <div class="card-custom mt-2">
                <h6 class="fw-bold text-muted mb-3">SOSYAL MEDYA</h6>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-linkedin"></i></span><input id="sm-linkedin" class="form-control" placeholder="LinkedIn"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-instagram"></i></span><input id="sm-instagram" class="form-control" placeholder="Instagram"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-twitter"></i></span><input id="sm-x" class="form-control" placeholder="X (Twitter)"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-tiktok"></i></span><input id="sm-tiktok" class="form-control" placeholder="TikTok"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-youtube"></i></span><input id="sm-youtube" class="form-control" placeholder="YouTube"></div>
                <div class="input-group mb-2"><span class="input-group-text bg-dark border-secondary"><i class="fab fa-kickstarter"></i></span><input id="sm-kick" class="form-control" placeholder="Kick"></div>
                <button class="btn btn-sm btn-success w-100 mt-2" onclick="saveSocials()">Sosyal MedyayÄ± Kaydet</button>
             </div>
             <button class="btn btn-outline-danger w-100 mt-4 py-3 rounded-4 fw-bold" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="goTab('tasks',this)"><i class="fas fa-check-circle"></i></button>
            <button class="nav-btn" onclick="goTab('messages',this)"><i class="fas fa-paper-plane"></i></button>
            <button class="nav-btn" onclick="goTab('team',this)"><i class="fas fa-users"></i></button>
            <button class="nav-btn" onclick="goTab('profile',this)"><i class="fas fa-user"></i></button>
        </nav>
    </div>

    <div id="chat-overlay">
        <div style="flex: 0 0 70px; background: rgba(9, 9, 11, 0.95); border-bottom: 1px solid #27272a; display: flex; align-items: center; padding: 0 20px;">
            <button class="btn text-white me-2 p-0" onclick="closeChat()"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h6 class="m-0 fw-bold text-white" id="chat-overlay-title">Sohbet</h6>
        </div>
        <div class="chat-body-scroll" id="chat-overlay-body"></div>
        <form id="chat-form" style="flex: 0 0 auto; background: var(--nav-dark); border-top: 1px solid #27272a; padding: 15px; padding-bottom: 25px; display: flex; gap: 10px;">
            <input type="file" id="chat-file-inp" hidden>
            <button type="button" class="btn btn-dark text-muted rounded-circle" style="width:45px;height:45px" onclick="document.getElementById('chat-file-inp').click()"><i class="fas fa-paperclip"></i></button>
            <input id="chat-input" class="form-control" placeholder="Mesaj yaz..." style="border-radius:20px" autocomplete="off">
            <button type="submit" class="btn btn-primary rounded-circle" style="width:45px;height:45px"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div class="modal fade" id="modal-edit-msg" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">MesajÄ± DÃ¼zenle</h5><input id="edit-msg-input" class="form-control mb-3"><button class="btn-primary-soft" onclick="submitEditMsg()">Kaydet</button></div></div></div>
    <div class="modal fade" id="modal-reactions" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Tepkiler</h5><div id="reaction-list" style="max-height:300px;overflow-y:auto"></div><div class="d-flex justify-content-end mt-2"><button class="btn btn-dark btn-sm" data-bs-dismiss="modal">Kapat</button></div></div></div></div>

    <div class="modal fade" id="modal-task" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">GÃ¶revi YÃ¶net</h5><form id="form-task">
        <input type="hidden" id="t-id">
        <input id="t-title" class="form-control mb-3" placeholder="BaÅŸlÄ±k" required>
        <textarea id="t-desc" class="form-control mb-3" placeholder="AÃ§Ä±klama" rows="3"></textarea>
        <div class="mb-3"><label class="small text-muted">Son Tarih (Opsiyonel)</label><input type="datetime-local" id="t-deadline" class="form-control"></div>
        <div class="mb-3 fs-4 text-warning" id="star-select"><i class="far fa-star clickable" onclick="setStars(1)"></i><i class="far fa-star clickable" onclick="setStars(2)"></i><i class="far fa-star clickable" onclick="setStars(3)"></i><i class="far fa-star clickable" onclick="setStars(4)"></i><i class="far fa-star clickable" onclick="setStars(5)"></i></div><input type="hidden" id="t-stars" value="0">
        <select id="t-type" class="form-select mb-3" onchange="togT(this.value)"><option value="department">Departman</option><option value="user">KiÅŸi</option><option value="all">Herkes</option></select>
        <select id="t-dept" class="form-select mb-3"></select>
        <select id="t-user" class="form-select mb-4 d-none"></select> <button type="button" class="btn-primary-soft" onclick="saveTask()">Kaydet</button>
    </form></div></div></div>

    <div class="modal fade" id="modal-task-detail" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3">
        <div class="d-flex justify-content-between align-items-start mb-3"><div style="flex:1; margin-right:10px;"><h5 class="fw-bold mb-1" id="td-title">...</h5><div id="td-assignees" class="d-flex align-items-center mb-1"></div></div><div class="text-end" id="td-meta"></div></div>
        <div class="d-flex flex-wrap gap-2 mb-2 align-items-center" id="td-stars-wrapper"></div>
        <div class="bg-dark p-2 rounded mb-3 small text-muted" id="td-desc" style="max-height:100px;overflow-y:auto"></div>
        <h6 class="small fw-bold text-muted mb-2">DURUM LÄ°STESÄ°</h6><div id="td-status-list" class="d-flex flex-column gap-2" style="max-height: 200px; overflow-y: auto;"></div><div class="d-flex justify-content-end mt-3"><button class="btn btn-dark border-secondary btn-sm" data-bs-dismiss="modal">Kapat</button></div></div></div></div>

    <div class="modal fade" id="modal-profile-view" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-4 position-relative">
        <button class="btn btn-sm btn-dark position-absolute top-0 end-0 m-3 rounded-circle" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
        <div class="d-flex align-items-center gap-3 mb-3 text-start"><img id="vp-img" src="" class="rounded-circle border border-2 border-secondary p-1" width="110" height="110"><div><h4 id="vp-name" class="fw-bold mb-1">...</h4><div id="vp-badges" class="d-flex flex-wrap gap-1"></div></div></div>
        <div class="mb-3 text-start">
             <div class="small text-muted mb-1"><i class="fas fa-university me-1"></i> <span id="vp-uni" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-graduation-cap me-1"></i> <span id="vp-dept" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i> <span id="vp-address" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-birthday-cake me-1"></i> <span id="vp-dob" class="text-white">...</span></div>
             <div class="small text-muted mb-1"><i class="fas fa-phone me-1"></i> <span id="vp-phone" class="text-white">...</span></div>
             <div class="small text-muted"><i class="fas fa-envelope me-1"></i> <span id="vp-email" class="text-white">...</span></div>
        </div>
        <div class="card-custom bg-dark p-3 d-flex align-items-center justify-content-between mb-3"><div class="text-start"><div class="text-muted small">Genel BaÅŸarÄ±</div><h4 class="fw-bold m-0" id="vp-rate">0%</h4></div><svg width="50" height="50" viewBox="0 0 60 60"><circle class="progress-ring__bg" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30"/><circle class="progress-ring__circle" stroke="var(--primary)" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="vp-circle" stroke-dasharray="163.36" stroke-dashoffset="163.36"/></svg></div>
        <h6 class="small fw-bold text-muted mb-2">SOSYAL MEDYA</h6><div id="vp-socials" class="d-flex justify-content-center gap-3 fs-3"></div>
    </div></div></div>

    <div class="modal fade" id="modal-user-edit" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Ãœye DÃ¼zenle (Admin)</h5><h6 id="ue-name" class="text-primary mb-3"></h6><div id="ue-roles" class="d-flex flex-wrap gap-2 mb-3"></div><div id="ue-depts" class="d-flex flex-wrap gap-2 mb-3"></div><button class="btn btn-success w-100" onclick="saveUserEdit()">Kaydet</button></div></div></div>
    <div class="modal fade" id="modal-leaderboard" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-0 overflow-hidden"><div class="bg-warning p-3 text-center"><h5 class="fw-bold m-0 text-black"><i class="fas fa-trophy me-2"></i>SÄ±ralama</h5></div><div class="lb-tabs"><div class="lb-tab active" onclick="switchLB('genel', this)">Genel</div><div class="lb-tab" onclick="switchLB('haftalik', this)">HaftalÄ±k</div></div><div id="lb-list" class="p-3" style="max-height: 50vh; overflow-y: auto;"></div></div></div></div>
    <div class="modal fade" id="modal-notif" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content card-custom border-0 p-3"><h5 class="fw-bold mb-3">Bildirimler</h5><div id="notif-list" style="max-height:50vh;overflow-y:auto"></div></div></div></div>
    <div class="modal fade" id="modal-status" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content card-custom border-0 p-3 text-center"><h6 class="mb-3">Durum GÃ¼ncelle</h6><div class="d-grid gap-2"><button class="btn btn-outline-secondary" onclick="updateTaskStatus('pending')">BaÅŸlamadÄ±</button><button class="btn btn-outline-primary" onclick="updateTaskStatus('progress')">YapÄ±lÄ±yor</button><button class="btn btn-outline-success" onclick="updateTaskStatus('done')">Bitti</button></div></div></div></div>
    <div class="modal fade" id="modal-name-edit" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content card-custom border-0 p-3"><h6 class="mb-3">Ä°sim DeÄŸiÅŸtir</h6><input id="inp-new-name" class="form-control mb-3"><button class="btn btn-success w-100" onclick="saveMyName()">Kaydet</button></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, query, where, onSnapshot, orderBy, updateDoc, deleteDoc, getDocs, getDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDHbuPLeir2dn9BFI7Rt2AxUp_6E0VFy_8", authDomain: "smilego-tracker.firebaseapp.com", projectId: "smilego-tracker", storageBucket: "smilego-tracker.firebasestorage.app", messagingSenderId: "49933018016", appId: "1:49933018016:web:f69bf14464bfd4399a3ac5" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        const ADMIN_EMAIL = "yenerarda7@gmail.com";
        const DEPTS = ["Organizasyonel GeliÅŸim","Sosyal Medya","BÃ¶lge KoordinatÃ¶rlÃ¼ÄŸÃ¼","Psikolog Ä°liÅŸkileri","Data & Planlama","Kurumsal Ä°letiÅŸim", "YazÄ±lÄ±m"];
        const DEPT_ABBR = { "Sosyal Medya": "SMD", "Psikolog Ä°liÅŸkileri": "PÄ°D", "Data & Planlama": "DPD", "BÃ¶lge KoordinatÃ¶rlÃ¼ÄŸÃ¼": "BKD", "Kurumsal Ä°letiÅŸim": "KÄ°D", "Organizasyonel GeliÅŸim": "OGD", "YazÄ±lÄ±m": "YD" };
        const ROLES = ["BaÅŸkan", "YK", "YKY", "Ãœye", "Admin"];
        const UNIVERSITIES = ["Sakarya Ãœniversitesi", "Sakarya UygulamalÄ± Bilimler Ãœniversitesi", "Ä°stanbul Ãœniversitesi", "ODTÃœ", "Ä°TÃœ", "BoÄŸaziÃ§i Ãœniversitesi", "Marmara Ãœniversitesi", "YÄ±ldÄ±z Teknik Ãœniversitesi", "Hacettepe Ãœniversitesi", "Ankara Ãœniversitesi", "Ege Ãœniversitesi", "Dokuz EylÃ¼l Ãœniversitesi", "Gazi Ãœniversitesi", "Anadolu Ãœniversitesi", "Akdeniz Ãœniversitesi", "Ã‡ukurova Ãœniversitesi", "Bilkent Ãœniversitesi", "KoÃ§ Ãœniversitesi", "SabancÄ± Ãœniversitesi", "Yeditepe Ãœniversitesi", "BahÃ§eÅŸehir Ãœniversitesi", "Kocaeli Ãœniversitesi", "DÃ¼zce Ãœniversitesi", "Bolu Abant Ä°zzet Baysal Ãœniversitesi", "Galatasaray Ãœniversitesi", "Mimar Sinan GÃ¼zel Sanatlar Ãœniversitesi"];
        const DEPARTMENTS_UNI = ["GÃ¶rsel Ä°letiÅŸim TasarÄ±mÄ±", "Ä°letiÅŸim TasarÄ±mÄ±", "Grafik TasarÄ±m", "Ã‡izgi Film ve Animasyon", "Radyo, Televizyon ve Sinema", "Halkla Ä°liÅŸkiler ve ReklamcÄ±lÄ±k", "Yeni Medya ve Ä°letiÅŸim", "Bilgisayar MÃ¼hendisliÄŸi", "YazÄ±lÄ±m MÃ¼hendisliÄŸi", "EndÃ¼stri MÃ¼hendisliÄŸi", "Ä°ÅŸletme", "Ä°ktisat", "Maliye", "UluslararasÄ± Ä°liÅŸkiler", "Siyaset Bilimi ve Kamu YÃ¶netimi", "Psikoloji", "Sosyoloji", "Felsefe", "Hukuk", "TÄ±p", "DiÅŸ HekimliÄŸi", "EczacÄ±lÄ±k", "HemÅŸirelik", "MimarlÄ±k", "Ä°Ã§ MimarlÄ±k", "Åehir ve BÃ¶lge Planlama", "Ã–zel EÄŸitim Ã–ÄŸretmenliÄŸi", "Okul Ã–ncesi Ã–ÄŸretmenliÄŸi", "SÄ±nÄ±f Ã–ÄŸretmenliÄŸi", "Ä°ngilizce Ã–ÄŸretmenliÄŸi", "Matematik", "Fizik", "Kimya", "Biyoloji", "Tarih", "CoÄŸrafya", "TÃ¼rk Dili ve EdebiyatÄ±", "EndÃ¼striyel TasarÄ±m", "Moda TasarÄ±mÄ±", "Resim", "Heykel", "Seramik"];

        let curUser=null, uData={}, activeChatId=null;
        let unsubUser=null, unsubTasks=null, unsubTeam=null, unsubChat=null, unsubNotif=null, unsubDMs=null;
        let allUsersCache=[], allTasksCache={};
        let selectedTaskForStatus = null, selectedUserForEdit = null, selectedMsg = null, longPressTimer = null;
        let lbMode = 'genel';

        const NAME_COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e', '#e879f9', '#2dd4bf'];
        function getUserColor(uid) { let hash = 0; for (let i = 0; i < uid.length; i++) { hash = uid.charCodeAt(i) + ((hash << 5) - hash); } return NAME_COLORS[Math.abs(hash) % NAME_COLORS.length]; }

        window.showToast = (msg) => { const t = document.getElementById('app-toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        window.alert = window.showToast;
        window.customConfirm = (text, cb) => { document.getElementById('confirm-text').innerText = text; const modal = new bootstrap.Modal(document.getElementById('modal-confirm')); document.getElementById('confirm-btn-yes').onclick = () => { cb(); modal.hide(); }; modal.show(); };

        function getWeekRange() {
            const now = new Date();
            const day = now.getDay(); 
            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
            const start = new Date(now.setDate(diff)); start.setHours(0,0,0,0);
            const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999);
            return { start, end };
        }

        let chatOpen = false;
        window.onpopstate = () => {
            if(chatOpen) { closeChat(); return; }
            const activeModal = document.querySelector('.modal.show');
            if(activeModal) { bootstrap.Modal.getInstance(activeModal).hide(); }
        };
        const pushState = () => window.history.pushState(null, null, window.location.href);

        onAuthStateChanged(auth, async u => {
            if(u){
                curUser = u;
                unsubUser = onSnapshot(doc(db,"users",u.uid), s => {
                    if(s.exists()){
                        uData = s.data();
                        if(uData.isBanned) { signOut(auth); showToast("Hesap eriÅŸimi engellendi."); return; }
                        if(!Array.isArray(uData.roles)) uData.roles = [uData.role || 'Ãœye'];
                        if(!Array.isArray(uData.departments)) uData.departments = [uData.department || '...'];
                        if(u.email === ADMIN_EMAIL && !uData.roles.includes('Admin')) uData.roles.push('Admin');
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('app-screen').style.display = 'block';
                        initApp();
                    }
                });
                if(window.OneSignalDeferred) OneSignalDeferred.push(()=>OneSignal.login(u.uid));
            } else {
                cleanup(); document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function initApp() {
            loadProfile(); listenTasks(); listenTeam(); loadChannels(); listenNotifs(); loadRecentDMs();
            const dSelect = document.getElementById('t-dept'); dSelect.innerHTML='';
            DEPTS.forEach(d => dSelect.innerHTML += `<option>${d}</option>`);
            if(!canManageUsers() && !uData.roles.includes('YK') && !uData.roles.includes('YKY')) { document.getElementById('btn-add-task').style.display = 'none'; }
        }

        function cleanup() { if(unsubUser) unsubUser(); if(unsubTasks) unsubTasks(); if(unsubTeam) unsubTeam(); if(unsubChat) unsubChat(); if(unsubNotif) unsubNotif(); if(unsubDMs) unsubDMs(); curUser=null; uData={}; }
        const isAdmin = () => uData.roles?.includes('Admin');
        const isPres = () => uData.roles?.includes('BaÅŸkan');
        const canManageUsers = () => isAdmin() || isPres();
        const canSeeAllTasks = () => isAdmin(); 
        const canSeeAllChannels = () => uData.roles?.some(r => ['YK','BaÅŸkan','Admin'].includes(r));
        const isBoard = () => uData.roles?.some(r => ['YK','YKY','BaÅŸkan','Admin'].includes(r));

        window.loadProfile = () => {
            document.getElementById('prof-img').src = uData.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('prof-name').innerText = uData.name;
            const rDiv = document.getElementById('prof-roles'); rDiv.innerHTML='';
            rDiv.className = "d-flex justify-content-center flex-wrap gap-2 mb-2"; 
            uData.roles.forEach(r => rDiv.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            uData.departments.forEach(d => { 
                const abbr = DEPT_ABBR[d] || d.substring(0,3); 
                rDiv.innerHTML += `<span class="badge bg-dark border border-secondary text-muted small ms-1">${abbr}</span>`; 
            });
            document.getElementById('inp-uni').value = uData.university || '';
            document.getElementById('inp-sec').value = uData.uni_dept || '';
            document.getElementById('inp-city').value = uData.city || '';
            document.getElementById('inp-dist').value = uData.district || '';
            document.getElementById('inp-dob').value = uData.dob || '';
            document.getElementById('inp-phone').value = uData.phone || '';
            document.getElementById('inp-email').value = uData.contactEmail || uData.email || '';
            if(uData.socials) { ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => { document.getElementById(`sm-${k}`).value = uData.socials[k] || ''; }); }
            calcSuccessRate();
        };

        window.calcSuccessRate = () => {
            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => { if(t.statusMap && t.statusMap[curUser.uid]) { total++; if(t.statusMap[curUser.uid] === 'done') done++; } });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('prof-rate').innerText = `%${rate}`;
            const circle = document.getElementById('prof-circle');
            circle.style.strokeDashoffset = (163.36 * (100 - rate)) / 100;
        };

        window.saveEduInfo = async () => { 
            await updateDoc(doc(db,"users",curUser.uid), { 
                university: document.getElementById('inp-uni').value, 
                uni_dept: document.getElementById('inp-sec').value,
                city: document.getElementById('inp-city').value,
                district: document.getElementById('inp-dist').value,
                dob: document.getElementById('inp-dob').value,
                phone: document.getElementById('inp-phone').value,
                contactEmail: document.getElementById('inp-email').value
            }); 
            showToast("Kaydedildi!"); 
        };
        window.saveSocials = async () => { const soc = {}; ['linkedin','instagram','x','tiktok','youtube','kick'].forEach(k => { const v = document.getElementById(`sm-${k}`).value.trim(); if(v) soc[k] = v; }); await updateDoc(doc(db,"users",curUser.uid), { socials: soc }); showToast("Kaydedildi!"); };
        
        window.editMyName = () => { document.getElementById('inp-new-name').value = uData.name; new bootstrap.Modal(document.getElementById('modal-name-edit')).show(); }
        window.saveMyName = async () => {
             const newName = document.getElementById('inp-new-name').value;
             if(newName) {
                 await updateDoc(doc(db,"users",curUser.uid), { name: newName });
                 showToast("Ä°sim gÃ¼ncellendi.");
                 bootstrap.Modal.getInstance(document.getElementById('modal-name-edit')).hide();
             }
        }

        window.filterSearch = (type) => {
            const inp = document.getElementById(`inp-${type}`); const list = document.getElementById(`list-${type}`);
            const val = inp.value.toLowerCase(); const source = type === 'uni' ? UNIVERSITIES : DEPARTMENTS_UNI;
            list.innerHTML = ''; if(val.length < 1) { list.style.display='none'; return; }
            source.filter(s => s.toLowerCase().includes(val)).forEach(m => { const d = document.createElement('div'); d.innerText = m; d.onclick = () => { inp.value = m; list.style.display='none'; }; list.appendChild(d); });
            list.style.display = 'block';
        };

        window.togT=(v)=>{
            document.getElementById('t-dept').classList.toggle('d-none',v!=='department');
            document.getElementById('t-user').classList.toggle('d-none',v!=='user');
        };

        function linkify(text) {
            const urlRegex = /((https?:\/\/)|(www\.))?[\w-]+\.[\w.\/]+(\?[\w=&]*)?/g;
            return text.replace(urlRegex, function(url) {
                let href = url;
                if (!href.match(/^https?:\/\//)) { href = 'https://' + href; }
                return `<a href="${href}" target="_blank">${url}</a>`;
            });
        }

        function formatDeadline(dl) {
            if(!dl) return '';
            const date = new Date(dl);
            const dateStr = date.toLocaleString('tr-TR', { day: 'numeric', month: 'short', weekday: 'short', hour: '2-digit', minute: '2-digit' });
            
            const diff = date - new Date();
            if(diff < 0) return `<div class="d-flex flex-column align-items-end"><span class="small text-muted">${dateStr}</span><span class="badge bg-danger" style="font-size:10px">SÃ¼re Doldu!</span></div>`;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const timeRem = days > 0 ? `${days} gÃ¼n` : `${hours} saat`;
            return `<div class="d-flex flex-column align-items-end"><span class="small text-muted">${dateStr}</span><span class="badge bg-warning text-dark" style="font-size:10px">${timeRem} kaldÄ±</span></div>`;
        }

        // --- YENÄ° RENDER FONKSÄ°YONU ---
        // Bu fonksiyon gÃ¶revleri ekrana basar. Hem listenTasks hem de listenTeam tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r.
        window.renderTasksToPage = () => {
             const list = document.getElementById('task-list'); 
             list.innerHTML = ''; 
             
             // allTasksCache bir obje olduÄŸu iÃ§in diziye Ã§eviriyoruz
             let tempArr = Object.values(allTasksCache);
             
             // SÄ±ralama: En yeni en Ã¼stte
             tempArr.sort((a,b) => b.createdAt - a.createdAt);
             
             // Filtreleri kontrol et
             const filterBtn = document.querySelector('.btn-outline-secondary.active');
             const filter = filterBtn ? filterBtn.innerText : 'TÃ¼mÃ¼';
             const { start, end } = getWeekRange();

             tempArr.forEach(t => {
                let myStatus = 'pending';
                if(t.statusMap) {
                    if(t.statusMap[curUser.uid]) myStatus = t.statusMap[curUser.uid];
                    else if(t.assignedToUid !== curUser.uid) myStatus = Object.values(t.statusMap)[0] || 'pending';
                }
                
                if(filter === 'Bu Hafta') {
                    const tDate = t.createdAt.toDate();
                    if(tDate < start || tDate > end) return;
                }
                if(filter === 'BaÅŸlamadÄ±' && myStatus !== 'pending') return;
                if(filter === 'YapÄ±lÄ±yor' && myStatus !== 'progress') return;
                if(filter === 'Bitti' && myStatus !== 'done') return;

                let starsHtml = ''; for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning" style="font-size:10px"></i>';
                const stClass = myStatus === 'pending' ? 'st-pending' : (myStatus === 'progress' ? 'st-progress' : 'st-done');
                const stText = myStatus === 'pending' ? 'BaÅŸlamadÄ±' : (myStatus === 'progress' ? 'YapÄ±lÄ±yor' : 'Bitti');
                const isAssignedToMe = (t.assignedType==='all') || (t.assignedType==='department' && uData.departments.includes(t.assignedTo)) || (t.assignedType==='user' && t.assignedToUid===curUser.uid);
                
                const dlBadge = formatDeadline(t.deadline);
                const canEdit = (t.createdByUid === curUser.uid || isAdmin());

                let assigneesHtml = '';
                if(t.assignedType === 'user' && t.assignedToUid) {
                    // Ä°ÅŸte burasÄ± artÄ±k gÃ¼ncel allUsersCache'den okuyacak!
                    const u = allUsersCache.find(x => x.uid === t.assignedToUid);
                    const p = u ? u.photoURL : 'https://ui-avatars.com/api/?name=U';
                    const n = u ? u.name : t.assignedTo;
                    assigneesHtml = `<div class="d-flex align-items-center gap-2 px-3 py-1 border border-secondary rounded"><img src="${p}" class="rounded-circle" width="20"><span class="small">${n}</span></div>`;
                } else {
                    const abbr = DEPT_ABBR[t.assignedTo] || t.assignedTo;
                    assigneesHtml = `<span class="badge bg-dark border border-secondary text-muted">${abbr}</span>`;
                }

                list.innerHTML += `
                <div class="card-custom position-relative" onclick="openTaskDetail('${t.id}'); pushState()">
                    <div class="task-right-panel">
                        ${canEdit ? `<div class="task-icons">
                            <i class="fas fa-edit text-warning clickable" onclick="event.stopPropagation();openTaskModal('${t.id}')"></i>
                            <i class="fas fa-trash text-danger clickable" onclick="event.stopPropagation();delTask('${t.id}')"></i>
                        </div>` : ''}
                        ${dlBadge}
                    </div>
                    
                    <div class="task-card-content" style="margin-right: 90px;">
                        <h6 class="fw-bold mb-1 text-truncate">${t.title}</h6>
                        <div class="d-flex align-items-center gap-2 mb-2">${assigneesHtml} <div class="d-flex" style="gap:2px">${starsHtml}</div></div>
                    </div>

                    <p class="text-muted small mb-3 text-truncate" style="margin-right:90px">${t.description || ''}</p>
                    
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2"><img src="${t.creatorPhoto || 'https://ui-avatars.com/api/?name=User'}" class="rounded-circle" width="20"><small class="text-muted" style="font-size:11px">${t.creatorName}</small></div>
                        ${isAssignedToMe ? `<button class="btn btn-sm status-badge ${stClass}" onclick="event.stopPropagation();openStatusModal('${t.id}'); pushState()">${stText}</button>` : `<span class="status-badge ${stClass}">${stText}</span>`}
                    </div>
                </div>`;
            });
            calcSuccessRate();
        };

        function listenTasks() {
            if(unsubTasks) unsubTasks();
            unsubTasks = onSnapshot(collection(db,"tasks"), s => {
                allTasksCache = {}; 
                s.forEach(d => {
                    const t = { id: d.id, ...d.data() }; 
                    const isAssignedToMe = (t.assignedType==='all') || (t.assignedType==='department' && uData.departments.includes(t.assignedTo)) || (t.assignedType==='user' && t.assignedToUid===curUser.uid);
                    if(t.createdByUid === curUser.uid || isAssignedToMe || canSeeAllTasks()) { 
                        allTasksCache[t.id] = t; 
                    }
                });
                renderTasksToPage(); // Veri geldiÄŸinde render et
            });
        }

        window.openTaskModal = async (editId = null) => {
            document.getElementById('form-task').reset(); 
            document.getElementById('t-id').value = '';
            setStars(0);
            
            const userSelect = document.getElementById('t-user'); userSelect.innerHTML = '';
            const snap = await getDocs(collection(db,"users"));
            snap.forEach(d => { 
                if(d.id !== curUser.uid && !d.data().isBanned)
                    userSelect.innerHTML += `<option value="${d.id}" data-role="${d.data().roles}">${d.data().name}</option>`; 
            });

            if(editId) {
                const t = allTasksCache[editId];
                if(t) {
                    document.getElementById('t-id').value = editId;
                    document.getElementById('t-title').value = t.title;
                    document.getElementById('t-desc').value = t.description;
                    document.getElementById('t-deadline').value = t.deadline || '';
                    setStars(t.importance || 0);
                    document.getElementById('t-type').value = t.assignedType;
                    togT(t.assignedType);
                    setTimeout(() => {
                        if(t.assignedType === 'department') document.getElementById('t-dept').value = t.assignedTo;
                        if(t.assignedType === 'user') document.getElementById('t-user').value = t.assignedToUid;
                    }, 100);
                }
            } else {
                 document.getElementById('t-type').value = 'department';
                 togT('department');
            }

            new bootstrap.Modal(document.getElementById('modal-task')).show(); pushState();
        };

        window.openTaskDetail = (tid) => {
            const t = allTasksCache[tid]; if(!t) return;
            document.getElementById('td-title').innerText = t.title;
            
            const dlBadge = formatDeadline(t.deadline);
            document.getElementById('td-meta').innerHTML = dlBadge;

            let assigneesHtml = '';
            if(t.assignedType === 'user' && t.assignedToUid) {
                 const u = allUsersCache.find(x => x.uid === t.assignedToUid);
                 const p = u ? u.photoURL : 'https://ui-avatars.com/api/?name=U';
                 const n = u ? u.name : t.assignedTo;
                 assigneesHtml = `<div class="d-flex align-items-center gap-2 px-3 py-1 border border-secondary rounded"><img src="${p}" class="rounded-circle" width="25"><span class="small">${n}</span></div>`;
            } else { assigneesHtml = `<span class="badge bg-secondary">${t.assignedTo}</span>`; }
            document.getElementById('td-assignees').innerHTML = assigneesHtml;

            document.getElementById('td-desc').innerText = t.description || 'AÃ§Ä±klama yok.';
            let starsHtml = ''; for(let i=0; i<(t.importance||0); i++) starsHtml += '<i class="fas fa-star text-warning me-1"></i>';
            document.getElementById('td-stars-wrapper').innerHTML = starsHtml; // Fixed ID usage
            
            const list = document.getElementById('td-status-list'); list.innerHTML = '';
            if(t.statusMap) {
                Object.entries(t.statusMap).forEach(([uid, status]) => {
                    const user = allUsersCache.find(u => u.uid === uid);
                    const name = user ? user.name : "KullanÄ±cÄ±";
                    const stText = status === 'pending' ? 'BaÅŸlamadÄ±' : (status === 'progress' ? 'YapÄ±lÄ±yor' : 'Bitti');
                    const stColor = status === 'pending' ? 'text-secondary' : (status === 'progress' ? 'text-primary' : 'text-success');
                    list.innerHTML += `<div class="d-flex justify-content-between small border-bottom border-dark py-2"><span>${name}</span><span class="fw-bold ${stColor}">${stText}</span></div>`;
                });
            } else { list.innerHTML = '<span class="text-muted small">HenÃ¼z iÅŸlem yapÄ±lmamÄ±ÅŸ.</span>'; }
            new bootstrap.Modal(document.getElementById('modal-task-detail')).show();
        };

        window.setStars = (n) => { 
            const current = parseInt(document.getElementById('t-stars').value || 0);
            const newVal = (current === n) ? 0 : n; 
            document.getElementById('t-stars').value = newVal; 
            const stars = document.getElementById('star-select').getElementsByTagName('i'); 
            for(let i=0; i<5; i++) stars[i].className = i < newVal ? 'fas fa-star clickable' : 'far fa-star clickable'; 
        };

        window.saveTask = async () => {
            try {
                const editId = document.getElementById('t-id').value;
                const title = document.getElementById('t-title').value;
                const desc = document.getElementById('t-desc').value;
                const type = document.getElementById('t-type').value;
                const imp = parseInt(document.getElementById('t-stars').value);
                const deadline = document.getElementById('t-deadline').value;
                
                let to = "Herkes", uid = null;
                if(type === 'department') to = document.getElementById('t-dept').value;
                if(type === 'user') { 
                    const el = document.getElementById('t-user'); 
                    to = el.options[el.selectedIndex].text; 
                    uid = el.value; 
                }
                
                const taskData = { title, description: desc, assignedType: type, assignedTo: to, assignedToUid: uid, importance: imp, deadline: deadline };

                if(editId) {
                    await updateDoc(doc(db, "tasks", editId), taskData);
                    showToast("GÃ¶rev gÃ¼ncellendi!");
                } else {
                    taskData.createdByUid = curUser.uid; taskData.creatorName = uData.name; taskData.creatorPhoto = uData.photoURL; taskData.createdAt = new Date(); taskData.statusMap = {};
                    if(type === 'user' && uid) { taskData.statusMap[uid] = 'pending'; }
                    const ref = await addDoc(collection(db,"tasks"), taskData);
                    const notifData = {text: `${uData.name} yeni bir gÃ¶rev ekledi: ${title}`, read:false, createdAt:new Date(), type:'task', linkId: ref.id};
                    if(type === 'all') { allUsersCache.forEach(u => { if(u.uid !== curUser.uid) addDoc(collection(db,"notifications"), {...notifData, to: u.uid}); }); } 
                    else if (type === 'department') { allUsersCache.forEach(u => { if(u.uid !== curUser.uid && u.departments.includes(to)) addDoc(collection(db,"notifications"), {...notifData, to: u.uid}); }); } 
                    else if (type === 'user' && uid) { addDoc(collection(db,"notifications"), {...notifData, to: uid}); }
                }
                bootstrap.Modal.getInstance(document.getElementById('modal-task')).hide(); 
                document.getElementById('form-task').reset();
                setStars(0);
            } catch(err) {
                showToast("Hata oluÅŸtu: " + err.message);
                console.error(err);
            }
        };

        window.openStatusModal = (tid) => { selectedTaskForStatus = tid; new bootstrap.Modal(document.getElementById('modal-status')).show(); };
        window.updateTaskStatus = async (status) => { if(!selectedTaskForStatus) return; await updateDoc(doc(db,"tasks",selectedTaskForStatus), { [`statusMap.${curUser.uid}`]: status }); bootstrap.Modal.getInstance(document.getElementById('modal-status')).hide(); };
        
        // --- FILTER TASKS ---
        window.filterTasks = (f, b) => { 
            document.querySelectorAll('#view-tasks .btn-outline-secondary').forEach(btn => btn.classList.remove('active')); 
            b.classList.add('active'); 
            // Burada renderTasksToPage Ã§aÄŸÄ±rmak yeterli, tekrar listener aÃ§maya gerek yok.
            renderTasksToPage();
        };
        
        window.delTask=(id)=>{ customConfirm("GÃ¶revi silmek istediÄŸine emin misin?", async () => await deleteDoc(doc(db,"tasks",id))); }

        function listenTeam() { 
            unsubTeam = onSnapshot(collection(db,"users"), s => { 
                allUsersCache = []; 
                s.forEach(d => { 
                    const u = d.data(); 
                    if(!u.isBanned) allUsersCache.push(u); 
                }); 
                renderTeam(); 
                // Ã–NEMLÄ° EKLEME: Ekip bilgisi (fotoÄŸraf vs.) gÃ¼ncellenince gÃ¶rev kartlarÄ±nÄ± da gÃ¼ncelle
                renderTasksToPage();
            }); 
        }
        
        window.renderTeam = (filter='') => {
            const list = document.getElementById('team-list'); list.innerHTML = ''; const f = filter.toLowerCase();
            const groups = {}; DEPTS.forEach(d => groups[d] = []); groups["DiÄŸer"] = [];
            
            allUsersCache.forEach(u => {
                if(u.roles && u.roles.includes('Admin')) return;

                const searchStr = (u.name + ' ' + (u.roles||[]).join(' ') + ' ' + (u.departments||[]).map(d=>DEPT_ABBR[d]||d).join(' ')).toLowerCase();
                if(f && !searchStr.includes(f)) return;
                let placed = false;
                u.departments?.forEach(d => { if(DEPTS.includes(d)) { groups[d].push(u); placed=true; } });
                if(!placed) groups["DiÄŸer"].push(u);
            });

            for (const [deptName, users] of Object.entries(groups)) {
                if (users.length === 0) continue;
                const uniqueUsers = [...new Set(users)]; 

                list.innerHTML += `<div class="dept-header"><i class="fas fa-briefcase"></i> ${deptName}</div>`;
                const container = document.createElement('div'); container.className = 'dept-group';
                
                uniqueUsers.forEach(u => {
                    let badges = '';
                    u.roles?.forEach(r => badges += `<span class="role-badge border">${r}</span>`);
                    u.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); badges += `<span class="role-badge bg-dark border border-secondary text-muted">${abbr}</span>`; });
                    const canDelete = (canManageUsers() && u.uid !== curUser.uid);
                    container.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between p-2 mb-1 clickable" style="border-bottom:1px solid rgba(255,255,255,0.05)" onclick="openUserProfile('${u.uid}'); pushState()">
                        <div class="d-flex align-items-center gap-3"><img src="${u.photoURL}" class="rounded-circle" width="40" height="40"><div><div class="fw-bold" style="font-size:14px">${u.name}</div><div class="d-flex mt-1 gap-1">${badges}</div></div></div>
                        <div class="d-flex align-items-center gap-2">
                             ${canManageUsers() ? `<button class="btn btn-sm btn-dark text-warning border-secondary" onclick="event.stopPropagation();openUserEdit('${u.uid}'); pushState()"><i class="fas fa-edit"></i></button>` : ''}
                             <button class="btn btn-sm btn-outline-secondary rounded-3 py-1 px-2 text-white" onclick="event.stopPropagation();openChat('${[curUser.uid,u.uid].sort().join('_')}','${u.name}'); pushState()"><i class="far fa-paper-plane"></i></button>
                             ${canDelete ? `<button class="btn btn-sm btn-danger py-1 px-2" onclick="event.stopPropagation();deleteUser('${u.uid}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                });
                list.appendChild(container);
            }
        };

        window.openUserProfile = (uid) => {
            const u = allUsersCache.find(x => x.uid === uid); if(!u) return;
            document.getElementById('vp-img').src = u.photoURL;
            document.getElementById('vp-name').innerText = u.name;
            const bdg = document.getElementById('vp-badges'); bdg.innerHTML = '';
            u.roles?.forEach(r => bdg.innerHTML += `<span class="badge bg-secondary small">${r}</span>`);
            u.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); bdg.innerHTML += `<span class="badge bg-dark border border-secondary text-muted">${abbr}</span>`; });
            
            document.getElementById('vp-uni').innerText = u.university || 'BelirtilmemiÅŸ';
            document.getElementById('vp-dept').innerText = u.uni_dept || 'BelirtilmemiÅŸ';
            
            const dobRaw = u.dob || '';
            const dobFormatted = dobRaw ? dobRaw.split('-').reverse().join('.') : 'BelirtilmemiÅŸ';
            document.getElementById('vp-dob').innerText = dobFormatted;
            
            document.getElementById('vp-address').innerText = (u.city && u.district) ? `${u.city} / ${u.district}` : 'Adres GirilmemiÅŸ';
            document.getElementById('vp-phone').innerText = u.phone || 'BelirtilmemiÅŸ';
            document.getElementById('vp-email').innerText = u.contactEmail || u.email || 'BelirtilmemiÅŸ';

            let total = 0, done = 0;
            Object.values(allTasksCache).forEach(t => { if(t.statusMap && t.statusMap[uid]) { total++; if(t.statusMap[uid] === 'done') done++; } });
            const rate = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('vp-rate').innerText = `%${rate}`;
            document.getElementById('vp-circle').style.strokeDashoffset = (163.36 * (100 - rate)) / 100;
            const socBox = document.getElementById('vp-socials'); socBox.innerHTML = '';
            if(u.socials) {
                if(u.socials.linkedin) socBox.innerHTML += `<a href="https://linkedin.com/in/${u.socials.linkedin}" target="_blank" class="text-secondary"><i class="fab fa-linkedin"></i></a>`;
                if(u.socials.instagram) socBox.innerHTML += `<a href="https://instagram.com/${u.socials.instagram}" target="_blank" class="text-secondary"><i class="fab fa-instagram"></i></a>`;
                if(u.socials.x) socBox.innerHTML += `<a href="https://x.com/${u.socials.x}" target="_blank" class="text-secondary"><i class="fab fa-twitter"></i></a>`;
                if(u.socials.tiktok) socBox.innerHTML += `<a href="https://tiktok.com/@${u.socials.tiktok}" target="_blank" class="text-secondary"><i class="fab fa-tiktok"></i></a>`;
                if(u.socials.youtube) socBox.innerHTML += `<a href="https://youtube.com/@${u.socials.youtube}" target="_blank" class="text-secondary"><i class="fab fa-youtube"></i></a>`;
                if(u.socials.kick) socBox.innerHTML += `<a href="https://kick.com/${u.socials.kick}" target="_blank" class="text-secondary"><i class="fab fa-kickstarter"></i></a>`;
            } else { socBox.innerHTML = '<small class="text-muted">Sosyal medya yok.</small>'; }
            new bootstrap.Modal(document.getElementById('modal-profile-view')).show();
        };

        window.deleteUser = async (uid) => { customConfirm("KullanÄ±cÄ±yÄ± engellemek istiyor musun?", async () => await updateDoc(doc(db,"users",uid), { isBanned: true })); };

        window.openUserEdit = (uid) => {
            if(!canManageUsers()) return; selectedUserForEdit = uid; const u = allUsersCache.find(x => x.uid === uid);
            document.getElementById('ue-name').innerText = u.name;
            const rd = document.getElementById('ue-roles'); rd.innerHTML = ''; ROLES.forEach(r => { rd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${r}" ${u.roles?.includes(r)?'checked':''}><label class="form-check-label">${r}</label></div>`; });
            const dd = document.getElementById('ue-depts'); dd.innerHTML = ''; DEPTS.forEach(d => { dd.innerHTML += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${d}" ${u.departments?.includes(d)?'checked':''}><label class="form-check-label">${d}</label></div>`; });
            new bootstrap.Modal(document.getElementById('modal-user-edit')).show();
        };
        window.saveUserEdit = async () => { const roles = Array.from(document.querySelectorAll('#ue-roles input:checked')).map(c=>c.value); const depts = Array.from(document.querySelectorAll('#ue-depts input:checked')).map(c=>c.value); await updateDoc(doc(db,"users",selectedUserForEdit), { roles, departments: depts }); bootstrap.Modal.getInstance(document.getElementById('modal-user-edit')).hide(); };

        function loadChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = `<div class="card-custom p-3 d-flex align-items-center mb-0 border border-secondary" onclick="openChat('Sohbet','Genel Sohbet'); pushState()"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-hashtag"></i></div><div class="fw-bold">Sohbet</div></div>`;
            list.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-secondary" onclick="openChat('Business','Business'); pushState()"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-briefcase"></i></div><div class="fw-bold">Business</div></div>`;
            if(isBoard()) list.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-2 border border-warning" onclick="openChat('Yonetim','YÃ¶netim Kurulu'); pushState()"><div class="bg-warning rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-crown text-black"></i></div><div class="fw-bold text-warning">YÃ¶netim Kurulu</div></div>`;
            
            // SPECIAL SORTING FOR BOARD (YK) - OWN DEPARTMENT FIRST
            let sortedDepts = [...(canSeeAllChannels() ? DEPTS : (uData.departments || []))];
            
            if (isBoard() && uData.departments && uData.departments.length > 0) {
                const myDept = uData.departments[0];
                sortedDepts = sortedDepts.filter(d => d !== myDept);
                sortedDepts.unshift(myDept); // Move to top
            }

            sortedDepts.forEach(d => { 
                const isMyDept = uData.departments?.includes(d) && isBoard();
                const style = isMyDept ? 'border: 1px solid #60a5fa !important; background: rgba(59, 130, 246, 0.1);' : 'border: 1px solid #0dcaf0;';
                
                list.innerHTML += `<div class="card-custom p-3 d-flex align-items-center mb-0 mt-2" style="${style}" onclick="openChat('${d}','${d}'); pushState()"><div class="bg-dark rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="fas fa-users text-info"></i></div><div class="fw-bold">${d}</div></div>`; 
            });
        }

        window.openChat = (cid, title) => {
            activeChatId = cid; chatOpen = true; document.getElementById('chat-overlay-title').innerText = title;
            const body = document.getElementById('chat-overlay-body'); body.innerHTML = '';
            document.getElementById('chat-overlay').classList.add('open');
            if(unsubChat) unsubChat();
            unsubChat = onSnapshot(query(collection(db,"messages"), where("channel","==",cid)), s => {
                let msgs = []; s.forEach(d => { const m = d.data(); if(!m.deletedFor || !m.deletedFor.includes(curUser.uid)) msgs.push({id:d.id, ...m}); });
                msgs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                let html = '';
                msgs.forEach(m => {
                    const me = m.senderId === curUser.uid;
                    let content = linkify(m.text || ''); if(m.type === 'image') content = `<img src="${m.url}" class="chat-img" onclick="openImgViewer('${m.url}')">`;
                    
                    let badgeHtml = '', senderPhoto = 'https://ui-avatars.com/api/?name=User';
                    const sender = allUsersCache.find(u => u.uid === m.senderId);
                    if(sender) {
                        senderPhoto = sender.photoURL;
                        sender.roles?.forEach(r => badgeHtml += `<span class="chat-badge cb-role">${r}</span>`);
                        sender.departments?.forEach(d => { const abbr = DEPT_ABBR[d] || d.substring(0,3); badgeHtml += `<span class="chat-badge cb-dept">${abbr}</span>`; });
                    }

                    let reactHtml = '';
                    if(m.reactions) {
                        const counts = {};
                        Object.values(m.reactions).forEach(r => { counts[r.emoji] = (counts[r.emoji] || 0) + 1; });
                        Object.entries(counts).forEach(([em, count]) => {
                            reactHtml += `<div class="reaction-pill" onclick="openReactionDetails('${m.id}'); pushState()">${em} <span style="opacity:0.7">${count}</span></div>`;
                        });
                    }

                    const safeM = JSON.stringify({id:m.id, senderId:m.senderId, text:m.text, reactions: m.reactions}).replace(/"/g, '&quot;');
                    const nameColor = me ? '#fff' : getUserColor(m.senderId);

                    html += `
                    <div class="chat-row ${me?'right':'left'}">
                        ${!me ? `<img src="${senderPhoto}" class="chat-avatar-img">` : ''}
                        <div class="msg-bubble ${me?'bubble-sent':'bubble-received'}"
                             oncontextmenu="handleMsgCtx(event, ${safeM}); return false;"
                             ontouchstart="startLongPress(event, ${safeM})" 
                             ontouchend="cancelLongPress()" 
                             ontouchmove="cancelLongPress()">
                            ${!me ? `<div class="sender-header"><span class="sender-name" style="color:${nameColor}">${m.senderName}</span>${badgeHtml}</div>` : ''}
                            <div style="margin-top:2px;">${content}</div>
                            <div class="chat-meta">
                                ${m.isEdited ? '<span class="edited-label">dÃ¼zenlendi</span>' : ''}
                                ${m.createdAt?.seconds ? new Date(m.createdAt.seconds*1000).getHours() + ':' + String(new Date(m.createdAt.seconds*1000).getMinutes()).padStart(2,'0') : ''}
                            </div>
                        </div>
                    </div>
                    ${reactHtml ? `<div class="reaction-container ${me?'justify-content-end':'justify-content-start'}" style="margin-left:${!me?'45px':0}; margin-right:${me?'10px':0};">${reactHtml}</div>` : ''}`;
                });
                body.innerHTML = html; body.scrollTop = body.scrollHeight;
                allTasksCache['msgs'] = msgs; 
            });
        };
        window.closeChat = () => { document.getElementById('chat-overlay').classList.remove('open'); chatOpen = false; if(unsubChat) unsubChat(); activeChatId = null; };

        // --- REACTIONS & CONTEXT ---
        const ctx = document.getElementById('context-menu');
        window.startLongPress = (e, msg) => { longPressTimer = setTimeout(() => handleMsgCtx(e.touches[0], msg), 800); };
        window.cancelLongPress = () => { if(longPressTimer) clearTimeout(longPressTimer); };

        window.handleMsgCtx = (e, msg) => {
            if(window.navigator.vibrate) window.navigator.vibrate(50);
            selectedMsg = msg; let html = ''; const isMine = msg.senderId === curUser.uid;
            if(isMine) html += `<div class="ctx-item" onclick="editMsg()"><i class="fas fa-pen"></i> DÃ¼zenle</div>`;
            if(isMine || isAdmin()) html += `<div class="ctx-item delete" onclick="deleteMsg('all')"><i class="fas fa-trash"></i> Herkes iÃ§in Sil</div>`;
            html += `<div class="ctx-item delete" onclick="deleteMsg('me')"><i class="fas fa-trash-alt"></i> Benden Sil</div>`;
            document.getElementById('ctx-options').innerHTML = html;
            
            ctx.style.display='flex';
            const menuWidth = ctx.offsetWidth;
            const menuHeight = ctx.offsetHeight;
            const winW = window.innerWidth;
            const winH = window.innerHeight;

            let x = e.clientX;
            let y = e.clientY;

            if (x + menuWidth > winW) {
                x = winW - menuWidth - 10;
            }
            if (y + menuHeight > winH) {
                y = e.clientY - menuHeight;
            }

            ctx.style.top = y + 'px'; 
            ctx.style.left = x + 'px';
        };
        document.addEventListener('click', (e)=>{if(!ctx.contains(e.target))ctx.style.display='none';});
        window.addReaction = async (emoji) => { ctx.style.display='none'; if(!selectedMsg)return; const c=selectedMsg.reactions||{}; if(c[curUser.uid]&&c[curUser.uid].emoji===emoji)await updateDoc(doc(db,"messages",selectedMsg.id),{[`reactions.${curUser.uid}`]:deleteField()}); else await updateDoc(doc(db,"messages",selectedMsg.id),{[`reactions.${curUser.uid}`]:{emoji,name:uData.name,uid:curUser.uid}}); };
        window.openReactionDetails = (mid) => { const m = allTasksCache['msgs']?.find(x=>x.id===mid); if(!m?.reactions)return; const l=document.getElementById('reaction-list'); l.innerHTML=''; Object.values(m.reactions).forEach(r=>{ const u=allUsersCache.find(x=>x.uid===r.uid); l.innerHTML+=`<div class="d-flex align-items-center justify-content-between border-bottom border-dark py-2"><div class="d-flex align-items-center gap-2"><img src="${u?.photoURL}" class="rounded-circle" width="25"><span>${r.name}</span></div><span class="fs-5">${r.emoji}</span></div>`; }); new bootstrap.Modal(document.getElementById('modal-reactions')).show(); };
        window.deleteMsg = async (t) => { ctx.style.display='none'; if(t==='all'){ customConfirm("Herkesden sil?",async()=>await deleteDoc(doc(db,"messages",selectedMsg.id))); } else { await updateDoc(doc(db,"messages",selectedMsg.id),{deletedFor:arrayUnion(curUser.uid)}); showToast("Silindi."); } };
        window.editMsg = () => { ctx.style.display='none'; document.getElementById('edit-msg-input').value=selectedMsg.text; new bootstrap.Modal(document.getElementById('modal-edit-msg')).show(); };
        window.submitEditMsg = async () => { await updateDoc(doc(db,"messages",selectedMsg.id),{text:document.getElementById('edit-msg-input').value,isEdited:true}); bootstrap.Modal.getInstance(document.getElementById('modal-edit-msg')).hide(); };
        document.getElementById('chat-file-inp').addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.readAsDataURL(f); r.onload=(ev)=>{ const i=new Image(); i.src=ev.target.result; i.onload=async()=>{ const c=document.createElement('canvas'); const x=c.getContext('2d'); let w=i.width,h=i.height,m=800; if(w>h){if(w>m){h*=m/w;w=m;}}else{if(h>m){w*=m/h;h=m;}} c.width=w; c.height=h; x.drawImage(i,0,0,w,h); await addDoc(collection(db,"messages"),{type:'image',url:c.toDataURL('image/jpeg',0.6),channel:activeChatId,senderId:curUser.uid,senderName:uData.name,createdAt:new Date()}); } } });
        
        window.switchLB = (mode, el) => {
            lbMode = mode;
            document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            openLeaderboard(true);
        };

        window.openLeaderboard = (refresh = false) => {
            const list = document.getElementById('lb-list'); list.innerHTML = '';
            const scores = [];
            const { start, end } = getWeekRange();

            allUsersCache.forEach(u => {
                if(!isAdmin() && !u.departments.some(d => uData.departments.includes(d))) return;

                let total = 0, done = 0;
                Object.values(allTasksCache).forEach(t => {
                    if(lbMode === 'haftalik') {
                        const tDate = t.createdAt.toDate();
                        if(tDate < start || tDate > end) return;
                    }

                    if(t.statusMap && t.statusMap[u.uid]) { 
                        total++; 
                        if(t.statusMap[u.uid] === 'done') done++; 
                    } 
                });
                
                if(total > 0 || isAdmin()) {
                    scores.push({ ...u, rate: total===0?0:(done/total)*100, done, total });
                }
            });
            scores.sort((a,b) => b.rate - a.rate);
            
            if(scores.length === 0) list.innerHTML = '<div class="text-center text-muted mt-3">Veri yok.</div>';

            scores.forEach((s, idx) => {
                list.innerHTML += `<div class="d-flex align-items-center justify-content-between p-2 border-bottom border-secondary"><div class="d-flex align-items-center gap-3"><div class="fw-bold" style="width:20px;">${idx+1}</div><img src="${s.photoURL}" class="rounded-circle" width="35"><div><div class="fw-bold small">${s.name}</div><div class="text-muted" style="font-size:10px">${s.done}/${s.total} GÃ¶rev</div></div></div><div class="fw-bold text-success">%${Math.round(s.rate)}</div></div>`;
            });
            
            if(!refresh) new bootstrap.Modal(document.getElementById('modal-leaderboard')).show(); pushState();
        };

        window.goTab = (t,b) => { 
            const titles = {'tasks':'GÃ¶rev Panosu','messages':'Sohbetler','team':'Ekip Listesi','profile':'Profilim'};
            document.getElementById('page-title').innerText = titles[t];
            document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.add('active'); 
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); 
        };
        document.getElementById('chat-form').addEventListener('submit',async e=>{e.preventDefault(); const t=document.getElementById('chat-input').value.trim(); if(!t)return; await addDoc(collection(db,"messages"),{text:t, type:'text', channel:activeChatId,senderId:curUser.uid,senderName:uData.name,createdAt:new Date()}); document.getElementById('chat-input').value=''; });
        
        function listenNotifs(){ unsubNotif = onSnapshot(query(collection(db,"notifications"),where("to","==",curUser.uid),where("read","==",false)), s=>{ document.getElementById('notif-dot').style.display=s.empty?'none':'block'; }); }
        
        window.handleNotifClick = async (type, linkId) => {
            bootstrap.Modal.getInstance(document.getElementById('modal-notif')).hide();
            
            if(type === 'task' && linkId) {
                if(!allTasksCache[linkId]) {
                    try {
                        const snap = await getDoc(doc(db,"tasks",linkId));
                        if(snap.exists()) {
                            allTasksCache[linkId] = {id: snap.id, ...snap.data()};
                            openTaskDetail(linkId);
                        } else { showToast("GÃ¶rev bulunamadÄ±."); }
                    } catch(e) { console.error(e); }
                } else { openTaskDetail(linkId); }
                pushState();
            } else if(type === 'chat' && linkId) {
                const u = allUsersCache.find(x => x.uid === linkId);
                if(u) { openChat([curUser.uid, linkId].sort().join('_'), u.name); pushState(); }
            }
        };

        window.openNotifs=async()=>{ 
            const m=new bootstrap.Modal(document.getElementById('modal-notif')); m.show(); pushState(); const l=document.getElementById('notif-list'); l.innerHTML='...'; 
            const q = query(collection(db,"notifications"), where("to","==",curUser.uid)); const s=await getDocs(q); const n=[]; s.forEach(d=>n.push({id:d.id,...d.data()})); n.sort((a,b)=>b.createdAt-a.createdAt); 
            l.innerHTML=''; if(n.length===0)l.innerHTML='<div class="text-center p-3 text-muted">Yok.</div>'; 
            n.forEach(d=>{ 
                l.innerHTML+=`<div class="p-3 border-bottom border-secondary clickable" onclick="handleNotifClick('${d.type}', '${d.linkId}')"><small class="fw-bold">${d.text}</small></div>`; 
                updateDoc(doc(db,"notifications",d.id),{read:true}); 
            }); 
            document.getElementById('notif-dot').style.display='none'; 
        };
        
        async function loadRecentDMs(){ 
            if(unsubDMs)unsubDMs(); 
            unsubDMs=onSnapshot(collection(db,"messages"),s=>{ 
                const pairs = new Map(); 
                s.forEach(d=>{ 
                    const m = d.data();
                    const c=m.channel; 
                    if(c&&c.includes('_')&&c.includes(curUser.uid)) {
                        const other = c.split('_').find(x=>x!==curUser.uid);
                        const time = m.createdAt?.seconds || 0;
                        if(!pairs.has(other) || time > pairs.get(other)) {
                            pairs.set(other, time);
                        }
                    }
                }); 
                
                const sortedPairs = Array.from(pairs.entries()).sort((a,b) => b[1] - a[1]);
                
                const l=document.getElementById('dm-list');
                l.innerHTML=''; 
                sortedPairs.forEach(([id, time])=>{ 
                    const u=allUsersCache.find(x=>x.uid===id); 
                    if(u)l.innerHTML+=`<div class="card-custom p-3 d-flex align-items-center mb-0 mt-1 gap-3" onclick="openChat('${[curUser.uid,id].sort().join('_')}','${u.name}');pushState()"><img src="${u.photoURL}" class="rounded-circle" width="40"><div><div class="fw-bold">${u.name}</div></div></div>`; 
                }); 
            }); 
        }
        
        window.logout=()=>signOut(auth);
        document.getElementById('form-register').addEventListener('submit',async e=>{ e.preventDefault(); const n=document.getElementById('r-name').value, em=document.getElementById('r-email').value, ps=document.getElementById('r-pass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,ps); const p=`https://ui-avatars.com/api/?name=${n}&background=random&color=fff`; await setDoc(doc(db,"users",c.user.uid),{ uid:c.user.uid, name:n, email:em, photoURL:p, createdAt:new Date(), isBanned:false, roles: ['Ãœye'], departments: ['...'] }); await updateProfile(c.user,{displayName:n,photoURL:p}); } catch(err){ showToast(err.message) } });
        document.getElementById('form-login').addEventListener('submit',async e=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth,document.getElementById('l-email').value,document.getElementById('l-pass').value) } catch(err){ showToast("Hata: " + err.message); } });
        window.uploadPhoto=(i)=>{const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{const im=new Image();im.src=e.target.result;im.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=150/Math.max(im.width,im.height);c.width=im.width*s;c.height=im.height*s;x.drawImage(im,0,0,c.width,c.height);const b=c.toDataURL('image/jpeg',0.7);updateDoc(doc(db,"users",curUser.uid),{photoURL:b}).then(()=>{uData.photoURL=b;loadProfile()})}};r.readAsDataURL(f);}
        window.closeImgViewer=()=>{document.getElementById('img-viewer').style.display='none';};
        window.openImgViewer=(src)=>{document.getElementById('img-viewer-src').src=src;document.getElementById('img-viewer').style.display='flex';};
    </script>
</body>
</html>
